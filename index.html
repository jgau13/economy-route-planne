<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Sign Supply Route Planner</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Funci√≥n global para inyectar la configuraci√≥n desde fuera o usarla si se pega aqu√≠
        window.initializeFirebaseGlobally = (config) => {
            try {
                if (!config || !config.apiKey || config.apiKey.includes("Pega_aqu√≠")) {
                    console.warn("‚ö†Ô∏è Esperando configuraci√≥n de Firebase v√°lida...");
                    return false; 
                }
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                window.fbSendPasswordResetEmail = sendPasswordResetEmail;
                window.fbUpdatePassword = updatePassword;
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbSetDoc = setDoc; 
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                window.fbGetDocs = getDocs;
                window.fbLimit = limit;
                
                window.firebaseReady = true; 
                return true;
            } catch (e) {
                console.error("‚ùå Firebase Initialization Error:", e);
                window.firebaseInitError = e.message;
                return false;
            }
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ess: { blue: '#1b6e9b', green: '#6bbf5d', dark: '#0f4c6e', light: '#f0f9ff' } } }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* GOOGLE MAPS AUTOCOMPLETE FIXES */
        .pac-container { 
            z-index: 99999 !important; 
            border-radius: 8px; 
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border: 1px solid #e2e8f0; 
            font-family: 'Inter', sans-serif;
            max-width: 90vw !important; 
            white-space: normal !important;
        }
        .pac-item { 
            padding: 10px 12px; 
            cursor: pointer; 
            font-size: 14px; 
            white-space: normal !important; 
        }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        
        .draggable-source { opacity: 0.4; border: 2px dashed #cbd5e1; background: #f1f5f9; }
        .drop-target { background-color: #eff6ff; border: 2px dashed #1b6e9b; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-checkbox { width: 20px; height: 20px; accent-color: #1b6e9b; cursor: pointer; }

        /* PRINT STYLES - FIXED TO PORTRAIT */
        @media print {
            @page { size: portrait; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-sheet, #printable-sheet *, #global-manifest, #global-manifest * { visibility: visible; }
            #printable-sheet, #global-manifest { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- PALETA DE COLORES CORPORATIVA UNIFICADA ---
        const COMPANY_PALETTE = [
            { hex: "#1b6e9b", tw: "bg-ess-blue text-white" },      // 0: Azul Principal
            { hex: "#6bbf5d", tw: "bg-ess-green text-white" },     // 1: Verde Principal
            { hex: "#0f4c6e", tw: "bg-ess-dark text-white" },      // 2: Azul Oscuro
            { hex: "#0284c7", tw: "bg-sky-600 text-white" },       // 3: Azul Cielo
            { hex: "#0d9488", tw: "bg-teal-600 text-white" },      // 4: Verde Azulado
            { hex: "#1e40af", tw: "bg-blue-800 text-white" },      // 5: Azul Marino
            { hex: "#059669", tw: "bg-emerald-600 text-white" },   // 6: Esmeralda
            { hex: "#0e7490", tw: "bg-cyan-700 text-white" }       // 7: Cian
        ];

        // ... [ERROR SCREEN & LOGIN SCREEN] ...
        const ConfigErrorScreen = ({ errorDetails }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border-l-4 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="h-8 w-8" /> System Error</h1>
                    <p className="text-slate-600 mb-4 font-bold">Connection failed.</p>
                    <div className="bg-red-50 p-4 rounded-lg border border-red-200 text-sm font-mono text-red-800 mb-4 break-words">Error: {errorDetails || "Unknown Configuration Error"}</div>
                    <button onClick={() => window.location.reload()} className="mt-6 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors">Retry Connection</button>
                </div>
            </div>
        );

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [msg, setMsg] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError(''); setMsg('');
                if (!window.fbSignIn) { setError("System not ready. Please refresh."); setLoading(false); return; }
                try { await window.fbSignIn(window.fbAuth, email, password); } 
                catch (err) { console.error(err); setError("Access Denied. Check credentials."); setLoading(false); }
            };

            const handleForgotPassword = async () => {
                if(!email) { setError("Please enter your email first."); return; }
                try {
                    await window.fbSendPasswordResetEmail(window.fbAuth, email);
                    setMsg("Password reset email sent! Check your inbox.");
                    setError('');
                } catch (e) { setError("Error sending email: " + e.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-16 mx-auto mb-4"/>
                            <h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Email</label><input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Password</label><input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium">{error}</div>}
                            {msg && <div className="p-3 bg-green-50 text-green-600 text-sm rounded-lg font-medium">{msg}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold hover:bg-sky-700 transition-colors flex justify-center">{loading ? <div className="loader"></div> : "Sign In"}</button>
                            <div className="text-center">
                                <button type="button" onClick={handleForgotPassword} className="text-sm text-slate-500 hover:text-ess-blue underline">Forgot your password?</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                if (iconData) { const el = lucide.createElement(iconData); el.setAttribute('class', className); setSvgHtml(el.outerHTML); }
            }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded, onKeyDown, inputRef: propInputRef }) => {
            const innerRef = useRef(null);
            const inputRef = propInputRef || innerRef;
            const onChangeRef = useRef(onChange);
            const lastSelectionTimeRef = useRef(0);
            const usedArrowsRef = useRef(false);

            useEffect(() => { onChangeRef.current = onChange; }, [onChange]);

            useEffect(() => {
                if (!isLoaded) return;
                const attemptInitialization = () => {
                    if (!window.google || !window.google.maps || !window.google.maps.places) { setTimeout(attemptInitialization, 300); return; }
                    if (!inputRef.current) return;
                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, { types: ['geocode', 'establishment'], componentRestrictions: { country: "us" }, fields: ['formatted_address', 'name', 'geometry'] });
                        autocomplete.addListener("place_changed", () => { 
                            lastSelectionTimeRef.current = Date.now(); 
                            const place = autocomplete.getPlace(); 
                            const address = place.formatted_address || place.name;
                            if (address) { onChangeRef.current({ target: { value: address } }); }
                        });
                    } catch (e) { setTimeout(attemptInitialization, 500); }
                };
                attemptInitialization();
            }, [isLoaded]);
            
            const handleInputKeyDown = (e) => { 
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { usedArrowsRef.current = true; return; }
                if (e.key === 'Enter') {
                    const timeSinceSelection = Date.now() - lastSelectionTimeRef.current;
                    if (usedArrowsRef.current || timeSinceSelection < 500) {
                        e.preventDefault(); e.stopPropagation(); usedArrowsRef.current = false; return;
                    }
                } else { usedArrowsRef.current = false; }
                if (onKeyDown) onKeyDown(e); 
            };

            return <input ref={inputRef} type="text" value={value} onChange={onChange} onKeyDown={handleInputKeyDown} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        const GlobalMapView = ({ routes, baseAddress }) => {
            const mapRef = useRef(null);
            const googleMapRef = useRef(null);
            const markersRef = useRef([]); 
            const renderersRef = useRef([]); 
            const infoWindowRef = useRef(null); 
            const geocoderRef = useRef(null);
            const ROUTE_HEX_COLORS = COMPANY_PALETTE.map(c => c.hex);
            
            useEffect(() => {
                if (!window.google || !mapRef.current) return;

                if (!googleMapRef.current) {
                    googleMapRef.current = new window.google.maps.Map(mapRef.current, { 
                        zoom: 10, center: { lat: 28.5383, lng: -81.3792 }, 
                        mapTypeControl: false, streetViewControl: false,
                        fullscreenControl: false, gestureHandling: 'greedy'
                    });
                    infoWindowRef.current = new window.google.maps.InfoWindow();
                    geocoderRef.current = new window.google.maps.Geocoder();
                }
                const map = googleMapRef.current;
                const directionsService = new window.google.maps.DirectionsService();
                const bounds = new window.google.maps.LatLngBounds();

                markersRef.current.forEach(m => m.setMap(null));
                markersRef.current = [];
                renderersRef.current.forEach(r => r.setMap(null));
                renderersRef.current = [];

                const getPinIcon = (color) => {
                    return {
                        path: "M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z",
                        fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1,
                        labelOrigin: new window.google.maps.Point(0, -30)
                    };
                };

                const addMarker = (location, title, label, color, content) => {
                    const marker = new window.google.maps.Marker({
                        position: location, map: map,
                        label: { text: label, color: "white", fontWeight: "bold", fontSize: "12px" },
                        icon: getPinIcon(color), title: title,
                        zIndex: 100
                    });
                    marker.addListener("click", () => { infoWindowRef.current.setContent(content); infoWindowRef.current.open(map, marker); });
                    markersRef.current.push(marker);
                    bounds.extend(location);
                    map.fitBounds(bounds);
                };

                const renderFallbackMarkers = (stops, color, groupName) => {
                    stops.forEach((stop, i) => {
                        setTimeout(() => {
                            geocoderRef.current.geocode({ address: stop.direccion }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    const loc = results[0].geometry.location;
                                    const contentString = `<div style="padding: 4px; font-family: sans-serif;"><strong style="color:${color}">${groupName}</strong><br/><b>${stop.nombre}</b><br/><span style="font-size:11px">${stop.direccion}</span></div>`;
                                    addMarker(loc, stop.nombre, (stop.originalIndex || i + 1).toString(), color, contentString);
                                }
                            });
                        }, i * 300);
                    });
                };

                if (baseAddress) {
                     geocoderRef.current.geocode({ address: baseAddress }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const baseLoc = results[0].geometry.location;
                            const baseMarker = new window.google.maps.Marker({
                                position: baseLoc, map: map,
                                icon: { path: window.google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#1e293b", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" },
                                title: "Warehouse", zIndex: 999
                            });
                            baseMarker.addListener("click", () => {
                                infoWindowRef.current.setContent(`<div style="padding:4px;"><h3 style="font-weight:bold;">üè≠ Warehouse</h3><p style="font-size:12px;">${baseAddress}</p></div>`);
                                infoWindowRef.current.open(map, baseMarker);
                            });
                            markersRef.current.push(baseMarker);
                            bounds.extend(baseLoc);
                            map.fitBounds(bounds);
                        }
                     });
                }

                Object.entries(routes).forEach(([groupName, routeData], index) => {
                    if (routeData.paradas.length === 0) return;
                    
                    let color = ROUTE_HEX_COLORS[index % ROUTE_HEX_COLORS.length];
                    if (groupName.startsWith('Ungrouped') || groupName === 'Sin Asignar') color = '#94a3b8';

                    const waypoints = routeData.paradas.map(stop => ({ location: stop.direccion, stopover: true }));
                    
                    if (waypoints.length <= 25) {
                        directionsService.route({ 
                            origin: baseAddress, destination: baseAddress, waypoints: waypoints, 
                            optimizeWaypoints: false, travelMode: window.google.maps.TravelMode.DRIVING 
                        }, (response, status) => {
                            if (status === 'OK') {
                                const renderer = new window.google.maps.DirectionsRenderer({ 
                                    map: map, directions: response, 
                                    polylineOptions: { strokeColor: color, strokeOpacity: 0.6, strokeWeight: 4 }, 
                                    suppressMarkers: true, preserveViewport: true 
                                });
                                renderersRef.current.push(renderer);
                                bounds.union(response.routes[0].bounds);
                                map.fitBounds(bounds);
                                
                                const legs = response.routes[0].legs;
                                routeData.paradas.forEach((stop, i) => {
                                    if (i < legs.length) {
                                        const contentString = `<div style="padding: 4px; font-family: sans-serif;"><strong style="color:${color}">${groupName}</strong><br/><b>${stop.nombre}</b><br/><span style="font-size:11px">${stop.direccion}</span></div>`;
                                        addMarker(legs[i].end_location, stop.nombre, (stop.originalIndex || i + 1).toString(), color, contentString);
                                    }
                                });
                            } else {
                                console.warn("Routing failed, falling back to geocoding markers:", status);
                                renderFallbackMarkers(routeData.paradas, color, groupName);
                            }
                        });
                    } else {
                        renderFallbackMarkers(routeData.paradas, color, groupName);
                    }
                });
            }, [routes, baseAddress]);
            
            return (
                <div className="w-full h-full flex flex-col">
                    <div className="flex-1 min-h-[400px]"><div ref={mapRef} className="w-full h-full rounded-xl"></div></div>
                </div>
            );
        };

        const PrintableSheet = ({ routeData, driverName, vehicle, config }) => {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US');
            const timeStr = today.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            return (
                <div id="printable-sheet" className="hidden print:block bg-white text-black p-4 font-sans text-sm">
                    <div className="flex justify-between items-start mb-6 border-b-2 border-black pb-4">
                        <div className="flex items-center gap-4">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto" />
                            <div>
                                <h1 className="text-xl font-bold uppercase tracking-wide">Route Manifest</h1>
                                <p className="font-bold text-md">{dateStr}</p>
                            </div>
                        </div>
                        <div className="text-right space-y-1">
                            <div className="text-base"><span className="font-bold">Driver:</span> {driverName}</div>
                            <div className="text-base"><span className="font-bold">Truck:</span> {vehicle || "_______"}</div>
                            <div className="text-base"><span className="font-bold">Print Date:</span> {timeStr}</div>
                        </div>
                    </div>
                    <table className="w-full border-collapse border border-black mb-4">
                        <thead>
                            <tr className="bg-white">
                                <th className="border border-black p-1 w-8 text-center text-xs">#</th>
                                <th className="border border-black p-2 text-left w-auto">Customer / Address</th>
                                <th className="border border-black p-2 w-20 text-center text-xs">Invoices</th>
                                <th className="border border-black p-2 w-10 text-center text-xs">Pcs</th>
                                <th className="border border-black p-2 w-12 text-center text-xs">COD</th>
                                <th className="border border-black p-2 w-32 text-left text-xs">Signature</th>
                            </tr>
                        </thead>
                        <tbody>
                            {routeData.map((stop, index) => (
                                <tr key={index} className="h-14">
                                    <td className="border border-black p-1 text-center font-bold">{index + 1}</td>
                                    <td className="border border-black p-2 align-top">
                                        <div className="font-bold text-sm truncate">{stop.nombre}</div>
                                        <div className="text-[10px] text-gray-600 leading-tight">{stop.direccion}</div>
                                    </td>
                                    <td className="border border-black p-1 text-center font-mono font-bold text-sm align-middle break-words">{stop.invoices || '-'}</td>
                                    <td className="border border-black p-1 text-center font-bold text-sm align-middle">{stop.pieces || '-'}</td>
                                    <td className="border border-black p-1 text-center font-bold text-sm align-middle"></td>
                                    <td className="border border-black p-1"></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <div className="flex justify-between items-end mt-4 pt-4 border-t border-black">
                        <div className="space-y-4">
                            <div>Checked by: __________________________</div>
                            <div>Time: __________________________</div>
                        </div>
                        <div className="text-right text-[10px]">
                            <div className="font-bold text-xs">{config.companyName || "ECONOMY SIGN SUPPLY"}</div>
                            <div>PHONE: {config.phone || "407-901-0900"}</div>
                            <div>{config.address || "8350 PARKLINE BLVD, ORLANDO, FL 32809"}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalManifest = ({ routes, config }) => {
            const today = new Date().toLocaleDateString('en-US');
            return (
                <div id="global-manifest" className="hidden print:block bg-white text-black p-8 font-sans">
                    <div className="flex justify-between items-center mb-8 border-b-2 border-black pb-4">
                        <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto" />
                        <div className="text-right">
                            <h1 className="text-2xl font-bold uppercase">All Routes Summary</h1>
                            <p className="text-lg font-bold">{today}</p>
                        </div>
                    </div>
                    <div className="space-y-8">
                        {Object.entries(routes).map(([driver, data], idx) => (
                            <div key={idx} className="break-inside-avoid">
                                <div className="bg-gray-100 border border-black p-2 font-bold text-lg mb-2 flex justify-between">
                                    <span>{driver}</span>
                                    <span>{data.paradas.length} Stops</span>
                                </div>
                                <table className="w-full border-collapse border border-black text-xs">
                                    <thead>
                                        <tr>
                                            <th className="border border-black p-1 w-8">#</th>
                                            <th className="border border-black p-1 text-left">Customer / Address</th>
                                            <th className="border border-black p-1 w-20">Invoices</th>
                                            <th className="border border-black p-1 w-12">Pcs</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.paradas.map((stop, sIdx) => (
                                            <tr key={sIdx}>
                                                <td className="border border-black p-1 text-center">{sIdx + 1}</td>
                                                <td className="border border-black p-1">
                                                    <span className="font-bold">{stop.nombre}</span> - {stop.direccion}
                                                </td>
                                                <td className="border border-black p-1 text-center">{stop.invoices}</td>
                                                <td className="border border-black p-1 text-center">{stop.pieces}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [dbReady, setDbReady] = useState(false);
            const [systemError, setSystemError] = useState(null);

            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [googleApiKey, setGoogleApiKey] = useState(null);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            const [view, setView] = useState('input'); 
            
            const [baseAddress, setBaseAddress] = useState('8350 Parkline Blvd, Orlando, FL 32809, EE. UU.');
            const [dwellTime, setDwellTime] = useState(6);
            const [companyConfig, setCompanyConfig] = useState({
                companyName: "ECONOMY SIGN SUPPLY ORLANDO",
                phone: "407-901-0900",
                address: "8350 PARKLINE BLVD, ORLANDO, FLORIDA 32809"
            });
            const [savedPin, setSavedPin] = useState('0000'); 

            const [currentStops, setCurrentStops] = useState([]);
            const [optimizedStops, setOptimizedStops] = useState(null); 
            
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [newDriverName, setNewDriverName] = useState('');
            const [newVehicleName, setNewVehicleName] = useState(''); 
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAddressSuggestions, setShowAddressSuggestions] = useState(false); 
            const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(-1); 
            
            const [showAddDetailsModal, setShowAddDetailsModal] = useState(false); 
            const [tempStopData, setTempStopData] = useState(null);
            const [tempInvoices, setTempInvoices] = useState('');
            const [tempPieces, setTempPieces] = useState('');

            const [showAddRouteModal, setShowAddRouteModal] = useState(false);
            const [showManualStopModal, setShowManualStopModal] = useState(false);
            const [targetDriverForManual, setTargetDriverForManual] = useState(null);

            const [showPinModal, setShowPinModal] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [pendingView, setPendingView] = useState('');

            const [printData, setPrintData] = useState(null); 
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [showGlobalPrint, setShowGlobalPrint] = useState(false); 
            const [selectedVehicleForPrint, setSelectedVehicleForPrint] = useState('');

            const [settingsMsg, setSettingsMsg] = useState('');
            const [newPin, setNewPin] = useState('');

            const [routes, setRoutes] = useState(null);
            const [originalRoutes, setOriginalRoutes] = useState(null); 
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [recalculating, setRecalculating] = useState({});
            
            const [clientFormName, setClientFormName] = useState('');
            const [clientFormAddress, setClientFormAddress] = useState('');
            const [showClientDbAddressSuggestions, setShowClientDbAddressSuggestions] = useState(false); 
            const [editingClientId, setEditingClientId] = useState(null);
            const [selectedStops, setSelectedStops] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverDriver, setDragOverDriver] = useState(null);
            const [swappingDriver, setSwappingDriver] = useState(null);
            const [isRecalculatingAll, setIsRecalculatingAll] = useState(false);
            const [editingStop, setEditingStop] = useState(null);
            const [editingDraftId, setEditingDraftId] = useState(null);
            
            const [viewingDriver, setViewingDriver] = useState(null);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [historyData, setHistoryData] = useState([]);

            const [zones, setZones] = useState([]);
            const [zoneAssignments, setZoneAssignments] = useState({}); 
            const [newZoneName, setNewZoneName] = useState('');
            const [draggedDriver, setDraggedDriver] = useState(null); 
            const [selectedDriversForZone, setSelectedDriversForZone] = useState([]); 

            const [savedRoutes, setSavedRoutes] = useState([]);
            const [showSaveRouteModal, setShowSaveRouteModal] = useState(false);
            const [showLoadRouteModal, setShowLoadRouteModal] = useState(false);
            const [routeSaveName, setRouteSaveName] = useState('');

            const [stopGroups, setStopGroups] = useState([]); 
            const [stopSelectionInput, setStopSelectionInput] = useState('');
            const [groupNameInput, setGroupNameInput] = useState('');

            const clientInputRef = useRef(null);
            const piecesInputRef = useRef(null);
            const mainClientInputRef = useRef(null); 
            const invisibleAddressInputRef = useRef(null);
            const resultsContainerRef = useRef(null); 

            const ZONE_COLORS = [
                "bg-ess-blue text-white",       
                "bg-ess-green text-white",      
                "bg-sky-600 text-white",        
                "bg-teal-600 text-white",       
                "bg-blue-800 text-white",       
                "bg-emerald-600 text-white",    
                "bg-cyan-700 text-white",       
                "bg-ess-dark text-white"        
            ];

            const handleEnter = (e, callback) => {
                if (e.key === 'Enter') {
                    callback();
                }
            };

            const handleLogout = () => {
                if(window.fbSignOut && window.fbAuth) {
                    window.fbSignOut(window.fbAuth);
                } else {
                    window.location.reload();
                }
            };
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const getUserCollection = (collName) => user ? window.fbCollection(window.fbDb, 'artifacts', appId, 'users', user.uid, collName) : null;
            const getUserDocRef = (collName, docId) => user ? window.fbDoc(window.fbDb, 'artifacts', appId, 'users', user.uid, collName, docId) : null;

            const formatClientName = (name) => {
                if (!name) return "";
                const trimmed = name.trim();
                if (trimmed === trimmed.toUpperCase() && /[a-zA-Z]/.test(trimmed)) return trimmed;
                return trimmed.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            };

            useEffect(() => {
                const fetchConfig = async () => {
                    try {
                        const response = await fetch('/config');
                        const data = await response.json();
                        if (data.firebaseConfig && data.firebaseConfig.apiKey) {
                            const tryInitFb = () => { if (window.initializeFirebaseGlobally) { if (window.initializeFirebaseGlobally(data.firebaseConfig)) setDbReady(true); } else setTimeout(tryInitFb, 50); };
                            tryInitFb();
                        } else { setSystemError("Missing Firebase Config."); setAuthLoading(false); }
                        if (data.googleApiKey) setGoogleApiKey(data.googleApiKey);
                    } catch (err) { setAuthLoading(false); }
                };
                fetchConfig();
            }, []);

            useEffect(() => {
                const initAuth = () => {
                    if (window.fbOnAuthStateChanged) {
                        window.fbOnAuthStateChanged(window.fbAuth, (currentUser) => { setUser(currentUser); setAuthLoading(false); });
                    } else {
                        setTimeout(initAuth, 100);
                    }
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (!user || !window.fbDb || !dbReady) return;
                window.fbOnSnapshot(window.fbQuery(getUserCollection("clients"), window.fbOrderBy("name")), (s) => setClientDB(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("drivers"), window.fbOrderBy("name")), (s) => setDrivers(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("draft_stops"), window.fbOrderBy("createdAt", "desc")), (s) => setCurrentStops(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("vehicles"), window.fbOrderBy("name")), (s) => setVehicles(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("route_history"), window.fbOrderBy("timestamp", "desc"), window.fbLimit(3)), (s) => setHistoryData(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("zones"), window.fbOrderBy("name")), (s) => setZones(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(getUserDocRef("settings", "zone_assignments"), (docSnap) => { if (docSnap.exists()) { setZoneAssignments(docSnap.data()); } });
                window.fbOnSnapshot(window.fbQuery(getUserCollection("saved_routes"), window.fbOrderBy("timestamp", "desc")), (s) => setSavedRoutes(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));

                const userSettingsRef = getUserDocRef("settings", "config");
                window.fbOnSnapshot(userSettingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.baseAddress) setBaseAddress(data.baseAddress);
                        if (data.companyName) setCompanyConfig(prev => ({ ...prev, companyName: data.companyName }));
                        if (data.companyPhone) setCompanyConfig(prev => ({ ...prev, phone: data.companyPhone }));
                        if (data.companyAddress) setCompanyConfig(prev => ({ ...prev, address: data.companyAddress }));
                        if (data.adminPin) setSavedPin(data.adminPin);
                    }
                });
            }, [user, dbReady]);

            useEffect(() => {
                if (!googleApiKey) return;
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&loading=async`;
                script.async = true; script.defer = true;
                script.onload = () => setTimeout(() => setScriptLoaded(true), 100);
                document.head.appendChild(script);
            }, [googleApiKey]);

            const addDriverToFb = async (name) => { if(window.fbDb) await window.fbAddDoc(getUserCollection("drivers"), { name, active: true }); };
            const deleteDriver = async (id) => { if(window.fbDb && confirm('Delete?')) await window.fbDeleteDoc(getUserDocRef("drivers", id)); };
            const toggleDriver = async (id, status) => { if(window.fbDb) await window.fbUpdateDoc(getUserDocRef("drivers", id), { active: !status }); };
            const addVehicleToFb = async (name) => { if(window.fbDb) await window.fbAddDoc(getUserCollection("vehicles"), { name }); };
            const deleteVehicle = async (id) => { if(window.fbDb && confirm('Delete Vehicle?')) await window.fbDeleteDoc(getUserDocRef("vehicles", id)); };
            const saveClient = async () => { 
                if (!clientFormName || !window.fbDb) return; 
                const finalName = formatClientName(clientFormName);
                if (editingClientId) { await window.fbUpdateDoc(getUserDocRef("clients", editingClientId), { name: finalName, address: clientFormAddress }); setEditingClientId(null); } 
                else { await window.fbAddDoc(getUserCollection("clients"), { name: finalName, address: clientFormAddress }); } 
                setClientFormName(''); setClientFormAddress(''); 
            };
            const deleteClient = async (id) => { if(window.fbDb && confirm('Delete?')) { await window.fbDeleteDoc(getUserDocRef("clients", id)); setSelectedClients(selectedClients.filter(c => c !== id)); } };
            const handleBaseAddressChange = async (e) => {
                const val = e.target.value; setBaseAddress(val);
                if (window.fbDb && user) { await window.fbSetDoc(getUserDocRef("settings", "config"), { baseAddress: val }, { merge: true }); }
            };
            const saveSettings = async () => {
                if (window.fbDb && user) {
                    const updateData = { companyName: companyConfig.companyName, companyPhone: companyConfig.phone, companyAddress: companyConfig.address };
                    if(newPin && newPin.length >= 4) { updateData.adminPin = newPin; }
                    await window.fbSetDoc(getUserDocRef("settings", "config"), updateData, { merge: true });
                    alert("Settings saved!"); setNewPin('');
                }
            };
            const handleChangePassword = async () => {
                try { await window.fbSendPasswordResetEmail(window.fbAuth, user.email); setSettingsMsg("Reset email sent!"); } 
                catch(e) { setSettingsMsg("Error: " + e.message); }
            };
            const handleBackup = async () => {
                if (!user || !window.fbDb) return;
                const backupData = { clients: clientDB, drivers: drivers, vehicles: vehicles, stops: currentStops, settings: { baseAddress, companyConfig, savedPin }, timestamp: Date.now() };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `ess_route_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };
            const fileInputRef = useRef(null);
            const handleRestoreClick = () => { fileInputRef.current.click(); };
            const handleFileChange = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                if (!confirm("‚ö†Ô∏è WARNING: This will overwrite your current data with the backup. Are you sure?")) { e.target.value = null; return; }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result); setLoading(true);
                        if (data.clients) { for (const c of data.clients) { await window.fbSetDoc(getUserDocRef("clients", c.id || crypto.randomUUID()), { name: c.name, address: c.address }, { merge: true }); } }
                        if (data.drivers) { for (const d of data.drivers) { await window.fbSetDoc(getUserDocRef("drivers", d.id || crypto.randomUUID()), { name: d.name, active: d.active }, { merge: true }); } }
                        if (data.vehicles) { for (const v of data.vehicles) { await window.fbSetDoc(getUserDocRef("vehicles", v.id || crypto.randomUUID()), { name: v.name }, { merge: true }); } }
                        if (data.stops) { for (const s of data.stops) { await window.fbSetDoc(getUserDocRef("draft_stops", s.id || crypto.randomUUID()), s, { merge: true }); } }
                        if (data.settings) {
                            const settingsPayload = {};
                            if (data.settings.baseAddress) settingsPayload.baseAddress = data.settings.baseAddress;
                            if (data.settings.companyConfig) { settingsPayload.companyName = data.settings.companyConfig.companyName; settingsPayload.companyPhone = data.settings.companyConfig.phone; settingsPayload.companyAddress = data.settings.companyConfig.address; }
                            if (data.settings.savedPin) settingsPayload.adminPin = data.settings.savedPin;
                            await window.fbSetDoc(getUserDocRef("settings", "config"), settingsPayload, { merge: true });
                        }
                        alert("‚úÖ Restore Complete! Data has been migrated."); window.location.reload();
                    } catch (err) { console.error(err); alert("‚ùå Error restoring data: " + err.message); } finally { setLoading(false); e.target.value = null; }
                };
                reader.readAsText(file);
            };
            const handleNavClick = (targetView) => { if (targetView === 'input' || targetView === 'results') { setView('input'); return; } setPendingView(targetView); setPinInput(''); setShowPinModal(true); };
            const submitPin = () => { if (pinInput === savedPin) { setShowPinModal(false); setView(pendingView); } else { alert("Incorrect PIN"); setPinInput(''); } };

            const addZone = async () => {
                if (!newZoneName.trim() || !window.fbDb) return;
                await window.fbAddDoc(getUserCollection("zones"), { name: newZoneName.toUpperCase().trim() });
                setNewZoneName('');
            };
            const deleteZone = async (id) => {
                if (confirm('Delete Zone?')) await window.fbDeleteDoc(getUserDocRef("zones", id));
            };
            const assignDriverToZone = async (driverName, zoneId) => {
                const newAssignments = { ...zoneAssignments, [driverName]: zoneId };
                setZoneAssignments(newAssignments);
                if (window.fbDb) await window.fbSetDoc(getUserDocRef("settings", "zone_assignments"), newAssignments);
                setSelectedDriversForZone(prev => prev.filter(d => d !== driverName)); 
            };
            const moveSelectedDriversToZone = async (zoneId) => {
                const newAssignments = { ...zoneAssignments };
                selectedDriversForZone.forEach(name => {
                    newAssignments[name] = zoneId;
                });
                setZoneAssignments(newAssignments);
                if (window.fbDb) await window.fbSetDoc(getUserDocRef("settings", "zone_assignments"), newAssignments);
                setSelectedDriversForZone([]); 
            };

            const handleSaveRoute = () => {
                if (!routes || Object.keys(routes).length === 0) return alert("No active routes to save.");
                setRouteSaveName('');
                setShowSaveRouteModal(true);
            };

            const confirmSaveRoute = async () => {
                if (!routeSaveName.trim()) return;
                try {
                    const saveData = {
                        name: routeSaveName,
                        timestamp: Date.now(),
                        routes: routes,
                        zoneAssignments: zoneAssignments,
                        currentStops: currentStops
                    };
                    await window.fbAddDoc(getUserCollection("saved_routes"), saveData);
                    setShowSaveRouteModal(false);
                    alert("Route saved successfully!");
                } catch (e) {
                    console.error("Error saving route:", e);
                    alert("Error saving route: " + e.message);
                }
            };

            const handleLoadRoute = () => {
                setShowLoadRouteModal(true);
            };

            const confirmLoadRoute = async (savedRoute) => {
                if (!confirm(`Load route "${savedRoute.name}"? Current unsaved changes will be lost.`)) return;
                try {
                    setLoading(true);
                    setRoutes(savedRoute.routes);
                    setOriginalRoutes(JSON.parse(JSON.stringify(savedRoute.routes))); 
                    setZoneAssignments(savedRoute.zoneAssignments || {});
                    if (window.fbDb) await window.fbSetDoc(getUserDocRef("settings", "zone_assignments"), savedRoute.zoneAssignments || {});
                    
                    const q = window.fbQuery(getUserCollection("draft_stops")); 
                    const snapshot = await window.fbGetDocs(q); 
                    await Promise.all(snapshot.docs.map(doc => window.fbDeleteDoc(doc.ref)));
                    
                    if (savedRoute.currentStops && savedRoute.currentStops.length > 0) {
                         for (const s of savedRoute.currentStops) {
                             const { id, ...stopData } = s;
                             await window.fbAddDoc(getUserCollection("draft_stops"), { ...stopData, createdAt: Date.now() }); 
                         }
                    }
                    setView('results');
                    setShowLoadRouteModal(false);
                } catch (e) {
                    console.error("Error loading route:", e);
                    alert("Error loading route: " + e.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const deleteSavedRoute = async (id) => {
                if(!confirm("Are you sure you want to delete this saved route?")) return;
                await window.fbDeleteDoc(getUserDocRef("saved_routes", id));
            };

            const initiateAddStop = () => {
                if (!newStopAddress) return;
                if (currentStops.some(s => s.address === newStopAddress)) if (!confirm("Duplicate address. Continue?")) return;
                setTempStopData({ name: newStopName || 'Client', address: newStopAddress }); setTempInvoices(''); setTempPieces(''); setShowAddDetailsModal(true);
            };
            const startEditDraft = (stop) => { setEditingDraftId(stop.id); setTempStopData({ name: stop.name, address: stop.address }); setTempInvoices(stop.invoices || ''); setTempPieces(stop.pieces || ''); setShowAddDetailsModal(true); };
            
            const confirmAddStop = async () => {
                const addrToCheck = tempStopData?.address || newStopAddress;
                if (!addrToCheck || !/\b\d{5}\b/.test(addrToCheck)) {
                      return alert("Address must contain a Zip Code.");
                }
                const finalName = formatClientName(tempStopData.name);
                if (editingDraftId && window.fbDb) {
                      await window.fbUpdateDoc(getUserDocRef("draft_stops", editingDraftId), { name: finalName, address: tempStopData.address, invoices: tempInvoices, pieces: tempPieces });
                      setEditingDraftId(null); setShowAddDetailsModal(false); setTempStopData(null); setTempInvoices(''); setTempPieces(''); setNewStopName(''); setNewStopAddress(''); setShowSuggestions(false); setShowAddressSuggestions(false); return;
                } else if (editingStop && routes) {
                    const newRoutes = JSON.parse(JSON.stringify(routes)); const stop = newRoutes[editingStop.driverName].paradas[editingStop.index]; stop.nombre = finalName; stop.direccion = tempStopData.address; stop.invoices = tempInvoices; stop.pieces = tempPieces; setRoutes(newRoutes); 
                    setRoutes(newRoutes);
                    setShowAddDetailsModal(false); setEditingStop(null); setTempStopData(null);
                } else if (targetDriverForManual && routes && routes[targetDriverForManual]) {
                     const newStop = { nombre: finalName, direccion: tempStopData.address, invoices: tempInvoices, pieces: tempPieces }; const newRoutes = JSON.parse(JSON.stringify(routes)); newRoutes[targetDriverForManual].paradas.push(newStop); 
                     setRoutes(newRoutes);
                     setShowManualStopModal(false); setTargetDriverForManual(null);
                } else if (window.fbDb && tempStopData) {
                    await window.fbAddDoc(getUserCollection("draft_stops"), { name: finalName, address: tempStopData.address, invoices: tempInvoices, pieces: tempPieces, createdAt: Date.now() });
                    if (!clientDB.some(c => c.address.toLowerCase() === tempStopData.address.toLowerCase())) window.fbAddDoc(getUserCollection("clients"), { name: finalName, address: tempStopData.address });
                }
                setNewStopName(''); setNewStopAddress(''); setShowSuggestions(false); setShowAddressSuggestions(false); setShowAddDetailsModal(false); setTempStopData(null); setTempInvoices(''); setTempPieces('');
                
                setTimeout(() => { 
                    if (mainClientInputRef.current) mainClientInputRef.current.focus(); 
                }, 100);
            };

            const openEditStopModal = (driverName, index, stopData) => { setEditingStop({ driverName, index }); setTempStopData({ name: stopData.nombre, address: stopData.direccion }); setTempInvoices(stopData.invoices || ''); setTempPieces(stopData.pieces || ''); setShowAddDetailsModal(true); };
            const deleteStopFromRoute = (driverName, index) => { 
                if(!confirm("Remove this stop from route?")) return; 
                const newRoutes = JSON.parse(JSON.stringify(routes)); 
                newRoutes[driverName].paradas.splice(index, 1); 
                setRoutes(newRoutes); 
            };
            const removeStop = async (id) => { if(window.fbDb) await window.fbDeleteDoc(getUserDocRef("draft_stops", id)); };
            const clearDraftRoute = async () => { if(confirm("Clear list?")) { const q = window.fbQuery(getUserCollection("draft_stops")); const snapshot = await window.fbGetDocs(q); await Promise.all(snapshot.docs.map(doc => window.fbDeleteDoc(doc.ref))); } };
            const openPrintModal = (driverName, stops) => { setPrintData({ driverName, stops }); setSelectedVehicleForPrint(vehicles.length > 0 ? vehicles[0].name : ''); setShowPrintModal(true); };
            const handleGlobalPrint = () => { setShowGlobalPrint(true); setTimeout(() => { window.print(); setShowGlobalPrint(false); }, 500); };
            const handlePrint = () => window.print();
            
            const handlePlanZones = async () => {
                if (currentStops.length === 0) return setError('No stops.');
                setLoading(true);
                setError('');
                try {
                    const res = await fetch('/optimizar', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            direcciones: currentStops,
                            num_vans: 1, 
                            base_address: baseAddress,
                            dwell_time: 0 
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Server error.');

                    const routeKey = Object.keys(data)[0]; 
                    if (!routeKey || !data[routeKey].paradas) throw new Error("No route generated.");

                    const sortedStops = data[routeKey].paradas;
                    
                    setOptimizedStops(sortedStops);
                    setView('zone_planning');
                } catch (e) {
                    setError(e.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleGroupedOptimize = async () => {
                const activeDrivers = drivers.filter(d => d.active);
                if (currentStops.length === 0) return setError('No stops.');
                
                const sourceStops = optimizedStops || currentStops;
                
                setLoading(true); setError('');

                try {
                    const groupedIndices = new Set();
                    
                    const tasks = stopGroups.map(group => {
                        const groupStops = group.stops.map(idx => {
                            groupedIndices.add(idx);
                            return sourceStops[idx];
                        });
                        
                        const assignedDrivers = activeDrivers.filter(d => group.assignedDrivers.includes(d.name));
                        
                        if (assignedDrivers.length === 0) {
                            throw new Error(`Group "${group.name}" has no drivers assigned.`);
                        }

                        return {
                            direcciones: groupStops,
                            num_vans: assignedDrivers.length,
                            base_address: baseAddress,
                            dwell_time: parseInt(dwellTime),
                            driverNames: assignedDrivers.map(d => d.name)
                        };
                    });

                    const ungroupedStops = sourceStops.filter((_, i) => !groupedIndices.has(i));
                    const driversInGroups = new Set(stopGroups.flatMap(g => g.assignedDrivers));
                    const freeDrivers = activeDrivers.filter(d => !driversInGroups.has(d.name));

                    if (ungroupedStops.length > 0) {
                        if (freeDrivers.length === 0) {
                             throw new Error("There are ungrouped stops but all drivers are assigned to groups.");
                        }
                        tasks.push({
                            direcciones: ungroupedStops,
                            num_vans: freeDrivers.length,
                            base_address: baseAddress,
                            dwell_time: parseInt(dwellTime),
                            driverNames: freeDrivers.map(d => d.name)
                        });
                    }

                    const results = await Promise.all(tasks.map(async (task) => {
                        const res = await fetch('/optimizar', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'}, 
                            body: JSON.stringify({ 
                                direcciones: task.direcciones, 
                                num_vans: task.num_vans, 
                                base_address: task.base_address, 
                                dwell_time: task.dwell_time 
                            }) 
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Server error.');
                        
                        const mappedResult = {};
                        Object.keys(data).forEach((key, idx) => {
                            const actualDriverName = task.driverNames[idx] || key;
                            mappedResult[actualDriverName] = data[key];
                        });
                        return mappedResult;
                    }));

                    let finalRoutes = {};
                    results.forEach(res => {
                        finalRoutes = { ...finalRoutes, ...res };
                    });

                    setRoutes(finalRoutes);
                    setOriginalRoutes(JSON.parse(JSON.stringify(finalRoutes)));
                    
                    if (window.fbDb) {
                        const historyItem = { stops: currentStops, timestamp: Date.now() };
                        await window.fbAddDoc(getUserCollection("route_history"), historyItem);
                        if (historyData.length >= 3) {
                             const oldest = historyData[historyData.length - 1];
                             if (oldest) await window.fbDeleteDoc(getUserDocRef("route_history", oldest.id));
                        }
                    }

                    setView('results');

                } catch (e) {
                    setError(e.message);
                } finally {
                    setLoading(false);
                }
            };

            const createGroup = () => {
                if (!groupNameInput || !stopSelectionInput) return alert("Please fill all fields");
                
                const listLength = (optimizedStops || currentStops).length;
                const indices = new Set();
                
                const parts = stopSelectionInput.split(/[,;]/); 
                
                for(let part of parts) {
                    part = part.trim();
                    if(!part) continue;
                    
                    if(part.includes('-')) {
                        const rangeParts = part.split('-').map(s => s.trim());
                        if(rangeParts.length === 2) {
                            const start = parseInt(rangeParts[0]) - 1;
                            const end = parseInt(rangeParts[1]) - 1;
                            
                            if(!isNaN(start) && !isNaN(end)) {
                                const min = Math.min(start, end);
                                const max = Math.max(start, end);
                                for(let i = min; i <= max; i++) {
                                    if(i >= 0 && i < listLength) indices.add(i);
                                }
                            }
                        }
                    } else {
                        const idx = parseInt(part) - 1;
                        if(!isNaN(idx) && idx >= 0 && idx < listLength) {
                            indices.add(idx);
                        }
                    }
                }
                
                if (indices.size === 0) {
                    return alert("Invalid selection. Please check the stop numbers.");
                }

                const newGroup = {
                    id: Date.now(),
                    name: groupNameInput,
                    stops: Array.from(indices).sort((a,b) => a-b),
                    assignedDrivers: []
                };

                setStopGroups([...stopGroups, newGroup]);
                setStopSelectionInput('');
                setGroupNameInput('');
            };

            const toggleDriverInGroup = (groupId, driverName) => {
                setStopGroups(stopGroups.map(g => {
                    if (g.id !== groupId) return g;
                    const assigned = g.assignedDrivers.includes(driverName)
                        ? g.assignedDrivers.filter(d => d !== driverName)
                        : [...g.assignedDrivers, driverName];
                    return { ...g, assignedDrivers: assigned };
                }));
            };

            const deleteGroup = (id) => {
                setStopGroups(stopGroups.filter(g => g.id !== id));
            };

            const zoneMapData = useMemo(() => {
                const activeStops = optimizedStops || currentStops;
                const mapData = {};
                const groupedIndices = new Set();

                stopGroups.forEach(g => {
                    const stops = g.stops.map(idx => ({ ...activeStops[idx], originalIndex: idx + 1 }));
                    mapData[g.name] = { paradas: stops };
                    g.stops.forEach(i => groupedIndices.add(i));
                });

                const ungrouped = activeStops
                    .map((s, i) => ({ ...s, originalIndex: i + 1 }))
                    .filter((_, i) => !groupedIndices.has(i));
                
                const CHUNK_SIZE = 20; 
                if (ungrouped.length > 0) {
                    if (ungrouped.length <= CHUNK_SIZE) {
                        mapData['Ungrouped'] = { paradas: ungrouped };
                    } else {
                        for (let i = 0; i < ungrouped.length; i += CHUNK_SIZE) {
                            const chunk = ungrouped.slice(i, i + CHUNK_SIZE);
                            mapData[`Ungrouped ${Math.floor(i/CHUNK_SIZE) + 1}`] = { paradas: chunk, isChunk: true };
                        }
                    }
                }

                return mapData;
            }, [currentStops, optimizedStops, stopGroups]);


            const restoreHistory = async (stops) => {
                if(!confirm("Restore this route? Current stops will be overwritten.")) return;
                setLoading(true);
                const q = window.fbQuery(getUserCollection("draft_stops")); const snapshot = await window.fbGetDocs(q); await Promise.all(snapshot.docs.map(doc => window.fbDeleteDoc(doc.ref)));
                for (const s of stops) { await window.fbAddDoc(getUserCollection("draft_stops"), { ...s, createdAt: Date.now() }); }
                setLoading(false); setShowHistoryModal(false);
            };
            const openDriverMap = (name, data) => setViewingDriver({ name, data });
            const selectClient = (c) => { setNewStopName(c.name); setNewStopAddress(c.address); setShowSuggestions(false); setShowAddressSuggestions(false); setActiveSuggestionIndex(-1); };
            const getClientNameFromAddress = (address) => { const fromDraft = currentStops.find(s => s.address === address); if (fromDraft) return fromDraft.name; const fromDB = clientDB.find(c => c.address === address); return fromDB ? fromDB.name : "Client"; };
            const getWhatsappLink = (l) => `https://wa.me/?text=${encodeURIComponent(`Hello, route:\n\n${l}\n\nDrive safely!`)}`;
            
            const filteredClients = useMemo(() => { 
                const t = newStopName.toLowerCase().trim(); 
                if (!t) return []; 
                return clientDB.filter(c => 
                    (c.name || "").toLowerCase().includes(t) || 
                    (c.address || "").toLowerCase().includes(t)
                ).slice(0, 5); 
            }, [newStopName, clientDB]);

            const filteredClientsByAddress = useMemo(() => { const t = newStopAddress.toLowerCase().trim(); if (!t) return []; return clientDB.filter(c => (c.address || "").toLowerCase().includes(t)).slice(0, 5); }, [newStopAddress, clientDB]);
            
            const filteredClientDBList = useMemo(() => { 
                const nameTerm = clientFormName.toLowerCase().trim();
                const addrTerm = clientFormAddress.toLowerCase().trim();
                if (!nameTerm && !addrTerm) return clientDB;
                return clientDB.filter(c => {
                    const matchName = !nameTerm || (c.name || "").toLowerCase().includes(nameTerm);
                    const matchAddr = !addrTerm || (c.address || "").toLowerCase().includes(addrTerm);
                    return matchName && matchAddr;
                });
            }, [clientFormName, clientFormAddress, clientDB]);

            const suggestionsForClientDbAddress = useMemo(() => {
                const t = clientFormAddress.toLowerCase().trim();
                if (!t) return [];
                return clientDB.filter(c => (c.address || "").toLowerCase().includes(t)).slice(0, 5);
            }, [clientFormAddress, clientDB]);

            // MODIFICADO: Recalcular ahora hace OPTIMIZACI√ìN TOTAL (reordena todo)
            const recalculateRoute = async (dName, stops) => { 
                setRecalculating(p => ({...p, [dName]: true})); 
                try { 
                    // Usamos /optimizar con 1 van para forzar un TSP completo (reordena incluso la #1)
                    const res = await fetch('/optimizar', { 
                        method: 'POST', 
                        headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify({ 
                            direcciones: stops, 
                            num_vans: 1, 
                            base_address: baseAddress, 
                            dwell_time: parseInt(dwellTime) 
                        }) 
                    }); 
                    const d = await res.json(); 
                    if(!res.ok) throw new Error(d.error);

                    // La API /optimizar devuelve { "Van 1": { ... } }
                    // Tomamos la primera ruta generada y se la asignamos al chofer actual
                    const routeKey = Object.keys(d)[0];
                    const optimizedData = d[routeKey];

                    setRoutes(p => ({
                        ...p, 
                        [dName]: {
                            ...p[dName], 
                            duracion_estimada: optimizedData.duracion_estimada, 
                            link: optimizedData.link, 
                            paradas: optimizedData.paradas
                        }
                    })); 
                } catch (e) { 
                    console.error(e);
                    alert("Error optimizing route: " + e.message);
                } finally { 
                    setRecalculating(p => ({...p, [dName]: false})); 
                } 
            };

            const handleRecalculateAll = async () => { if (!routes) return; setIsRecalculatingAll(true); await Promise.all(Object.keys(routes).map(d => recalculateRoute(d, routes[d].paradas))); setIsRecalculatingAll(false); };
            
            const handleRestore = async () => { 
                if (confirm("Restore original routes? This will also reset zone assignments.")) { 
                    setRoutes(JSON.parse(JSON.stringify(originalRoutes))); 
                    setZoneAssignments({});
                    setSelectedDriversForZone([]);
                    if (window.fbDb) await window.fbSetDoc(getUserDocRef("settings", "zone_assignments"), {});
                } 
            };

            // MANTENIDO: La varita m√°gica usa /optimizar_restantes (Respeta Stop #1)
            const handleOptimizeRemaining = async (driverName) => {
                const currentRoute = routes[driverName].paradas; setRecalculating(p => ({...p, [driverName]: true})); 
                try { const res = await fetch('/optimizar_restantes', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ paradas: currentRoute, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); const d = await res.json(); if(!res.ok) throw new Error(d.error); setRoutes(p => ({...p, [driverName]: {...p[driverName], duracion_estimada: d.duracion_estimada, link: d.link, paradas: d.paradas}})); } catch (e) { console.error(e); } finally { setRecalculating(p => ({...p, [driverName]: false})); }
            };
            
            const reverseRoute = (driverName) => { 
                const newRoutes = JSON.parse(JSON.stringify(routes)); 
                newRoutes[driverName].paradas.reverse(); 
                setRoutes(newRoutes); 
            };
            const handleSwapDriver = (driverA, driverB) => { 
                if (driverA === driverB) { setSwappingDriver(null); return; } 
                const newRoutes = { ...routes }; 
                const tempRoute = newRoutes[driverA]; 
                newRoutes[driverA] = newRoutes[driverB]; 
                newRoutes[driverB] = tempRoute; 
                setRoutes(newRoutes); 
                setSwappingDriver(null); 
            };

            const handleAddRoute = () => setShowAddRouteModal(true);
            const confirmAddRoute = (driverToAdd) => { if (!routes) return; const newRoutes = { ...routes }; newRoutes[driverToAdd] = { paradas: [], duracion_estimada: 0, link: "" }; setRoutes(newRoutes); setShowAddRouteModal(false); };
            const initiateManualStop = (driverName) => { setTargetDriverForManual(driverName); setNewStopName(''); setNewStopAddress(''); setTempStopData(null); setTempInvoices(''); setTempPieces(''); setShowManualStopModal(true); };
            
            const handleClientKeyDown = (e) => {
                if (showSuggestions && filteredClients.length > 0) {
                    if (e.key === 'ArrowDown') { e.preventDefault(); setActiveSuggestionIndex(prev => (prev < filteredClients.length - 1 ? prev + 1 : prev)); } 
                    else if (e.key === 'ArrowUp') { e.preventDefault(); setActiveSuggestionIndex(prev => (prev > -1 ? prev - 1 : -1)); } 
                    else if (e.key === 'Enter') { if (activeSuggestionIndex >= 0) { e.preventDefault(); selectClient(filteredClients[activeSuggestionIndex]); } else { handleEnter(e, initiateAddStop); } } 
                    else if (e.key === 'Escape') { setShowSuggestions(false); setActiveSuggestionIndex(-1); }
                } else { handleEnter(e, initiateAddStop); }
            };
            
            const handleDragStart = (e, driverName, stopIndex) => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) { e.preventDefault(); return; } setDraggedItem({ driverName, stopIndex }); e.dataTransfer.effectAllowed = 'move'; setTimeout(() => e.target.classList.add('draggable-source'), 0); };
            const handleDragEnd = (e) => { e.target.classList.remove('draggable-source'); setDraggedItem(null); setDragOverDriver(null); };
            const handleDragOverContainer = (e, driverName) => { e.preventDefault(); setDragOverDriver(driverName); };
            const handleDrop = (e, targetDriverName, targetIndex = null) => { 
                e.preventDefault(); 
                setDragOverDriver(null); 
                if (!draggedItem) return; 
                const sourceDriver = draggedItem.driverName; 
                const sourceIndex = draggedItem.stopIndex; 
                const newRoutes = JSON.parse(JSON.stringify(routes)); 
                const [movedStop] = newRoutes[sourceDriver].paradas.splice(sourceIndex, 1); 
                let destinationStops = newRoutes[targetDriverName].paradas; 
                if (targetIndex !== null) { 
                    let adjustedTargetIndex = targetIndex; 
                    if (sourceDriver === targetDriverName && sourceIndex < targetIndex) { adjustedTargetIndex = targetIndex - 0; } 
                    destinationStops.splice(adjustedTargetIndex, 0, movedStop); 
                } else { 
                    destinationStops.push(movedStop); 
                } 
                setRoutes(newRoutes); 
            };
            const toggleStopSelection = (driverName, index) => { setSelectedStops(prev => { const exists = prev.find(p => p.driver === driverName && p.index === index); if (exists) return prev.filter(p => !(p.driver === driverName && p.index === index)); return [...prev, { driver: driverName, index }]; }); };
            const moveStop = (driverName, index, direction) => { 
                const newRoutes = JSON.parse(JSON.stringify(routes)); 
                const stops = newRoutes[driverName].paradas; 
                const newIndex = index + direction; 
                if (newIndex < 0 || newIndex >= stops.length) return; 
                [stops[index], stops[newIndex]] = [stops[newIndex], stops[index]]; 
                setRoutes(newRoutes); 
            };
            const transferSelectedStops = (targetDriver) => { 
                if (selectedStops.length === 0) return; 
                const newRoutes = JSON.parse(JSON.stringify(routes)); 
                const sortedSelection = [...selectedStops].sort((a, b) => b.index - a.index); 
                sortedSelection.forEach(sel => { 
                    const [removed] = newRoutes[sel.driver].paradas.splice(sel.index, 1); 
                    newRoutes[targetDriver].paradas.push(removed); 
                }); 
                setRoutes(newRoutes); 
                setSelectedStops([]); 
            };

            const handleResultsDragOver = (e) => {
                e.preventDefault(); // Required for dropping
                const container = resultsContainerRef.current;
                if (!container || (!draggedDriver && !draggedItem)) return;
                const { top, bottom, height } = container.getBoundingClientRect();
                const y = e.clientY;
                const edgeThreshold = 80; 
                const scrollStep = 15;
                if (y < top + edgeThreshold) { container.scrollTop -= scrollStep; } else if (y > bottom - edgeThreshold) { container.scrollTop += scrollStep; }
            };

            if (systemError) return <ConfigErrorScreen errorDetails={systemError} />;
            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-ess-blue font-bold text-lg">Loading...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen text-slate-800 bg-white pb-24">
                    {/* COMPONENTS (Modals etc...) */}
                    {printData && showPrintModal && <PrintableSheet routeData={printData.stops} driverName={printData.driverName} vehicle={selectedVehicleForPrint} config={companyConfig} />}
                    {showGlobalPrint && routes && <GlobalManifest routes={routes} config={companyConfig} />}
                    {showHistoryModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="clock" className="h-5 w-5" /> Recent History (Last 3)</h3>
                                    <button onClick={() => setShowHistoryModal(false)} className="text-slate-400 hover:text-red-500"><Icon name="x" className="h-5 w-5" /></button>
                                </div>
                                <div className="space-y-3">
                                    {historyData.length === 0 && <p className="text-slate-400 text-sm text-center py-4">No history available yet.</p>}
                                    {historyData.map((item, idx) => (
                                        <div key={item.id} className="border border-slate-200 rounded-lg p-3 hover:bg-slate-50 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-sm text-slate-700">Route #{idx + 1}</div>
                                                <div className="text-xs text-slate-500">{new Date(item.timestamp).toLocaleString()}</div>
                                                <div className="text-xs font-bold text-ess-blue mt-1">{item.stops.length} Stops</div>
                                            </div>
                                            <button onClick={() => restoreHistory(item.stops)} disabled={loading} className="bg-white border border-slate-300 text-slate-700 hover:bg-blue-50 hover:text-ess-blue px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-colors">Restore</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    {/* ... (Other modals kept same) ... */}
                    {showSaveRouteModal && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm"><h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Icon name="save" className="h-5 w-5 text-ess-blue" /> Save Current Route</h3><p className="text-sm text-slate-500 mb-4">Give a name to this plan to easily reload it later.</p><input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none mb-4 focus:ring-2 focus:ring-ess-blue" placeholder="e.g., Monday Morning Route" value={routeSaveName} onChange={e => setRouteSaveName(e.target.value)} autoFocus /><div className="flex gap-3"><button onClick={() => setShowSaveRouteModal(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-50 rounded-lg font-bold">Cancel</button><button onClick={confirmSaveRoute} disabled={!routeSaveName.trim()} className="flex-1 py-2 bg-ess-blue text-white rounded-lg font-bold shadow-lg disabled:opacity-50">Save Plan</button></div></div></div>)}
                    {showLoadRouteModal && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md h-[500px] flex flex-col"><div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="folder-open" className="h-5 w-5 text-ess-blue" /> Saved Plans</h3><button onClick={() => setShowLoadRouteModal(false)} className="text-slate-400 hover:text-red-500"><Icon name="x" className="h-5 w-5" /></button></div><div className="flex-1 overflow-y-auto space-y-3 pr-2">{savedRoutes.length === 0 && <p className="text-slate-400 text-sm text-center py-10">No saved plans yet.</p>}{savedRoutes.map((route) => (<div key={route.id} className="border border-slate-200 rounded-lg p-3 hover:bg-slate-50 transition-colors"><div className="flex justify-between items-start mb-2"><div><div className="font-bold text-slate-800">{route.name}</div><div className="text-xs text-slate-500">{new Date(route.timestamp).toLocaleString()}</div></div><button onClick={() => deleteSavedRoute(route.id)} className="text-slate-400 hover:text-red-500 p-1"><Icon name="trash-2" className="h-4 w-4" /></button></div><div className="flex items-center gap-4 text-xs text-slate-600 mb-3"><span className="flex items-center gap-1"><Icon name="users" className="h-3 w-3" /> {Object.keys(route.routes || {}).length} Drivers</span><span className="flex items-center gap-1"><Icon name="map-pin" className="h-3 w-3" /> {route.currentStops ? route.currentStops.length : 0} Stops</span></div><button onClick={() => confirmLoadRoute(route)} className="w-full py-2 bg-white border border-ess-blue text-ess-blue font-bold rounded hover:bg-blue-50 transition-colors flex justify-center items-center gap-2">Load Plan <Icon name="arrow-right" className="h-3 w-3" /></button></div>))}</div></div></div>)}
                    {(showAddDetailsModal || showManualStopModal) && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 no-print animate-fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm"><h3 className="font-bold text-lg mb-4 text-slate-800">{editingDraftId ? 'Edit Draft Stop' : (editingStop ? 'Edit Stop Details' : (showManualStopModal ? `Add Stop to ${targetDriverForManual}` : "Add Stop Details"))}</h3>{(showManualStopModal || editingStop || editingDraftId) ? (<div className="mb-4 space-y-4"><div className="relative"><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Client Name</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Name" value={tempStopData?.name || newStopName} onChange={(e) => { if(tempStopData) setTempStopData({...tempStopData, name: e.target.value}); else { setNewStopName(e.target.value); setShowSuggestions(true); setActiveSuggestionIndex(-1); } }} onKeyDown={(e) => handleEnter(e, () => {})} disabled={!showManualStopModal && !editingStop && !editingDraftId}/> {showSuggestions && !tempStopData && filteredClients.length > 0 && <div className="absolute w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 z-50">{filteredClients.map((c, i) => (<div key={i} onClick={() => { selectClient(c); setTempStopData({name: c.name, address: c.address}); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm font-bold">{c.name}</div>))}</div>}</div><div className="relative"><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Address</label><GoogleAddressInput value={tempStopData?.address || newStopAddress} onChange={(e) => { if(tempStopData) setTempStopData({...tempStopData, address: e.target.value}); else { setNewStopAddress(e.target.value); setTempStopData(prev => ({...prev, address: e.target.value})); setShowAddressSuggestions(true); } }} onKeyDown={(e) => handleEnter(e, () => {})} className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Address" disabled={!scriptLoaded} isLoaded={scriptLoaded} />{!tempStopData && showAddressSuggestions && filteredClientsByAddress.length > 0 && <div className="absolute w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 z-50 bottom-full mb-1"><div className="bg-ess-blue text-white text-xs font-bold px-2 py-1">üëá Saved Clients</div>{filteredClientsByAddress.map((c, i) => (<div key={i} onClick={() => { selectClient(c); setTempStopData({name: c.name, address: c.address}); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm"><div className="font-bold text-slate-700">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}</div></div>) : null}<div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Invoices (Optional)</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="e.g. 10550, 10551" value={tempInvoices} onChange={e => setTempInvoices(e.target.value)} onKeyDown={(e) => handleEnter(e, () => piecesInputRef.current?.focus())} autoFocus /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Pieces Shipped</label><input ref={piecesInputRef} type="number" className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="0" value={tempPieces} onChange={e => setTempPieces(e.target.value)} onKeyDown={(e) => handleEnter(e, confirmAddStop)} /></div></div><div className="mt-6 flex gap-3"><button onClick={() => { setShowAddDetailsModal(false); setShowManualStopModal(false); setTargetDriverForManual(null); setEditingStop(null); setEditingDraftId(null); setTempStopData(null); }} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-bold">Cancel</button><button onClick={confirmAddStop} className="flex-1 py-3 bg-ess-blue text-white rounded-lg font-bold shadow-lg">Save</button></div></div></div>)}
                    {/* ... (Add Route, Pin, Print, Driver Map Modals - kept same) ... */}
                    {showAddRouteModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 no-print animate-fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm"><h3 className="font-bold text-lg mb-4 text-slate-800">Add New Route</h3><p className="text-sm text-slate-500 mb-4">Select a driver who doesn't have a route yet.</p><div className="space-y-2 max-h-40 overflow-y-auto mb-4 border rounded p-2">{drivers.filter(d => !routes[d.name]).map(d => (<button key={d.id} onClick={() => confirmAddRoute(d.name)} className="w-full text-left p-2 hover:bg-blue-50 rounded font-bold text-slate-700 flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${d.active ? 'bg-green-500' : 'bg-gray-400'}`}></div> {d.name}</button>))}{drivers.filter(d => !routes[d.name]).length === 0 && <p className="text-sm text-slate-400">All drivers have routes.</p>}</div><div className="flex justify-end"><button onClick={() => setShowAddRouteModal(false)} className="text-slate-500 font-bold px-4">Cancel</button></div></div></div>)}
                    {showPinModal && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 no-print animate-fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center"><h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center justify-center gap-2"><Icon name="lock" className="h-5 w-5" /> Enter Security PIN</h3><input type="password" className="w-full p-3 border border-slate-300 rounded-lg outline-none text-center text-2xl tracking-widest" maxLength="6" value={pinInput} onChange={e => setPinInput(e.target.value)} onKeyDown={(e) => handleEnter(e, submitPin)} autoFocus /><div className="mt-6 flex gap-3"><button onClick={() => setShowPinModal(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-bold">Cancel</button><button onClick={submitPin} className="flex-1 py-3 bg-slate-800 text-white rounded-lg font-bold">Unlock</button></div></div></div>)}
                    {showPrintModal && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 no-print animate-fade-in"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"><div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold text-slate-800">Print Manifest</h3><button onClick={() => setShowPrintModal(false)} className="text-slate-400 hover:text-red-500"><Icon name="x" className="h-5 w-5" /></button></div><div className="p-6 space-y-6"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Select Truck for this Sheet</label><select className="w-full p-3 border border-slate-300 rounded-lg outline-none bg-white" value={selectedVehicleForPrint} onChange={e => setSelectedVehicleForPrint(e.target.value)}><option value="">-- Select Truck --</option>{vehicles.map(v => <option key={v.id} value={v.name}>{v.name}</option>)}</select>{vehicles.length === 0 && <p className="text-xs text-red-500 mt-1">No trucks defined. Add them in Van/Truck ID tab.</p>}</div><div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 border border-blue-100"><p className="font-bold mb-1">Ready to print for:</p><p>Driver: {printData.driverName}</p><p>Stops: {printData.stops.length}</p></div></div><div className="p-4 border-t border-slate-100 bg-white flex gap-3"><button onClick={() => setShowPrintModal(false)} className="flex-1 py-3 bg-white border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-slate-50">Cancel</button><button onClick={handlePrint} className="flex-1 py-3 bg-slate-800 text-white rounded-lg font-bold hover:bg-black flex items-center justify-center gap-2"><Icon name="printer" className="h-4 w-4" /> Print Now</button></div></div></div>)}
                    {viewingDriver && (<div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 animate-fade-in"><div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden relative"><div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center z-10 relative"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="map" className="h-5 w-5 text-ess-blue" /> Route: {viewingDriver.name}</h3><button onClick={() => setViewingDriver(null)} className="text-slate-400 hover:text-red-500"><Icon name="x" className="h-6 w-6" /></button></div><div className="flex-1 relative w-full h-full"><GlobalMapView routes={{ [viewingDriver.name]: viewingDriver.data }} baseAddress={baseAddress} /></div></div></div>)}

                    {/* HEADER */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 no-print">
                         <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto"/>
                                <div className="hidden md:block pl-4 border-l border-slate-200">
                                    <h1 className="text-xl font-bold text-ess-blue leading-none">Route Planner</h1>
                                    <p className="text-xs text-slate-400 mt-1">Logged as: <span className="font-bold text-ess-green">{user.email}</span></p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={handleLoadRoute} className="text-sm font-bold px-3 py-2 rounded-lg flex items-center gap-2 text-slate-600 bg-white border border-slate-200 hover:text-ess-blue hover:bg-slate-50 transition-colors shadow-sm" title="Load Saved Route"><Icon name="folder-open" className="h-4 w-4" /> Saved Plans</button>
                                <div className="h-6 w-px bg-slate-300 mx-1"></div>
                                <button onClick={() => handleNavClick('input')} className={`text-sm font-medium px-3 py-2 rounded-lg flex items-center gap-2 ${view === 'input' || view === 'zone_planning' || view === 'results' || view === 'global_map' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 bg-slate-50 border border-slate-200 hover:text-ess-blue'}`}><Icon name="layout-dashboard" className="h-4 w-4" /> Planner</button>
                                <button onClick={() => handleNavClick('clients')} className={`text-sm font-medium px-3 py-2 rounded-lg flex items-center gap-2 ${view === 'clients' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 bg-slate-50 border border-slate-200 hover:text-ess-blue'}`}><Icon name="database" className="h-4 w-4" /> Clients</button>
                                <button onClick={() => handleNavClick('vehicles')} className={`text-sm font-medium px-3 py-2 rounded-lg flex items-center gap-2 ${view === 'vehicles' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 bg-slate-50 border border-slate-200 hover:text-ess-blue'}`}><Icon name="truck" className="h-4 w-4" /> Van or Truck ID</button>
                                <button onClick={() => handleNavClick('settings')} className={`text-sm font-medium px-3 py-2 rounded-lg flex items-center gap-2 ${view === 'settings' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 bg-slate-50 border border-slate-200 hover:text-ess-blue'}`}><Icon name="settings" className="h-4 w-4" /> Settings</button>
                                <button onClick={handleLogout} className="text-sm font-medium text-red-500 hover:bg-red-50 border border-transparent hover:border-red-100 px-3 py-2 rounded-lg flex items-center gap-2 ml-2"><Icon name="log-out" className="h-4 w-4" /> Exit</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6 no-print">
                        {/* SETTINGS, CLIENTS, VEHICLES... (Kept same) */}
                        {view === 'settings' && (
                            <div className="max-w-2xl mx-auto animate-fade-in">
                                <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden p-6 space-y-8">
                                    <div><h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Delivery Zones</h2><div className="space-y-4"><p className="text-sm text-slate-600">Create zones to organize your drivers visually (e.g., NORTHWEST, MIAMI BEACH).</p><div className="flex gap-2"><input type="text" className="flex-1 p-2 border rounded uppercase" placeholder="New Zone Name" value={newZoneName} onChange={e => setNewZoneName(e.target.value)} onKeyDown={(e) => handleEnter(e, addZone)} /><button onClick={addZone} className="bg-slate-800 text-white px-4 py-2 rounded font-bold">Add</button></div><div className="flex flex-wrap gap-2">{zones.map(z => (<div key={z.id} className="bg-white border border-slate-300 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{z.name}<button onClick={() => deleteZone(z.id)} className="text-red-500 hover:bg-red-50 rounded-full p-0.5"><Icon name="x" className="h-3 w-3" /></button></div>))}{zones.length === 0 && <span className="text-slate-400 text-sm italic">No zones defined yet.</span>}</div></div></div>
                                    <div><h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Data Management (Migrate User)</h2><div className="space-y-4"><p className="text-sm text-slate-600">Use this to move your data to a new account. Download backup from old account, then restore in new one.</p><div className="flex gap-4"><button onClick={handleBackup} className="flex-1 bg-slate-800 text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2"><Icon name="download" className="h-4 w-4" /> Download Backup</button><input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" /><button onClick={handleRestoreClick} className="flex-1 bg-ess-blue text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2"><Icon name="upload" className="h-4 w-4" /> Restore from Backup</button></div></div></div>
                                    <div><h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Manifest Header Info</h2><div className="space-y-4"><div><label className="block text-sm font-bold text-slate-500 mb-1">Company Name</label><input className="w-full p-2 border rounded" value={companyConfig.companyName} onChange={e => setCompanyConfig({...companyConfig, companyName: e.target.value})} /></div><div><label className="block text-sm font-bold text-slate-500 mb-1">Phone</label><input className="w-full p-2 border rounded" value={companyConfig.phone} onChange={e => setCompanyConfig({...companyConfig, phone: e.target.value})} /></div><div><label className="block text-sm font-bold text-slate-500 mb-1">Footer Address</label><input className="w-full p-2 border rounded" value={companyConfig.address} onChange={e => setCompanyConfig({...companyConfig, address: e.target.value})} /></div></div></div>
                                    <div><h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">App Security</h2><div className="space-y-4"><div><label className="block text-sm font-bold text-slate-500 mb-1">Change Security PIN (Default: 0000)</label><input type="text" className="w-full p-2 border rounded" maxLength="6" placeholder="New PIN" value={newPin} onChange={e => setNewPin(e.target.value)} /></div><button onClick={saveSettings} className="bg-slate-800 text-white px-4 py-2 rounded font-bold">Save All Settings</button></div></div>
                                    <div><h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Account Security</h2><div className="space-y-4"><p className="text-sm text-slate-600">Click below to receive an email to reset your password for <strong>{user.email}</strong>.</p><button onClick={handleChangePassword} className="bg-ess-blue text-white px-4 py-2 rounded font-bold">Send Password Reset Email</button>{settingsMsg && <p className="text-sm text-green-600 font-bold">{settingsMsg}</p>}</div></div>
                                </div>
                            </div>
                        )}
                        {/* Clients and Vehicles views kept compacted for brevity, they are same */}
                        {view === 'clients' && (<div className="max-w-4xl mx-auto animate-fade-in"><div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden"><div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center"><div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="database" className="h-5 w-5 text-ess-blue" /> Clients</h2></div><span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-slate-600 border border-slate-200">{clientDB.length} Clients</span></div><div className="p-6 bg-blue-50/50 border-b border-slate-200"><div className="flex flex-col md:flex-row gap-4"><input type="text" className="flex-1 p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Search / New Name..." value={clientFormName} onChange={(e) => setClientFormName(e.target.value)} onKeyDown={(e) => handleEnter(e, saveClient)} /><div className="flex-[2] relative"><GoogleAddressInput value={clientFormAddress} onChange={(e) => { setClientFormAddress(e.target.value); setShowClientDbAddressSuggestions(true); }} onKeyDown={(e) => handleEnter(e, saveClient)} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Address" disabled={!scriptLoaded} isLoaded={scriptLoaded} />{showClientDbAddressSuggestions && suggestionsForClientDbAddress.length > 0 && (<div className="absolute w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 z-50 bottom-full mb-1"><div className="bg-ess-blue text-white text-xs font-bold px-2 py-1">üëá Saved Clients</div>{suggestionsForClientDbAddress.map((c, i) => (<div key={i} onClick={() => { setClientFormName(c.name); setClientFormAddress(c.address); setEditingClientId(c.id); setShowClientDbAddressSuggestions(false); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm"><div className="font-bold text-slate-700">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>)}</div><button onClick={saveClient} disabled={!clientFormName || !clientFormAddress} className="bg-ess-green text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2"><Icon name={editingClientId ? 'save' : 'plus'} className="h-4 w-4" /> {editingClientId ? 'Save' : 'Add'}</button></div></div><div className="max-h-[600px] overflow-y-auto"><table className="w-full text-left border-collapse"><tbody className="divide-y divide-slate-100">{filteredClientDBList.map(c => (<tr key={c.id} className="hover:bg-slate-50"><td className="p-4 font-medium">{c.name}</td><td className="p-4 text-sm text-slate-600">{c.address}</td><td className="p-4 text-right"><div className="flex justify-end gap-2"><button onClick={()=>{setEditingClientId(c.id); setClientFormName(c.name); setClientFormAddress(c.address)}} className="text-blue-600 p-1"><Icon name="pencil" className="h-4 w-4"/></button><button onClick={()=>deleteClient(c.id)} className="text-red-500 p-1"><Icon name="trash-2" className="h-4 w-4"/></button></div></td></tr>))}</tbody></table></div></div></div>)}
                        {view === 'vehicles' && (<div className="max-w-2xl mx-auto animate-fade-in"><div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden"><div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="truck" className="h-5 w-5 text-ess-blue" /> Fleet Management</h2><span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-slate-600 border border-slate-200">{vehicles.length} Trucks</span></div><div className="p-6 bg-blue-50/50 border-b border-slate-200"><div className="flex gap-4"><input type="text" className="flex-1 p-3 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-ess-blue" placeholder="Vehicle Name / Plate ID (e.g. DX09UF)" value={newVehicleName} onChange={(e) => setNewVehicleName(e.target.value)} onKeyDown={(e) => handleEnter(e, () => {if(newVehicleName.trim()){ addVehicleToFb(newVehicleName); setNewVehicleName(''); }})} /><button onClick={() => {if(newVehicleName.trim()){ addVehicleToFb(newVehicleName); setNewVehicleName(''); }}} className="bg-ess-green text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-green-600 flex items-center gap-2"><Icon name="plus" className="h-4 w-4" /> Add Truck</button></div></div><div className="max-h-[500px] overflow-y-auto"><table className="w-full text-left border-collapse"><tbody className="divide-y divide-slate-100">{vehicles.length === 0 ? <tr><td className="p-8 text-center text-slate-400">No vehicles added yet.</td></tr> : vehicles.map(v => (<tr key={v.id} className="hover:bg-slate-50"><td className="p-4 font-bold text-slate-700 flex items-center gap-3"><div className="bg-blue-100 p-2 rounded-full"><Icon name="truck" className="h-4 w-4 text-ess-blue" /></div> {v.name}</td><td className="p-4 text-right"><button onClick={() => deleteVehicle(v.id)} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg transition-colors"><Icon name="trash-2" className="h-5 w-5" /></button></td></tr>))}</tbody></table></div></div></div>)}
                        
                        {view === 'global_map' && <div className="flex flex-col h-[calc(100vh-120px)]"><div className="mb-4"><button onClick={() => setView('results')} className="text-slate-600 px-4 py-2 border rounded-lg bg-white hover:bg-slate-50 font-bold flex items-center gap-2 shadow-sm"><Icon name="arrow-left" className="h-4 w-4" /> Back to Results</button></div><div className="flex-1 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden relative"><GlobalMapView routes={routes} baseAddress={baseAddress} /></div></div>}

                        {/* NEW ZONE PLANNING VIEW */}
                        {view === 'zone_planning' && (
                            <div className="grid grid-cols-12 gap-6 h-[calc(100vh-120px)] animate-fade-in">
                                {/* LEFT PANEL: CONTROLS */}
                                <div className="col-span-12 lg:col-span-4 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                    <div className="p-4 bg-slate-800 text-white font-bold flex justify-between items-center">
                                        <span>Step 1: Create Zones</span>
                                        <button onClick={() => { setView('input'); setOptimizedStops(null); }} className="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded">Back</button>
                                    </div>
                                    
                                    <div className="p-4 border-b border-slate-100 bg-slate-50">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2">Create New Zone</h4>
                                        <div className="mb-2">
                                            <input 
                                                type="text" 
                                                placeholder="Stops (e.g. 1-5, 8, 11-13)" 
                                                className="w-full p-2 border rounded text-sm" 
                                                value={stopSelectionInput} 
                                                onChange={e => setStopSelectionInput(e.target.value)} 
                                            />
                                            <p className="text-[10px] text-slate-400 mt-1">Use commas for individual stops and dashes for ranges.</p>
                                        </div>
                                        <div className="flex gap-2">
                                            {/* DATALIST FOR ZONES */}
                                            <input list="savedZones" type="text" placeholder="Zone Name (e.g. MIAMI)" className="flex-1 p-2 border rounded text-sm uppercase" value={groupNameInput} onChange={e => setGroupNameInput(e.target.value)} />
                                            <datalist id="savedZones">
                                                {zones.map(z => <option key={z.id} value={z.name} />)}
                                            </datalist>
                                            <button onClick={createGroup} className="bg-ess-blue text-white px-3 py-2 rounded font-bold text-xs">Create</button>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                        {stopGroups.map((group, idx) => (
                                            <div key={group.id} className="border border-slate-200 rounded-lg p-3 bg-white shadow-sm">
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="font-bold text-slate-800 flex items-center gap-2">
                                                        {/* Use Company Palette classes */}
                                                        <span className={`w-3 h-3 rounded-full ${COMPANY_PALETTE[idx % COMPANY_PALETTE.length].tw.split(' ')[0]}`}></span>
                                                        {group.name}
                                                    </div>
                                                    <button onClick={() => deleteGroup(group.id)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" className="h-4 w-4" /></button>
                                                </div>
                                                <div className="text-xs text-slate-500 mb-3">
                                                    Stops: {group.stops.map(i => i + 1).join(', ')}
                                                </div>
                                                <div className="border-t border-slate-100 pt-2">
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase mb-1">Assign Drivers:</p>
                                                    <div className="flex flex-wrap gap-1">
                                                        {drivers.filter(d => d.active).map(driver => (
                                                            <button 
                                                                key={driver.id}
                                                                onClick={() => toggleDriverInGroup(group.id, driver.name)}
                                                                className={`text-[10px] px-2 py-1 rounded border transition-colors ${group.assignedDrivers.includes(driver.name) ? 'bg-green-100 border-green-300 text-green-800 font-bold' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}
                                                            >
                                                                {driver.name}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {stopGroups.length === 0 && <p className="text-center text-slate-400 text-sm py-4 italic">No zones created yet. Use the map to decide ranges.</p>}
                                    </div>

                                    <div className="p-4 bg-slate-50 border-t border-slate-200">
                                        <button onClick={handleGroupedOptimize} disabled={loading || stopGroups.length === 0} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2 disabled:opacity-50">
                                            {loading ? <div className="loader"></div> : <><Icon name="zap" className="h-5 w-5" /> GENERATE FINAL ROUTES</>}
                                        </button>
                                        {error && <p className="text-xs text-red-500 mt-2 text-center">{error}</p>}
                                    </div>
                                </div>

                                {/* RIGHT PANEL: MAP */}
                                <div className="col-span-12 lg:col-span-8 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative">
                                    <GlobalMapView routes={zoneMapData} baseAddress={baseAddress} />
                                    {optimizedStops && (
                                        <div className="absolute top-4 right-4 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold border border-blue-200 shadow-sm flex items-center gap-2">
                                            <Icon name="check-circle" className="h-4 w-4" /> Stops Optimized for Planning
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'input' && (
                            <div className="grid lg:grid-cols-12 gap-8 animate-fade-in">
                                <div className="lg:col-span-7 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow relative z-20">
                                            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><div className="bg-ess-green/10 p-2 rounded-full"><Icon name="plus" className="h-5 w-5 text-ess-green" /></div> Add Stop</h2>
                                            <div className="grid md:grid-cols-2 gap-4 mb-4">
                                                <div className="relative">
                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Client</label>
                                                    <input ref={mainClientInputRef} type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Name" value={newStopName} onChange={(e) => { setNewStopName(e.target.value); setShowSuggestions(true); setActiveSuggestionIndex(-1); }} onKeyDown={handleClientKeyDown} />
                                                    {showSuggestions && filteredClients.length > 0 && <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 overflow-hidden z-50">{filteredClients.map((c, i) => (<div key={i} onClick={() => selectClient(c)} className={`p-3 cursor-pointer border-b border-slate-50 ${i === activeSuggestionIndex ? 'bg-blue-100' : 'hover:bg-blue-50'}`}><div className="font-bold text-slate-700 text-sm">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}
                                                </div>
                                                <div className="relative">
                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Address</label>
                                                    {/* INPUT DE DIRECCI√ìN MODIFICADO: Al dar Enter, salta al invisible, NO al Next */}
                                                    <GoogleAddressInput 
                                                        value={newStopAddress} 
                                                        onChange={(e) => { setNewStopAddress(e.target.value); setShowAddressSuggestions(true); }} 
                                                        onKeyDown={(e) => handleEnter(e, () => invisibleAddressInputRef.current?.focus())} 
                                                        className="w-full p-3 border border-slate-300 rounded-lg outline-none" 
                                                        placeholder="Search Google Maps" 
                                                        disabled={!scriptLoaded} 
                                                        isLoaded={scriptLoaded} 
                                                    />
                                                    
                                                    {/* CAMPO INVISIBLE (STOP) */}
                                                    <input 
                                                        ref={invisibleAddressInputRef} 
                                                        className="absolute opacity-0 w-1 h-1 -z-10 bottom-0 right-0 pointer-events-none" 
                                                        onKeyDown={(e) => handleEnter(e, initiateAddStop)} 
                                                        tabIndex="-1" 
                                                        autoComplete="off"
                                                    />

                                                    {showAddressSuggestions && filteredClientsByAddress.length > 0 && <div className="absolute w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 z-50 bottom-full mb-1"><div className="bg-ess-blue text-white text-xs font-bold px-2 py-1">üëá Saved Clients</div>{filteredClientsByAddress.map((c, i) => (<div key={i} onClick={() => { selectClient(c); setTempStopData({name: c.name, address: c.address}); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm"><div className="font-bold text-slate-700">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}
                                                </div>
                                            </div>
                                            <div className="flex justify-end"><button onClick={initiateAddStop} disabled={!newStopAddress} className="bg-ess-blue text-white px-6 py-2.5 rounded-lg font-bold shadow-md flex items-center gap-2 disabled:opacity-50"><Icon name="arrow-right" className="h-4 w-4" /> Next</button></div>
                                    </div>

                                    <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden min-h-[300px]">
                                            <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="list" className="h-5 w-5 text-slate-400" /> Today's Route</h3>
                                                    {/* NEW HISTORY BUTTON */}
                                                    <button onClick={() => setShowHistoryModal(true)} className="text-xs bg-slate-100 text-slate-600 hover:text-ess-blue px-2 py-1 rounded-lg border border-slate-200 flex items-center gap-1 ml-2 transition-colors shadow-sm" title="View History"><Icon name="clock" className="h-3 w-3" /> History</button>
                                                </div>
                                                <div className="flex items-center gap-2">{currentStops.length > 0 && <button onClick={clearDraftRoute} className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 flex items-center gap-1"><Icon name="eraser" className="h-3 w-3" /> Clear</button>}<span className="bg-ess-blue text-white text-xs font-bold px-2 py-1 rounded-full">{currentStops.length} Stops</span></div>
                                            </div>
                                            <div className="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">
                                                {currentStops.map((stop, idx) => (
                                                    <div key={stop.id} className="p-4 flex items-center gap-4 hover:bg-slate-50 group">
                                                        <div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold text-sm border border-slate-200">{idx + 1}</div>
                                                        <div className="flex-1">
                                                            <h4 className="font-bold text-slate-800">{stop.name}</h4>
                                                            <p className="text-sm text-slate-500 flex items-center gap-1"><Icon name="map-pin" className="h-3 w-3" /> {stop.address}</p>
                                                            {(stop.invoices || stop.pieces) && <div className="flex gap-3 mt-1 text-xs font-mono text-slate-500 bg-slate-100 inline-block px-2 py-1 rounded"><span>Inv: {stop.invoices || '-'}</span><span>Pcs: {stop.pieces || '-'}</span></div>}
                                                        </div>
                                                        <div className="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={() => startEditDraft(stop)} className="p-2 text-slate-300 hover:text-ess-blue hover:bg-blue-50 rounded-lg transition-colors"><Icon name="pencil" className="h-4 w-4" /></button>
                                                            <button onClick={() => removeStop(stop.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Icon name="trash-2" className="h-4 w-4" /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                    </div>
                                </div>

                                <div className="lg:col-span-5 space-y-6">
                                    <div className="bg-ess-light px-4 py-2 rounded-lg border border-blue-100 flex items-center gap-2"><Icon name="map-pin" className="h-5 w-5 text-ess-blue shrink-0" /><div className="text-xs w-full"><span className="block text-slate-400 font-semibold uppercase">Base (Start/End)</span><GoogleAddressInput value={baseAddress} onChange={handleBaseAddressChange} className="bg-transparent font-bold text-slate-700 outline-none w-full" placeholder="Warehouse" disabled={!scriptLoaded} isLoaded={scriptLoaded} /></div></div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow"><h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-3 border-b border-slate-100"><Icon name="users" className="h-5 w-5 text-ess-blue" /> Drivers</h3><div className="flex gap-2 mb-4"><input type="text" className="flex-1 p-2 border border-slate-300 rounded-lg text-sm outline-none" placeholder="Name..." value={newDriverName} onChange={(e) => setNewDriverName(e.target.value)} onKeyDown={(e) => handleEnter(e, () => {if(newDriverName.trim()){ addDriverToFb(newDriverName); setNewDriverName(''); }})} /><button onClick={() => {if(newDriverName.trim()){ addDriverToFb(newDriverName); setNewDriverName(''); }}} className="bg-slate-800 text-white px-3 rounded hover:bg-slate-900"><Icon name="plus" className="h-4 w-4" /></button></div><div className="grid grid-cols-1 xl:grid-cols-2 gap-2 overflow-y-auto overflow-x-hidden">{drivers.map(driver => (<div key={driver.id} className="group relative"><label className={`flex items-center justify-between p-2 rounded-lg border cursor-pointer h-full ${driver.active ? 'border-ess-green/50 bg-green-50/30' : 'border-slate-100 bg-slate-50 opacity-60'}`}><div className="flex items-center gap-2 min-w-0"><div className={`w-2 h-2 shrink-0 rounded-full ${driver.active ? 'bg-ess-green' : 'bg-slate-300'}`}></div><span className={`font-medium text-sm truncate ${driver.active ? 'text-slate-800' : 'text-slate-500'}`}>{driver.name}</span></div><input type="checkbox" checked={driver.active} onChange={() => toggleDriver(driver.id, driver.active)} className="w-4 h-4 accent-ess-green shrink-0 ml-2" /></label><button onClick={(e) => { e.preventDefault(); deleteDriver(driver.id); }} className="absolute -right-1 -top-1 bg-white text-slate-400 hover:text-red-500 border border-slate-200 rounded-full p-0.5 opacity-0 group-hover:opacity-100 shadow-sm z-10"><Icon name="x" className="h-3 w-3" /></button></div>))}</div></div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow sticky top-24">
                                        {error && <div className="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg border border-red-200">{error}</div>}
                                        {!loading && routes && (<>
                                            <p className="text-xs text-center text-slate-500 mb-1">Previous routes found</p>
                                            <button onClick={() => setView('results')} className="w-full bg-white border-2 border-ess-green text-ess-green hover:bg-green-50 py-3 rounded-xl font-bold text-sm shadow mb-3 transition-all flex justify-center items-center gap-2"><Icon name="map" className="h-5 w-5" /> GO TO RESULTS</button>
                                        </>)}
                                        {/* CHANGED: TO USE handlePlanZones */}
                                        <button onClick={handlePlanZones} disabled={currentStops.length === 0} className="w-full bg-slate-800 hover:bg-black text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-slate-900/20 transition-all flex justify-center items-center gap-2 disabled:opacity-75">
                                            {loading ? <div className="loader"></div> : <><Icon name="map" className="h-6 w-6" /> PLAN ZONES & MAP</>}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'results' && routes && (
                            <div className="animate-fade-in space-y-4 relative h-full flex flex-col">
                                {/* TOP CONTROLS */}
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm shrink-0">
                                     <div className="flex gap-2">
                                        {/* Back now goes to Planning if we came from there, or Input */}
                                        <button onClick={() => { setView('zone_planning'); }} className="text-slate-600 hover:text-ess-blue px-4 py-2 rounded-lg font-bold border border-slate-200 flex items-center gap-2 text-sm"><Icon name="arrow-left" className="h-4 w-4" /> Back to Planning</button>
                                        <button onClick={handleAddRoute} className="text-xs font-bold text-white bg-ess-blue hover:bg-sky-700 px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="plus" className="h-3 w-3" /> Add Route</button>
                                     </div>
                                     <div className="flex gap-2">
                                          {/* SAVE BUTTON */}
                                          <button onClick={handleSaveRoute} className="text-xs font-bold text-white bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm">
                                             <Icon name="save" className="h-3 w-3" /> Save Route
                                          </button>
                                          <button onClick={handleRestore} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 hover:text-ess-blue px-3 py-2 rounded-lg flex items-center gap-2"><Icon name="rotate-ccw" className="h-3 w-3" /> Reset</button>
                                          <button onClick={() => setView('global_map')} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 hover:text-ess-blue px-3 py-2 rounded-lg flex items-center gap-2"><Icon name="map" className="h-3 w-3" /> Map</button>
                                          <button onClick={handleGlobalPrint} className="text-xs font-bold text-white bg-slate-800 hover:bg-black px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="printer" className="h-3 w-3" /> Print All</button>
                                          {/* Update disabled here as logic is different */}
                                     </div>
                                </div>

                                {/* ZONES CONTAINER (VERTICAL STACK) */}
                                <div ref={resultsContainerRef} onDragOver={handleResultsDragOver} className="flex-1 overflow-y-auto pb-20"> 
                                    <div className="flex flex-col gap-8 px-2"> 
                                        
                                        {/* 1. Generar lista combinada: Unassigned + Zones creadas */}
                                        {[null, ...zones].map((zone, zIdx) => {
                                            const zoneId = zone ? zone.id : 'unassigned';
                                            const zoneName = zone ? zone.name : 'UNASSIGNED';
                                            
                                            // FIX: Obtener lista de Zonas Validas para detectar hu√©rfanos
                                            const validZoneIds = zones.map(z => z.id);

                                            // Filtrar drivers que pertenecen a esta zona
                                            const driversInZone = Object.entries(routes).filter(([dName, _]) => {
                                                const assignedId = zoneAssignments[dName];
                                                
                                                // Si estamos en UNASSIGNED (zone === null)
                                                if (zone === null) {
                                                    // Mostrar si NO tiene asignaci√≥n O si la asignaci√≥n es inv√°lida (zona borrada)
                                                    return !assignedId || !validZoneIds.includes(assignedId);
                                                }
                                                
                                                // Si estamos en una Zona espec√≠fica, mostrar solo si coincide ID
                                                return assignedId === zone.id;
                                            });

                                            // Determine Label Color
                                            const headerColorClass = zone ? COMPANY_PALETTE[(zIdx - 1) % COMPANY_PALETTE.length].tw : 'bg-slate-600 text-white';

                                            return (
                                                <div 
                                                    key={zoneId}
                                                    onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; }}
                                                    onDrop={(e) => {
                                                        e.preventDefault();
                                                        if (draggedDriver) {
                                                            assignDriverToZone(draggedDriver, zone ? zone.id : null);
                                                            setDraggedDriver(null);
                                                        }
                                                    }}
                                                    className={`w-full rounded-xl transition-all ${draggedDriver ? 'bg-slate-50 border-2 border-dashed border-slate-300' : 'bg-transparent'}`}
                                                >
                                                    {/* ZONE HEADER */}
                                                    <div className={`p-3 rounded-lg font-bold text-sm flex justify-between items-center mb-4 shadow-sm ${headerColorClass}`}>
                                                        <span className="tracking-wide">{zoneName}</span>
                                                        <span className="bg-white/20 px-3 py-0.5 rounded-full text-xs font-bold text-white">{driversInZone.length}</span>
                                                    </div>

                                                    {/* DRIVER CARDS GRID (RESPONSIVE) */}
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 px-1">
                                                        {driversInZone.map(([driverName, data]) => (
                                                            <div 
                                                                key={driverName}
                                                                draggable="true"
                                                                onDragStart={(e) => {
                                                                    // IMPORTANTE: Evitar conflicto con el drag de paradas internas
                                                                    if (e.target.closest('.stop-item')) return; 
                                                                    setDraggedDriver(driverName);
                                                                    e.dataTransfer.effectAllowed = "move";
                                                                    e.target.style.opacity = '0.5';
                                                                }}
                                                                onDragEnd={(e) => {
                                                                    e.target.style.opacity = '1';
                                                                    setDraggedDriver(null);
                                                                }}
                                                                className={`bg-white rounded-xl border border-slate-200 card-shadow flex flex-col overflow-hidden relative group transition-all ${draggedDriver === driverName ? 'rotate-3 scale-95 opacity-50' : 'hover:border-ess-blue hover:shadow-md'}`}
                                                                onDragOver={(e) => handleDragOverContainer(e, driverName)} 
                                                                onDrop={(e) => {
                                                                    e.stopPropagation(); // Evitar que burbujee a la zona
                                                                    handleDrop(e, driverName);
                                                                }}
                                                            >
                                                                {/* CONTAINER SUPERIOR DERECHA: RECALCULAR + CHECKBOX */}
                                                                <div className="absolute top-2 right-2 z-20 flex items-center gap-2">
                                                                    {/* BOT√ìN DE REC√ÅLCULO MANUAL (NUEVO) */}
                                                                    <button 
                                                                        onClick={(e) => {
                                                                            e.stopPropagation(); // Evitar drag
                                                                            recalculateRoute(driverName, data.paradas);
                                                                        }}
                                                                        className="bg-white text-ess-blue p-1 rounded-full shadow-sm border border-slate-200 hover:bg-blue-50 transition-colors"
                                                                        title="Recalculate Route"
                                                                    >
                                                                        {recalculating[driverName] ? <div className="loader w-3 h-3 border-2"></div> : <Icon name="refresh-cw" className="h-4 w-4" />}
                                                                    </button>

                                                                    <input 
                                                                        type="checkbox" 
                                                                        className="w-5 h-5 accent-ess-blue cursor-pointer shadow-sm border-2 border-white rounded"
                                                                        checked={selectedDriversForZone.includes(driverName)}
                                                                        onChange={(e) => {
                                                                            if(e.target.checked) setSelectedDriversForZone(prev => [...prev, driverName]);
                                                                            else setSelectedDriversForZone(prev => prev.filter(n => n !== driverName));
                                                                        }}
                                                                    />
                                                                </div>

                                                                {/* --- CONTENIDO ORIGINAL DE LA TARJETA (SIN CAMBIOS DE DISE√ëO) --- */}
                                                                <div className="bg-slate-50 p-5 border-b border-slate-100">
                                                                    <div className="flex justify-between items-center mb-4 relative pr-6"> {/* pr-6 para dejar espacio al checkbox */}
                                                                        <h3 className="font-bold text-xl text-slate-800 flex items-center gap-3">
                                                                            <div className="bg-white p-2 rounded-lg border border-slate-200 shadow-sm"><Icon name="user" className="h-5 w-5 text-ess-blue" /></div> {driverName}
                                                                                <button onClick={() => initiateManualStop(driverName)} className="bg-green-100 hover:bg-green-200 text-green-700 p-1.5 rounded-full transition-colors shadow-sm ml-2" title="Add Stop Manually"><Icon name="plus" className="h-4 w-4" /></button>
                                                                                
                                                                                {/* SWAP BUTTON RESTORED */}
                                                                                <button onClick={() => setSwappingDriver(swappingDriver === driverName ? null : driverName)} className="text-slate-400 hover:text-ess-blue p-1.5 rounded hover:bg-blue-50 transition-colors ml-1" title="Swap Driver Route">
                                                                                    <Icon name="arrow-left-right" className="h-4 w-4" />
                                                                                </button>
                                                                        </h3>
                                                                        {/* SWAP DROPDOWN */}
                                                                        {swappingDriver === driverName && (
                                                                            <div className="absolute top-12 left-0 bg-white border border-slate-200 shadow-xl rounded-lg z-50 p-2 w-56 animate-fade-in">
                                                                                <p className="text-xs font-bold text-slate-500 mb-2 px-2 uppercase">Swap route with:</p>
                                                                                {Object.keys(routes).filter(d => d !== driverName).map(otherDriver => (
                                                                                    <button key={otherDriver} onClick={() => handleSwapDriver(driverName, otherDriver)} className="w-full text-left px-3 py-2 hover:bg-blue-50 rounded text-sm text-slate-700 flex items-center gap-2 transition-colors">
                                                                                        <div className="w-2 h-2 rounded-full bg-ess-green"></div>
                                                                                        <span className="truncate">{otherDriver}</span>
                                                                                    </button>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <div className="grid grid-cols-2 gap-2 text-xs text-slate-500">
                                                                        <div className="bg-white p-2 rounded border border-slate-100 flex items-center gap-2">{recalculating[driverName] ? <span className="text-ess-blue font-bold">Updating...</span> : <><Icon name="clock" className="h-4 w-4 text-ess-green" /> {Math.floor(data.duracion_estimada / 60)}h {Math.round(data.duracion_estimada % 60)}m</>}</div>
                                                                        <div className="flex gap-1 justify-end">
                                                                            <button onClick={() => reverseRoute(driverName)} className="bg-white hover:bg-blue-50 text-slate-600 p-1.5 rounded border border-slate-200" title="Reverse"><Icon name="arrow-up-down" className="h-4 w-4" /></button>
                                                                            <button onClick={() => handleOptimizeRemaining(driverName)} className="bg-white hover:bg-purple-50 text-slate-600 hover:text-purple-600 p-1.5 rounded border border-slate-200 font-bold" title="Optimize"><Icon name="wand-2" className="h-4 w-4" /></button>
                                                                            <button onClick={() => openPrintModal(driverName, data.paradas)} className="bg-slate-800 text-white p-1.5 rounded border border-slate-900 hover:bg-black" title="Print Sheet"><Icon name="printer" className="h-4 w-4" /></button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="p-0 flex-1 overflow-y-auto max-h-[400px]">
                                                                    <ul className="divide-y divide-slate-100 min-h-[50px]">
                                                                        {data.paradas.map((stop, index) => (
                                                                            <li key={index} className={`stop-item relative pr-8 p-4 hover:bg-slate-50 transition-colors flex gap-3 group items-start cursor-grab active:cursor-grabbing ${selectedStops.find(s => s.driver === driverName && s.index === index) ? 'bg-blue-50' : ''}`} draggable="true" onDragStart={(e) => { e.stopPropagation(); handleDragStart(e, driverName, index); }} onDragEnd={(e) => { e.stopPropagation(); handleDragEnd(e); }} onDrop={(e) => { e.stopPropagation(); handleDrop(e, driverName, index); }} onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}>
                                                                                <div className="pt-1" onMouseDown={(e) => e.stopPropagation()}><input type="checkbox" className="custom-checkbox" checked={!!selectedStops.find(s => s.driver === driverName && s.index === index)} onChange={() => toggleStopSelection(driverName, index)} /></div>
                                                                                <div className="flex flex-col items-center gap-1 pt-1"><span className="flex-shrink-0 w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold flex items-center justify-center border border-slate-200">{index + 1}</span></div>
                                                                                <div className="flex-1"><div className="font-bold text-sm text-slate-800">{getClientNameFromAddress(stop.direccion)}</div><div className="text-xs text-slate-500 mt-0.5">{stop.direccion}</div>{(stop.invoices || stop.pieces) && <div className="mt-1 flex gap-2"><span className="bg-yellow-50 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded border border-yellow-200 font-mono">INV: {stop.invoices}</span><span className="bg-blue-50 text-blue-700 text-[10px] px-1.5 py-0.5 rounded border border-blue-200 font-mono">PCS: {stop.pieces}</span></div>}</div>
                                                                                <div className="absolute right-2 top-2 bottom-2 flex flex-col justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onMouseDown={(e) => e.stopPropagation()}>
                                                                                    <div className="flex gap-1 justify-end"><button onClick={() => openEditStopModal(driverName, index, stop)} className="p-0.5 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded"><Icon name="pencil" className="h-3.5 w-3.5" /></button><button onClick={() => deleteStopFromRoute(driverName, index)} className="p-0.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"><Icon name="trash-2" className="h-3.5 w-3.5" /></button></div>
                                                                                    <div className="flex gap-1 justify-end"><button onClick={() => moveStop(driverName, index, -1)} disabled={index === 0} className="p-0.5 text-slate-400 hover:text-ess-blue disabled:opacity-20"><Icon name="chevron-up" className="h-3.5 w-3.5" /></button><button onClick={() => moveStop(driverName, index, 1)} disabled={index === data.paradas.length - 1} className="p-0.5 text-slate-400 hover:text-ess-blue disabled:opacity-20"><Icon name="chevron-down" className="h-3.5 w-3.5" /></button></div>
                                                                                </div>
                                                                            </li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                                <div className="p-5 border-t border-slate-100 bg-slate-50/50 flex gap-2">
                                                                    <button onClick={(e) => { e.stopPropagation(); openDriverMap(driverName, data); }} className="flex-1 bg-white border border-slate-200 text-slate-700 hover:border-ess-blue font-bold py-2.5 rounded-lg flex justify-center items-center gap-2 text-sm shadow-sm transition-colors"><Icon name="map" className="h-4 w-4" /> Map</button>
                                                                    <a href={data.link} target="_blank" rel="noreferrer" className="px-4 bg-white border border-slate-200 text-slate-700 hover:border-ess-blue hover:text-ess-blue font-bold py-2.5 rounded-lg flex justify-center items-center gap-2 text-sm shadow-sm transition-colors"><Icon name="send" className="h-4 w-4" /></a>
                                                                    <a href={getWhatsappLink(data.link)} target="_blank" rel="noreferrer" className="px-4 bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-2.5 rounded-lg flex justify-center items-center gap-2 text-sm shadow-sm transition-colors"><Icon name="message-circle" className="h-4 w-4" /></a>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* FLOATING BAR FOR SELECTED DRIVERS (ZONES) */}
                                {selectedDriversForZone.length > 0 && (
                                    <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white p-4 rounded-2xl shadow-2xl z-50 flex flex-col md:flex-row items-center gap-4 animate-fade-in border border-slate-700">
                                            <div className="flex items-center gap-2">
                                                <span className="bg-ess-blue text-white text-xs font-bold px-2 py-1 rounded-full">{selectedDriversForZone.length}</span>
                                                <span className="font-bold text-sm">Drivers Selected</span>
                                            </div>
                                            <div className="flex flex-wrap justify-center gap-2">
                                                <span className="text-xs text-slate-400 self-center uppercase font-bold mr-1">Move to:</span>
                                                <button onClick={() => moveSelectedDriversToZone(null)} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs font-bold transition-colors border border-slate-600">UNASSIGNED</button>
                                                {zones.map(z => (
                                                    <button key={z.id} onClick={() => moveSelectedDriversToZone(z.id)} className="px-3 py-1.5 bg-slate-700 hover:bg-ess-blue rounded-lg text-xs font-bold transition-colors border border-slate-600 hover:border-ess-blue">
                                                        {z.name}
                                                    </button>
                                                ))}
                                            </div>
                                            <button onClick={() => setSelectedDriversForZone([])} className="ml-2 text-slate-400 hover:text-white p-1 hover:bg-slate-700 rounded-full transition-colors">
                                                <Icon name="x" className="h-5 w-5" />
                                            </button>
                                    </div>
                                )}

                                {/* MANTENEMOS EL FLOATING BAR DE STOPS SI EXISTE (Solo mostrar uno a la vez o apilar) */}
                                {selectedStops.length > 0 && selectedDriversForZone.length === 0 && (
                                    <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white p-4 rounded-2xl shadow-2xl z-50 flex items-center gap-4 animate-fade-in border border-slate-700">
                                            <div className="flex items-center gap-2"><span className="bg-ess-blue text-white text-xs font-bold px-2 py-1 rounded-full">{selectedStops.length}</span><span className="font-bold text-sm">Stops</span></div>
                                            <div className="h-6 w-px bg-slate-600"></div>
                                            <div className="flex gap-2"><span className="text-xs text-slate-400 self-center uppercase font-bold mr-1">Move to:</span>{Object.keys(routes).map(driver => (<button key={driver} onClick={() => transferSelectedStops(driver)} className="px-3 py-1.5 bg-slate-700 hover:bg-ess-blue rounded-lg text-xs font-bold transition-colors border border-slate-600 hover:border-ess-blue">{driver}</button>))}</div>
                                            <button onClick={() => setSelectedStops([])} className="ml-2 text-slate-400 hover:text-white p-1 hover:bg-slate-700 rounded-full transition-colors"><Icon name="x" className="h-5 w-5" /></button>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
