<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Sign Supply Route Planner (Demo Mode)</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.initializeFirebaseGlobally = (config) => {
            try {
                if (!config || !config.apiKey || config.apiKey.includes("Pega_aqu√≠")) return false;
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                window.fbSendPasswordResetEmail = sendPasswordResetEmail;
                window.fbUpdatePassword = updatePassword;
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbSetDoc = setDoc; 
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                window.fbGetDocs = getDocs;
                window.fbLimit = limit;
                
                window.firebaseReady = true; 
                return true;
            } catch (e) {
                console.error("Firebase Init Error:", e);
                return false;
            }
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ess: { blue: '#1b6e9b', green: '#6bbf5d', dark: '#0f4c6e', light: '#f0f9ff' } } }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .pac-container { z-index: 99999 !important; border-radius: 8px; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; font-family: 'Inter', sans-serif; max-width: 90vw !important; white-space: normal !important; }
        .pac-item { padding: 10px 12px; cursor: pointer; font-size: 14px; white-space: normal !important; }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        
        .draggable-source { opacity: 0.4; border: 2px dashed #cbd5e1; background: #f1f5f9; }
        .drop-target { background-color: #eff6ff; border: 2px dashed #1b6e9b; }
        .zone-target { border: 2px dashed #cbd5e1; background-color: #f8fafc; transition: all 0.2s; }
        .zone-target.drag-over { border-color: #1b6e9b; background-color: #eff6ff; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-checkbox { width: 20px; height: 20px; accent-color: #1b6e9b; cursor: pointer; }

        @media print {
            @page { size: portrait; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-sheet, #printable-sheet *, #global-manifest, #global-manifest * { visibility: visible; }
            #printable-sheet, #global-manifest { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const MANUAL_GOOGLE_API_KEY = ""; 

        const MOCK_DB = {
            clients: [
                { id: '1', name: 'Javier Graphics', address: '123 Orange Ave, Orlando, FL' },
                { id: '2', name: 'Sign World', address: '456 Magnolia Dr, Orlando, FL' },
                { id: '3', name: 'Print Masters', address: '789 Colonial Dr, Orlando, FL' }
            ],
            drivers: [
                { id: 'd1', name: 'Carlos', active: true },
                { id: 'd2', name: 'Miguel', active: true },
                { id: 'd3', name: 'Jose', active: true }
            ],
            vehicles: [
                { id: 'v1', name: 'Van 1 (Ford Transit)' },
                { id: 'v2', name: 'Truck 2 (Isuzu)' }
            ],
            stops: [
                { id: 's1', name: 'Javier Graphics', address: '123 Orange Ave, Orlando, FL', invoices: '1001', pieces: '2' },
                { id: 's2', name: 'Sign World', address: '456 Magnolia Dr, Orlando, FL', invoices: '1002', pieces: '5' }
            ],
            zones: [] // Zonas vac√≠as por defecto
        };

        // ... [CONFIG ERROR SCREEN, LOGIN SCREEN, ICON] ...
        const ConfigErrorScreen = ({ errorDetails }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border-l-4 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="h-8 w-8" /> Error</h1>
                    <p className="text-slate-600 mb-4">{errorDetails}</p>
                    <button onClick={() => window.location.reload()} className="mt-4 w-full bg-slate-800 text-white py-2 rounded font-bold">Retry</button>
                </div>
            </div>
        );

        const LoginScreen = ({ onLoginSuccess, isDemo }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true);
                if (isDemo) { setTimeout(() => { onLoginSuccess({ email: email || 'demo@user.com', uid: 'demo-uid' }); }, 800); } 
                else { if (!window.fbSignIn) return; try { await window.fbSignIn(window.fbAuth, email, password); } catch (err) { console.error(err); alert("Login failed"); setLoading(false); } }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8"><h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>{isDemo && <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold">MODO DEMO</span>}</div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" className="w-full p-3 border rounded-lg" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email" />
                            <input type="password" className="w-full p-3 border rounded-lg" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" />
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold">{loading ? "Cargando..." : "Ingresar"}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => { if (typeof lucide === 'undefined') return; const i = lucide.icons[name.split('-').map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join('')] || lucide.icons[name]; if (i) { const e = lucide.createElement(i); e.setAttribute('class', className); setSvgHtml(e.outerHTML); } }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        // --- GOOGLE INPUT ---
        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded, onKeyDown, inputRef: propInputRef }) => {
            const innerRef = useRef(null);
            const inputRef = propInputRef || innerRef;
            const onChangeRef = useRef(onChange);
            const usedArrowsRef = useRef(false);
            useEffect(() => { onChangeRef.current = onChange; }, [onChange]);
            useEffect(() => {
                if (!isLoaded || !window.google) return;
                const attemptInitialization = () => {
                    if (!window.google || !window.google.maps || !window.google.maps.places) { setTimeout(attemptInitialization, 300); return; }
                    if (!inputRef.current) return;
                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, { types: ['geocode', 'establishment'], componentRestrictions: { country: "us" }, fields: ['formatted_address', 'name', 'geometry'] });
                        autocomplete.addListener("place_changed", () => { const place = autocomplete.getPlace(); const address = place.formatted_address || place.name; if (address) { onChangeRef.current({ target: { value: address } }); } });
                    } catch (e) { setTimeout(attemptInitialization, 500); }
                };
                attemptInitialization();
            }, [isLoaded]);
            const handleInputKeyDown = (e) => { 
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { usedArrowsRef.current = true; return; }
                if (e.key === 'Enter') { if (usedArrowsRef.current) { usedArrowsRef.current = false; e.preventDefault(); e.stopPropagation(); return; } const s = document.querySelector('.pac-item-selected'); if (s) { e.preventDefault(); return; } } else { usedArrowsRef.current = false; }
                if (onKeyDown) onKeyDown(e); 
            };
            return <input ref={inputRef} type="text" value={value} onChange={onChange} onKeyDown={handleInputKeyDown} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        // ... [MAPA, PRINTABLE SHEET] ...
        const GlobalMapView = ({ routes, baseAddress }) => {
            const mapRef = useRef(null);
            useEffect(() => { if (!window.google || !mapRef.current) return; new window.google.maps.Map(mapRef.current, { zoom: 10, center: { lat: 28.5383, lng: -81.3792 } }); }, []);
            return <div className="w-full h-full flex flex-col"><div className="flex-1 min-h-[400px]"><div ref={mapRef} className="w-full h-full rounded-xl bg-slate-100 flex items-center justify-center text-slate-400">Map View (Requires Valid API Key)</div></div></div>;
        };

        const PrintableSheet = ({ routeData, driverName, vehicle, config }) => {
            const today = new Date();
            return (
                <div id="printable-sheet" className="hidden print:block bg-white text-black p-4 font-sans text-sm">
                    <div className="flex justify-between items-start mb-6 border-b-2 border-black pb-4"><div className="flex items-center gap-4"><h1>Route Manifest</h1></div><div className="text-right"><div>Driver: {driverName}</div><div>Date: {today.toLocaleDateString()}</div></div></div>
                    <table className="w-full border-collapse border border-black mb-4"><thead><tr className="bg-white"><th className="border border-black p-1">#</th><th className="border border-black p-2">Customer</th><th className="border border-black p-2">Address</th></tr></thead><tbody>{routeData.map((s, i) => <tr key={i}><td className="border border-black p-1">{i+1}</td><td className="border border-black p-2">{s.nombre}</td><td className="border border-black p-2">{s.direccion}</td></tr>)}</tbody></table>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            // Estado General
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [dbReady, setDbReady] = useState(false);
            const [systemError, setSystemError] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(false);

            // Datos
            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [zones, setZones] = useState([]); // ZONAS
            const [driverZones, setDriverZones] = useState({}); // Mapa driver -> zona
            
            const [googleApiKey, setGoogleApiKey] = useState(MANUAL_GOOGLE_API_KEY);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            const [view, setView] = useState('input'); 
            
            // Config
            const [baseAddress, setBaseAddress] = useState('8350 Parkline Blvd, Orlando, FL');
            const [dwellTime, setDwellTime] = useState(6);
            const [companyConfig, setCompanyConfig] = useState({ companyName: "Demo Company", phone: "555-0199", address: "Orlando, FL" });
            const [savedPin, setSavedPin] = useState('0000'); 

            // Rutas y Estado
            const [currentStops, setCurrentStops] = useState([]);
            const [routes, setRoutes] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            // UI Inputs
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [newDriverName, setNewDriverName] = useState('');
            const [newVehicleName, setNewVehicleName] = useState(''); 
            const [newZoneName, setNewZoneName] = useState('');
            const [clientFormName, setClientFormName] = useState('');
            const [clientFormAddress, setClientFormAddress] = useState('');

            // Modales y Visibilidad
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAddressSuggestions, setShowAddressSuggestions] = useState(false); 
            const [showClientDbAddressSuggestions, setShowClientDbAddressSuggestions] = useState(false);
            const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(-1); 
            const [showAddDetailsModal, setShowAddDetailsModal] = useState(false); 
            const [tempStopData, setTempStopData] = useState(null);
            const [tempInvoices, setTempInvoices] = useState('');
            const [tempPieces, setTempPieces] = useState('');
            const [showAddRouteModal, setShowAddRouteModal] = useState(false);
            const [showManualStopModal, setShowManualStopModal] = useState(false);
            const [targetDriverForManual, setTargetDriverForManual] = useState(null);
            const [showPinModal, setShowPinModal] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [pendingView, setPendingView] = useState('');
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [printData, setPrintData] = useState(null); 
            const [showGlobalPrint, setShowGlobalPrint] = useState(false); 
            const [selectedVehicleForPrint, setSelectedVehicleForPrint] = useState('');
            const [settingsMsg, setSettingsMsg] = useState('');
            const [newPin, setNewPin] = useState('');
            
            // Drag and Drop y Edici√≥n
            const [editingClientId, setEditingClientId] = useState(null);
            const [selectedStops, setSelectedStops] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null); // { type: 'stop'|'driver', ...data }
            const [dragOverDriver, setDragOverDriver] = useState(null); // Para paradas
            const [dragOverZone, setDragOverZone] = useState(null); // Para zonas
            const [swappingDriver, setSwappingDriver] = useState(null);
            const [assigningZoneForDriver, setAssigningZoneForDriver] = useState(null); // Driver ID para el modal/men√∫ de zona
            
            const [isRecalculatingAll, setIsRecalculatingAll] = useState(false);
            const [editingStop, setEditingStop] = useState(null);
            const [editingDraftId, setEditingDraftId] = useState(null);
            const [viewingDriver, setViewingDriver] = useState(null);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [historyData, setHistoryData] = useState([]);

            const clientInputRef = useRef(null);
            const piecesInputRef = useRef(null);
            const mainClientInputRef = useRef(null); 
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const getUserCollection = (collName) => user ? window.fbCollection(window.fbDb, 'artifacts', appId, 'users', user.uid, collName) : null;
            const getUserDocRef = (collName, docId) => user ? window.fbDoc(window.fbDb, 'artifacts', appId, 'users', user.uid, collName, docId) : null;

            // --- INICIALIZACI√ìN ---
            useEffect(() => {
                const initApp = async () => {
                    try {
                        const response = await fetch('/config');
                        if (!response.ok) throw new Error("No backend");
                        const data = await response.json();
                        if (data.firebaseConfig) { window.initializeFirebaseGlobally(data.firebaseConfig); setDbReady(true); }
                        if (data.googleApiKey) setGoogleApiKey(data.googleApiKey);
                    } catch (err) {
                        setIsDemoMode(true); setDbReady(true); setAuthLoading(false);
                        setClientDB(MOCK_DB.clients); setDrivers(MOCK_DB.drivers); setVehicles(MOCK_DB.vehicles); setCurrentStops(MOCK_DB.stops); setZones(MOCK_DB.zones);
                        setHistoryData([{ id: 'h1', timestamp: Date.now(), stops: MOCK_DB.stops }]);
                    }
                };
                initApp();
            }, []);

            // Auth & Listeners
            useEffect(() => { if (!isDemoMode && window.fbOnAuthStateChanged) window.fbOnAuthStateChanged(window.fbAuth, (u) => { setUser(u); setAuthLoading(false); }); }, [isDemoMode]);
            useEffect(() => {
                if (!user || !window.fbDb || !dbReady) return;
                // Listeners originales
                window.fbOnSnapshot(window.fbQuery(getUserCollection("clients"), window.fbOrderBy("name")), (s) => setClientDB(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("drivers"), window.fbOrderBy("name")), (s) => setDrivers(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("draft_stops"), window.fbOrderBy("createdAt", "desc")), (s) => setCurrentStops(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("vehicles"), window.fbOrderBy("name")), (s) => setVehicles(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                // Nuevo Listener de Zonas
                window.fbOnSnapshot(window.fbQuery(getUserCollection("zones"), window.fbOrderBy("name")), (s) => setZones(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                // Settings
                window.fbOnSnapshot(getUserDocRef("settings", "config"), (s) => { if(s.exists()) { const d=s.data(); if(d.baseAddress) setBaseAddress(d.baseAddress); if(d.companyName) setCompanyConfig(p=>({...p, companyName: d.companyName, phone: d.companyPhone, address: d.companyAddress})); if(d.adminPin) setSavedPin(d.adminPin); } });
            }, [user, dbReady]);

            useEffect(() => {
                if (!googleApiKey) return;
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&loading=async`;
                script.async = true; script.defer = true;
                script.onload = () => setTimeout(() => setScriptLoaded(true), 100);
                document.head.appendChild(script);
            }, [googleApiKey]);

            // --- ACCIONES DE DATOS ---
            const handleDemoLogin = (u) => setUser(u);
            const addDriverToFb = (name) => { if (isDemoMode) setDrivers([...drivers, { id: Date.now(), name, active: true }]); else if(window.fbDb) window.fbAddDoc(getUserCollection("drivers"), { name, active: true }); };
            const deleteDriver = (id) => { if (isDemoMode) setDrivers(drivers.filter(d => d.id !== id)); else if(window.fbDb && confirm('Delete?')) window.fbDeleteDoc(getUserDocRef("drivers", id)); };
            const toggleDriver = (id) => { if(isDemoMode) setDrivers(drivers.map(d => d.id === id ? {...d, active: !d.active} : d)); else if(window.fbDb) { const d=drivers.find(x=>x.id===id); window.fbUpdateDoc(getUserDocRef("drivers", id), {active: !d.active}); }};
            const addZoneToFb = (name) => { if (isDemoMode) setZones([...zones, { id: Date.now(), name }]); else if(window.fbDb) window.fbAddDoc(getUserCollection("zones"), { name }); };
            const deleteZone = (id) => { if (isDemoMode) setZones(zones.filter(z => z.id !== id)); else if(window.fbDb && confirm('Delete Zone?')) window.fbDeleteDoc(getUserDocRef("zones", id)); };

            // --- OPTIMIZACI√ìN Y RUTEO ---
            const handleOptimize = async () => {
                setLoading(true);
                // Si es demo, simulamos
                if (isDemoMode) {
                    setTimeout(() => {
                        const demoRoutes = {};
                        drivers.filter(d => d.active).forEach((d, i) => {
                            const myStops = currentStops.slice(i * 2, (i * 2) + 2).map(s => ({ nombre: s.name, direccion: s.address, invoices: s.invoices, pieces: s.pieces }));
                            demoRoutes[d.name] = { paradas: myStops, duracion_estimada: 120 + (i * 30), link: "https://google.com/maps" };
                        });
                        setRoutes(demoRoutes);
                        setView('results');
                        setLoading(false);
                    }, 1500);
                } else {
                    // L√≥gica Real
                    const activeDrivers = drivers.filter(d => d.active); if (currentStops.length === 0) return setError('No stops.');
                    try { 
                        const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: currentStops, num_vans: activeDrivers.length, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); 
                        const d = await res.json(); 
                        if (!res.ok) throw new Error(d.error || 'Server error.');
                        const assigned = {}; Object.keys(d).forEach((k, i) => assigned[activeDrivers[i] ? activeDrivers[i].name : k] = d[k]); 
                        setRoutes(assigned); 
                        setView('results'); 
                    } catch (e) { setError(e.message); } finally { setLoading(false); } 
                }
            };

            // --- FILTRADOS ---
            const filteredClients = useMemo(() => { const t = newStopName.toLowerCase().trim(); if (!t) return []; return clientDB.filter(c => (c.name || "").toLowerCase().includes(t) || (c.address || "").toLowerCase().includes(t)).slice(0, 5); }, [newStopName, clientDB]);
            const filteredClientsByAddress = useMemo(() => { const t = newStopAddress.toLowerCase().trim(); if (!t) return []; return clientDB.filter(c => (c.address || "").toLowerCase().includes(t)).slice(0, 5); }, [newStopAddress, clientDB]);
            const suggestionsForClientDbAddress = useMemo(() => { const t = clientFormAddress.toLowerCase().trim(); if (!t) return []; return clientDB.filter(c => (c.address || "").toLowerCase().includes(t)).slice(0, 5); }, [clientFormAddress, clientDB]);
            const filteredClientDBList = useMemo(() => { 
                const nameTerm = clientFormName.toLowerCase().trim(); const addrTerm = clientFormAddress.toLowerCase().trim(); if (!nameTerm && !addrTerm) return clientDB;
                return clientDB.filter(c => (!nameTerm || (c.name || "").toLowerCase().includes(nameTerm)) && (!addrTerm || (c.address || "").toLowerCase().includes(addrTerm)));
            }, [clientFormName, clientFormAddress, clientDB]);

            // --- MANEJADORES UI INPUT ---
            const handleEnter = (e, cb) => { if (e.key === 'Enter') cb(); };
            const selectClient = (c) => { setNewStopName(c.name); setNewStopAddress(c.address); setShowSuggestions(false); };
            const initiateAddStop = () => { if (!newStopAddress) return; setTempStopData({ name: newStopName || 'Client', address: newStopAddress }); setShowAddDetailsModal(true); };
            const confirmAddStop = () => {
                const newStop = { id: Date.now(), name: tempStopData.name, address: tempStopData.address, invoices: tempInvoices, pieces: tempPieces };
                setCurrentStops([newStop, ...currentStops]);
                if (isDemoMode && !clientDB.some(c => c.name === tempStopData.name)) setClientDB([...clientDB, { id: Date.now(), name: tempStopData.name, address: tempStopData.address }]);
                setNewStopName(''); setNewStopAddress(''); setShowAddDetailsModal(false); setTimeout(() => mainClientInputRef.current?.focus(), 100);
            };
            const handleClientKeyDown = (e) => { if (showSuggestions && filteredClients.length > 0) { if (e.key === 'ArrowDown') { e.preventDefault(); setActiveSuggestionIndex(p => (p < filteredClients.length - 1 ? p + 1 : p)); } else if (e.key === 'ArrowUp') { e.preventDefault(); setActiveSuggestionIndex(p => (p > -1 ? p - 1 : -1)); } else if (e.key === 'Enter') { if (activeSuggestionIndex >= 0) { e.preventDefault(); selectClient(filteredClients[activeSuggestionIndex]); } else { handleEnter(e, initiateAddStop); } } else if (e.key === 'Escape') { setShowSuggestions(false); setActiveSuggestionIndex(-1); } } else { handleEnter(e, initiateAddStop); } };
            const handleNavClick = (v) => { if (v === 'input' || v === 'results') { setView('input'); return; } setPendingView(v); setPinInput(''); setShowPinModal(true); };
            const submitPin = () => { if (pinInput === savedPin) { setShowPinModal(false); setView(pendingView); } else alert("Incorrect PIN"); };

            // --- LOGICA DRAG & DROP UNIFICADA (DRIVER vs STOP) ---
            const handleDragStartStop = (e, driverName, stopIndex) => { 
                e.stopPropagation(); // Evitar arrastrar el driver
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') { e.preventDefault(); return; } 
                setDraggedItem({ type: 'stop', driverName, stopIndex }); 
                e.dataTransfer.effectAllowed = 'move'; 
            };
            const handleDragStartDriver = (e, driverName) => {
                setDraggedItem({ type: 'driver', driverName });
                e.dataTransfer.effectAllowed = 'move';
            };
            const handleDragEnd = () => { setDraggedItem(null); setDragOverDriver(null); setDragOverZone(null); };
            
            // Drop en un Conductor (para paradas)
            const handleDropOnDriver = (e, targetDriverName) => {
                e.preventDefault(); setDragOverDriver(null);
                if (!draggedItem || draggedItem.type !== 'stop') return;
                const sourceDriver = draggedItem.driverName; const sourceIndex = draggedItem.stopIndex;
                const newRoutes = JSON.parse(JSON.stringify(routes));
                const [movedStop] = newRoutes[sourceDriver].paradas.splice(sourceIndex, 1);
                newRoutes[targetDriverName].paradas.push(movedStop);
                setRoutes(newRoutes);
            };

            // Drop en una Zona (para conductores)
            const handleDropOnZone = (e, zoneId) => {
                e.preventDefault(); setDragOverZone(null);
                if (!draggedItem || draggedItem.type !== 'driver') return;
                // Asignar zona
                setDriverZones(prev => ({ ...prev, [draggedItem.driverName]: zoneId }));
            };
            
            // Eliminar de zona (volver a "Sin Asignar")
            const handleRemoveFromZone = (driverName) => {
                const newZones = { ...driverZones };
                delete newZones[driverName];
                setDriverZones(newZones);
            };

            // Helpers de renderizado para Resultados
            const getDriversInZone = (zoneId) => Object.keys(routes).filter(dName => driverZones[dName] === zoneId);
            const getUnassignedDrivers = () => Object.keys(routes).filter(dName => !driverZones[dName]);

            if (authLoading) return <div className="h-screen flex items-center justify-center font-bold text-ess-blue">Cargando...</div>;
            if (!user) return <LoginScreen onLoginSuccess={handleDemoLogin} isDemo={isDemoMode} />;

            return (
                <div className="min-h-screen text-slate-800 bg-white pb-24">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4"><h1 className="text-xl font-bold text-ess-blue">Route Planner {isDemoMode && "(Demo)"}</h1></div>
                            <div className="flex gap-3">
                                <button onClick={() => setView('input')} className={`px-3 py-2 rounded text-sm font-bold ${view === 'input' ? 'bg-ess-blue text-white' : 'bg-slate-100'}`}>Planner</button>
                                <button onClick={() => handleNavClick('clients')} className={`px-3 py-2 rounded text-sm font-bold ${view === 'clients' ? 'bg-ess-blue text-white' : 'bg-slate-100'}`}>Clients</button>
                                <button onClick={() => handleNavClick('vehicles')} className={`px-3 py-2 rounded text-sm font-bold ${view === 'vehicles' ? 'bg-ess-blue text-white' : 'bg-slate-100'}`}>Vehicles</button>
                                <button onClick={() => handleNavClick('settings')} className={`px-3 py-2 rounded text-sm font-bold ${view === 'settings' ? 'bg-ess-blue text-white' : 'bg-slate-100'}`}>Settings</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6">
                        {/* VISTA INPUT (PLANIFICADOR) */}
                        {view === 'input' && (
                            <div className="grid lg:grid-cols-12 gap-8 animate-fade-in">
                                <div className="lg:col-span-7 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="plus" className="h-5 w-5 text-ess-green" /> Add Stop</h2>
                                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                                            <div className="relative">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Client</label>
                                                <input ref={mainClientInputRef} type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Name" value={newStopName} onChange={(e) => { setNewStopName(e.target.value); setShowSuggestions(true); setActiveSuggestionIndex(-1); }} onKeyDown={handleClientKeyDown} />
                                                {showSuggestions && filteredClients.length > 0 && <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 overflow-hidden z-50">{filteredClients.map((c, i) => (<div key={i} onClick={() => selectClient(c)} className={`p-3 cursor-pointer border-b border-slate-50 ${i === activeSuggestionIndex ? 'bg-blue-100' : 'hover:bg-blue-50'}`}><div className="font-bold text-slate-700 text-sm">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}
                                            </div>
                                            <div className="relative">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Address</label>
                                                <GoogleAddressInput value={newStopAddress} onChange={(e) => { setNewStopAddress(e.target.value); setShowAddressSuggestions(true); }} onKeyDown={(e) => handleEnter(e, initiateAddStop)} className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Search Google Maps" disabled={!scriptLoaded} isLoaded={scriptLoaded} />
                                                {showAddressSuggestions && filteredClientsByAddress.length > 0 && <div className="absolute w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 z-50 bottom-full mb-1"><div className="bg-ess-blue text-white text-xs font-bold px-2 py-1">üëá Saved Clients</div>{filteredClientsByAddress.map((c, i) => (<div key={i} onClick={() => { selectClient(c); setTempStopData({name: c.name, address: c.address}); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm"><div className="font-bold text-slate-700">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}
                                            </div>
                                        </div>
                                        <div className="flex justify-end"><button onClick={initiateAddStop} disabled={!newStopAddress} className="bg-ess-blue text-white px-6 py-2.5 rounded-lg font-bold shadow-md flex items-center gap-2 disabled:opacity-50">Next</button></div>
                                    </div>
                                    <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden min-h-[300px]">
                                        <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                            <h3 className="font-bold text-slate-700">Today's Route ({currentStops.length})</h3>
                                            {currentStops.length > 0 && <button onClick={() => setCurrentStops([])} className="text-red-500 text-xs font-bold">Clear</button>}
                                        </div>
                                        <div className="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">
                                            {currentStops.map((stop, idx) => (<div key={idx} className="p-4 flex items-center gap-4 hover:bg-slate-50"><div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center font-bold text-sm text-slate-500">{idx+1}</div><div className="flex-1"><h4 className="font-bold text-slate-800">{stop.name}</h4><p className="text-sm text-slate-500">{stop.address}</p></div></div>))}
                                        </div>
                                    </div>
                                </div>
                                <div className="lg:col-span-5 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-700 mb-4">Drivers</h3>
                                        <div className="grid gap-2 mb-4">{drivers.map(d => <label key={d.id} className="flex items-center justify-between p-2 border rounded cursor-pointer"><span className="font-bold text-sm">{d.name}</span><input type="checkbox" checked={d.active} onChange={() => toggleDriver(d.id)} /></label>)}</div>
                                        <div className="flex gap-2"><input className="flex-1 p-2 border rounded text-sm" placeholder="New Driver" value={newDriverName} onChange={e => setNewDriverName(e.target.value)} /><button onClick={() => {addDriverToFb(newDriverName); setNewDriverName('')}} className="bg-slate-800 text-white px-3 rounded">+</button></div>
                                    </div>
                                    <button onClick={handleOptimize} disabled={loading} className="w-full bg-ess-green text-white py-4 rounded-xl font-bold text-lg shadow-lg disabled:opacity-75">{loading ? "Generating..." : "GENERATE ROUTE"}</button>
                                </div>
                            </div>
                        )}

                        {/* VISTA CLIENTES */}
                        {view === 'clients' && (
                            <div className="max-w-4xl mx-auto bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden animate-fade-in">
                                <div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center"><h2 className="text-xl font-bold text-slate-800 flex gap-2"><Icon name="database" className="h-5 w-5 text-ess-blue" /> Clients</h2><span className="bg-white px-3 py-1 rounded-full text-xs font-bold border">{clientDB.length} Clients</span></div>
                                <div className="p-6 bg-blue-50/50 border-b border-slate-200">
                                    <div className="flex flex-col md:flex-row gap-4">
                                        <input type="text" className="flex-1 p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Search / New Name..." value={clientFormName} onChange={(e) => setClientFormName(e.target.value)} />
                                        <div className="flex-[2] relative">
                                            <GoogleAddressInput value={clientFormAddress} onChange={(e) => { setClientFormAddress(e.target.value); setShowClientDbAddressSuggestions(true); }} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Address" disabled={!scriptLoaded} />
                                            {showClientDbAddressSuggestions && suggestionsForClientDbAddress.length > 0 && (<div className="absolute w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 z-50 bottom-full mb-1"><div className="bg-ess-blue text-white text-xs font-bold px-2 py-1">üëá Saved Clients</div>{suggestionsForClientDbAddress.map((c, i) => (<div key={i} onClick={() => { setClientFormName(c.name); setClientFormAddress(c.address); setEditingClientId(c.id); setShowClientDbAddressSuggestions(false); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 text-sm"><div className="font-bold text-slate-700">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>)}
                                        </div>
                                        <button className="bg-ess-green text-white px-4 py-2 rounded-lg font-semibold text-sm">Save/Add</button>
                                    </div>
                                </div>
                                <div className="max-h-[600px] overflow-y-auto"><table className="w-full text-left border-collapse"><tbody className="divide-y divide-slate-100">{filteredClientDBList.map(c => (<tr key={c.id} className="hover:bg-slate-50"><td className="p-4 font-medium">{c.name}</td><td className="p-4 text-sm text-slate-600">{c.address}</td></tr>))}</tbody></table></div>
                            </div>
                        )}

                        {/* VISTA SETTINGS (Con Gesti√≥n de Zonas) */}
                        {view === 'settings' && (
                            <div className="max-w-2xl mx-auto bg-white rounded-xl border border-slate-200 card-shadow p-6 space-y-8 animate-fade-in">
                                <div><h2 className="text-xl font-bold mb-4">Settings</h2><div><label className="block text-sm font-bold text-slate-500">Company Name</label><input className="w-full p-2 border rounded" value={companyConfig.companyName} onChange={e => setCompanyConfig({...companyConfig, companyName: e.target.value})} /></div></div>
                                <div>
                                    <h2 className="text-xl font-bold mb-4">Zone Management</h2>
                                    <div className="flex gap-2 mb-4"><input className="flex-1 p-2 border rounded" placeholder="New Zone Name" value={newZoneName} onChange={e => setNewZoneName(e.target.value)} /><button onClick={() => { if(newZoneName){ addZoneToFb(newZoneName); setNewZoneName(''); }}} className="bg-ess-green text-white px-3 rounded">+</button></div>
                                    <div className="flex flex-wrap gap-2">{zones.map(z => <div key={z.id} className="bg-slate-100 px-3 py-1 rounded-full flex items-center gap-2 border"><span>{z.name}</span><button onClick={() => deleteZone(z.id)} className="text-red-500 hover:text-red-700"><Icon name="x" className="h-3 w-3" /></button></div>)}</div>
                                </div>
                            </div>
                        )}

                        {/* VISTA VEHICULOS */}
                        {view === 'vehicles' && (<div className="max-w-2xl mx-auto bg-white rounded-xl border border-slate-200 card-shadow p-6"><h2 className="text-xl font-bold mb-4">Vehicles</h2>{vehicles.map(v => <div key={v.id} className="p-2 border-b">{v.name}</div>)}</div>)}

                        {/* VISTA RESULTADOS (CON ZONAS) */}
                        {view === 'results' && routes && (
                            <div className="animate-fade-in space-y-8">
                                {/* Navbar Resultados */}
                                <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <button onClick={() => setView('input')} className="text-slate-600 px-4 py-2 border rounded bg-white hover:bg-slate-50">‚Üê Back</button>
                                    <div className="flex gap-2">
                                        <button onClick={() => setView('global_map')} className="text-xs font-bold text-slate-600 border px-3 py-2 rounded">Map</button>
                                        <button onClick={() => setShowGlobalPrint(true)} className="text-xs font-bold text-white bg-slate-800 px-3 py-2 rounded">Print All</button>
                                    </div>
                                </div>

                                {/* Layout de Zonas */}
                                <div className="flex flex-col md:flex-row gap-6 pb-20">
                                    
                                    {/* Columna Izquierda: Unassigned Drivers */}
                                    <div className="md:w-1/4 flex-shrink-0 space-y-4">
                                        <h3 className="font-bold text-slate-500 text-sm uppercase tracking-wide">Unassigned Drivers</h3>
                                        <div className="space-y-4 min-h-[200px] p-2 rounded-xl bg-slate-50 border border-slate-200"
                                            onDragOver={(e) => { e.preventDefault(); setDragOverZone('unassigned'); }}
                                            onDrop={(e) => { if(draggedItem?.type === 'driver') { handleRemoveFromZone(draggedItem.driverName); setDragOverZone(null); } }}
                                            style={{ backgroundColor: dragOverZone === 'unassigned' ? '#eff6ff' : '' }}
                                        >
                                            {getUnassignedDrivers().map((driverName) => (
                                                <div key={driverName} draggable="true" onDragStart={(e) => handleDragStartDriver(e, driverName)} className="cursor-move">
                                                    {/* Tarjeta de Conductor */}
                                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow overflow-hidden">
                                                        <div className="bg-white p-3 border-b border-slate-100 flex justify-between items-center">
                                                            <h4 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="user" className="h-4 w-4 text-ess-blue" /> {driverName}</h4>
                                                            <div className="relative">
                                                                <input type="checkbox" className="custom-checkbox" checked={assigningZoneForDriver === driverName} onChange={() => setAssigningZoneForDriver(assigningZoneForDriver === driverName ? null : driverName)} />
                                                                {/* Men√∫ R√°pido de Zona */}
                                                                {assigningZoneForDriver === driverName && (
                                                                    <div className="absolute right-0 top-6 w-40 bg-white border border-slate-200 shadow-xl rounded-lg z-50 py-1">
                                                                        <div className="text-xs font-bold text-slate-400 px-3 py-1">Move to Zone:</div>
                                                                        {zones.map(z => (
                                                                            <button key={z.id} onClick={() => { setDriverZones(p => ({...p, [driverName]: z.id})); setAssigningZoneForDriver(null); }} className="w-full text-left px-3 py-2 text-sm hover:bg-blue-50 text-slate-700">{z.name}</button>
                                                                        ))}
                                                                        <div className="border-t my-1"></div>
                                                                        <button onClick={() => { handleRemoveFromZone(driverName); setAssigningZoneForDriver(null); }} className="w-full text-left px-3 py-2 text-sm hover:bg-red-50 text-red-600">Unassign</button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        {/* Lista de Paradas (Drag & Drop Interno) */}
                                                        <ul className="divide-y divide-slate-100 max-h-[150px] overflow-y-auto bg-slate-50/50" onDragOver={(e) => {e.preventDefault(); e.stopPropagation(); setDragOverDriver(driverName)}} onDrop={(e) => handleDropOnDriver(e, driverName)}>
                                                            {routes[driverName].paradas.map((stop, i) => (
                                                                <li key={i} draggable="true" onDragStart={(e) => handleDragStartStop(e, driverName, i)} className="p-2 text-xs flex gap-2 hover:bg-white cursor-grab">
                                                                    <span className="font-bold text-slate-400">#{i+1}</span>
                                                                    <div className="truncate">{stop.nombre}</div>
                                                                </li>
                                                            ))}
                                                            {routes[driverName].paradas.length === 0 && <li className="p-4 text-center text-xs text-slate-400 italic">No stops</li>}
                                                        </ul>
                                                        <div className="p-2 bg-slate-50 border-t flex justify-between text-xs">
                                                            <button onClick={() => setViewingDriver({name:driverName, data:routes[driverName]})} className="text-blue-600 font-bold">Map</button>
                                                            <button onClick={() => {setPrintData({driverName, stops:routes[driverName].paradas}); setShowPrintModal(true);}} className="text-slate-600"><Icon name="printer" className="h-3 w-3"/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {getUnassignedDrivers().length === 0 && <div className="text-center text-xs text-slate-400 py-4">All drivers assigned to zones</div>}
                                        </div>
                                    </div>

                                    {/* Columna Derecha: Zonas */}
                                    <div className="flex-1">
                                        <h3 className="font-bold text-slate-500 text-sm uppercase tracking-wide mb-4">Zones Overview</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                            {zones.map(zone => (
                                                <div key={zone.id} 
                                                    className={`zone-target min-h-[150px] rounded-xl p-3 flex flex-col gap-3 ${dragOverZone === zone.id ? 'drag-over' : ''}`}
                                                    onDragOver={(e) => { e.preventDefault(); setDragOverZone(zone.id); }}
                                                    onDragLeave={() => setDragOverZone(null)}
                                                    onDrop={(e) => handleDropOnZone(e, zone.id)}
                                                >
                                                    <div className="text-center font-bold text-slate-600 border-b border-dashed border-slate-300 pb-2">{zone.name}</div>
                                                    
                                                    {/* Drivers in Zone */}
                                                    {getDriversInZone(zone.id).map((driverName) => (
                                                        <div key={driverName} draggable="true" onDragStart={(e) => handleDragStartDriver(e, driverName)} className="cursor-move">
                                                            {/* Misma tarjeta de conductor (Mini versi√≥n) */}
                                                            <div className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                                                                <div className="p-2 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                                                                    <div className="font-bold text-sm text-ess-blue truncate flex items-center gap-1"><Icon name="truck" className="h-3 w-3"/> {driverName}</div>
                                                                    <input type="checkbox" className="custom-checkbox h-4 w-4" checked={assigningZoneForDriver === driverName} onChange={() => setAssigningZoneForDriver(assigningZoneForDriver === driverName ? null : driverName)} />
                                                                    {assigningZoneForDriver === driverName && (
                                                                        <div className="absolute right-4 w-40 bg-white border shadow-xl rounded z-50 py-1 text-xs">
                                                                            <div className="px-2 py-1 text-slate-400 font-bold">Move to:</div>
                                                                            {zones.filter(z=>z.id!==zone.id).map(z => <button key={z.id} onClick={() => { setDriverZones(p=>({...p,[driverName]:z.id})); setAssigningZoneForDriver(null); }} className="w-full text-left px-2 py-1 hover:bg-slate-50">{z.name}</button>)}
                                                                            <button onClick={() => { handleRemoveFromZone(driverName); setAssigningZoneForDriver(null); }} className="w-full text-left px-2 py-1 text-red-500 hover:bg-red-50">Unassign</button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                {/* Lista de Paradas Compacta */}
                                                                <ul className="bg-white max-h-[100px] overflow-y-auto" onDragOver={(e) => {e.preventDefault(); e.stopPropagation(); setDragOverDriver(driverName)}} onDrop={(e) => handleDropOnDriver(e, driverName)}>
                                                                    {routes[driverName].paradas.map((s, i) => (
                                                                        <li key={i} draggable="true" onDragStart={(e) => handleDragStartStop(e, driverName, i)} className="px-2 py-1 text-[10px] border-b border-slate-50 flex gap-1 hover:bg-slate-50 cursor-grab">
                                                                            <span className="font-bold text-slate-400">#{i+1}</span>
                                                                            <span className="truncate">{s.nombre}</span>
                                                                        </li>
                                                                    ))}
                                                                    {routes[driverName].paradas.length === 0 && <li className="p-2 text-center text-[10px] text-slate-300">Drop stops here</li>}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    
                                                    {getDriversInZone(zone.id).length === 0 && <div className="flex-1 flex items-center justify-center text-xs text-slate-400 italic">Drop drivers here</div>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ... [MODALES EXISTENTES: ADD STOP, PIN, ETC] ... */}
                        {showAddDetailsModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                                    <h3 className="font-bold text-lg mb-4">Stop Details</h3>
                                    <div className="space-y-4">
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Client</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" value={tempStopData?.name || ''} disabled /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Invoices</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={tempInvoices} onChange={e => setTempInvoices(e.target.value)} autoFocus /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Pieces</label><input type="number" className="w-full p-3 border border-slate-300 rounded-lg" value={tempPieces} onChange={e => setTempPieces(e.target.value)} onKeyDown={e => e.key === 'Enter' && confirmAddStop()} /></div>
                                    </div>
                                    <div className="mt-6 flex gap-3">
                                        <button onClick={() => setShowAddDetailsModal(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-bold">Cancel</button>
                                        <button onClick={confirmAddStop} className="flex-1 py-3 bg-ess-blue text-white rounded-lg font-bold shadow-lg">Save</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {showPinModal && (
                            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                                    <h3 className="font-bold text-lg mb-4">Enter PIN</h3>
                                    <input type="password" className="w-full p-3 border rounded text-center text-2xl tracking-widest" maxLength="4" value={pinInput} onChange={e => setPinInput(e.target.value)} onKeyDown={e => handleEnter(e, submitPin)} autoFocus />
                                    <div className="mt-6 flex gap-3"><button onClick={() => setShowPinModal(false)} className="flex-1 py-2 text-slate-500">Cancel</button><button onClick={submitPin} className="flex-1 py-2 bg-slate-800 text-white rounded">Unlock</button></div>
                                </div>
                            </div>
                        )}
                        {showPrintModal && printData && (
                            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                                    <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold">Print Manifest</h3><button onClick={() => setShowPrintModal(false)}><Icon name="x" className="h-5 w-5" /></button></div>
                                    <div className="p-6 text-center"><p>Ready to print route for <strong>{printData.driverName}</strong></p></div>
                                    <div className="p-4 border-t border-slate-100 flex gap-3"><button onClick={() => setShowPrintModal(false)} className="flex-1 py-2 border rounded">Cancel</button><button onClick={() => window.print()} className="flex-1 py-2 bg-slate-800 text-white rounded">Print</button></div>
                                </div>
                            </div>
                        )}
                        {viewingDriver && (
                            <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col relative">
                                    <div className="bg-slate-50 p-4 border-b flex justify-between items-center"><h3 className="font-bold flex items-center gap-2"><Icon name="map" className="h-5 w-5" /> {viewingDriver.name}</h3><button onClick={() => setViewingDriver(null)}><Icon name="x" className="h-6 w-6" /></button></div>
                                    <div className="flex-1 relative"><GlobalMapView routes={{ [viewingDriver.name]: viewingDriver.data }} baseAddress={baseAddress} /></div>
                                </div>
                            </div>
                        )}
                        {printData && <PrintableSheet routeData={printData.stops} driverName={printData.driverName} vehicle={selectedVehicleForPrint} config={companyConfig} />}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
