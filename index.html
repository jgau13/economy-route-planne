<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Sign Supply Route Planner</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs (M贸dulos) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Dejamos la configuraci贸n aqu铆 como una funci贸n para que pueda ser llamada
        // globalmente UNA VEZ que el Backend la entregue de forma segura.
        window.initializeFirebaseGlobally = (config) => {
            try {
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // Exponer variables globalmente para React
                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                // Firestore functions
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                console.log("Firebase Initialized Securely.");
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
            }
        };
    </script>

    <!-- Configuraci贸n de Colores Corporativos -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ess: {
                            blue: '#1b6e9b',  // Primary Color
                            green: '#6bbf5d', // Secondary Color
                            dark: '#0f4c6e',
                            light: '#f0f9ff'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .pac-container { z-index: 99999 !important; border-radius: 8px; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; font-family: 'Inter', sans-serif; }
        .pac-item { padding: 10px 12px; cursor: pointer; font-size: 14px; }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        
        .draggable-source { opacity: 0.4; border: 2px dashed #cbd5e1; background: #f8fafc; }
        .drop-target { background-color: #f0f9ff; border: 2px dashed #1b6e9b; }
        
        #global-map-container { height: 70vh; width: 100%; border-radius: 12px; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- COMPONENTE LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await window.fbSignIn(window.fbAuth, email, password);
                    // Auth state listener will handle the rest
                } catch (err) {
                    setError("Access Denied: Invalid credentials.");
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-16 mx-auto mb-4"/>
                            <h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>
                            <p className="text-slate-500">Authorized Personnel Only</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">Email</label>
                                <input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">Password</label>
                                <input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold hover:bg-sky-700 transition-colors flex justify-center">
                                {loading ? <div className="loader"></div> : "Sign In"}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // ... (Icon Component)
        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                if (iconData) {
                    const el = lucide.createElement(iconData);
                    el.setAttribute('class', className);
                    setSvgHtml(el.outerHTML);
                }
            }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        // ... (GoogleAddressInput Component - Autocurable Version)
        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded }) => {
            const inputRef = useRef(null);
            const autoCompleteRef = useRef(null);
            
            useEffect(() => {
                if (!isLoaded) return;
                const attemptInitialization = () => {
                    // Verificamos si Google Maps REALMENTE existe
                    if (!window.google || !window.google.maps || !window.google.maps.places) {
                        setTimeout(attemptInitialization, 300);
                        return;
                    }
                    if (!inputRef.current) return;
                    if (autoCompleteRef.current) return;

                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, {
                            types: ['geocode', 'establishment'], 
                            componentRestrictions: { country: "us" }, 
                            fields: ['formatted_address', 'name', 'geometry']
                        });
                        autocomplete.addListener("place_changed", () => {
                            const place = autocomplete.getPlace();
                            if (place.formatted_address) {
                                onChange({ target: { value: place.formatted_address } });
                            }
                        });
                        autoCompleteRef.current = autocomplete;
                    } catch (e) {
                        setTimeout(attemptInitialization, 500);
                    }
                };
                attemptInitialization();
            }, [isLoaded]);

            return <input ref={inputRef} type="text" value={value} onChange={onChange} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        // ... (GlobalMapView Component)
        const GlobalMapView = ({ routes, baseAddress }) => {
            const mapRef = useRef(null);
            const ROUTE_COLORS = ["#1b6e9b", "#6bbf5d", "#e11d48", "#d97706", "#7c3aed", "#db2777"];

            useEffect(() => {
                if (!window.google || !mapRef.current) return;
                const map = new window.google.maps.Map(mapRef.current, { zoom: 10, center: { lat: 28.5383, lng: -81.3792 }, mapTypeControl: false, streetViewControl: false });
                const directionsService = new window.google.maps.DirectionsService();
                const bounds = new window.google.maps.LatLngBounds();

                Object.entries(routes).forEach(([driverName, routeData], index) => {
                    if (routeData.paradas.length === 0) return;
                    const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                    const waypoints = routeData.paradas.map(stop => ({ location: stop.direccion, stopover: true }));

                    directionsService.route({
                        origin: baseAddress, destination: baseAddress, waypoints: waypoints,
                        optimizeWaypoints: false, travelMode: window.google.maps.TravelMode.DRIVING
                    }, (response, status) => {
                        if (status === 'OK') {
                            new window.google.maps.DirectionsRenderer({ map: map, directions: response, polylineOptions: { strokeColor: color, strokeOpacity: 0.7, strokeWeight: 5 }, suppressMarkers: false, preserveViewport: true });
                            bounds.union(response.routes[0].bounds);
                            map.fitBounds(bounds);
                        }
                    });
                });
            }, [routes, baseAddress]);

            return (
                <div className="animate-fade-in space-y-4">
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center justify-between">
                        <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="map" className="h-5 w-5 text-ess-blue" /> Global Fleet Map</h2>
                        <div className="flex flex-wrap gap-3">{Object.keys(routes).map((driver, index) => (<div key={driver} className="flex items-center gap-1.5 text-xs font-medium text-slate-600"><span className="w-3 h-3 rounded-full" style={{ backgroundColor: ROUTE_COLORS[index % ROUTE_COLORS.length] }}></span>{driver}</div>))}</div>
                    </div>
                    <div className="bg-white p-1 rounded-xl border border-slate-200 shadow-lg"><div id="global-map-container" ref={mapRef}></div></div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            // AUTH STATE
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            // DATA STATE (Firebase Sync)
            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);

            // APP STATE
            const [googleApiKey, setGoogleApiKey] = useState(null);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            const [mapError, setMapError] = useState('');
            const [view, setView] = useState('input'); 
            const [baseAddress, setBaseAddress] = useState('8350 Parkline Blvd, Orlando, FL 32809, EE. UU.');
            const [dwellTime, setDwellTime] = useState(10); 
            const [currentStops, setCurrentStops] = useState([]);
            
            // Inputs
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [newDriverName, setNewDriverName] = useState('');
            const [clientFormName, setClientFormName] = useState('');
            const [clientFormAddress, setClientFormAddress] = useState('');
            const [editingClientId, setEditingClientId] = useState(null);
            const [selectedClients, setSelectedClients] = useState([]);

            // Optimization
            const [routes, setRoutes] = useState(null);
            const [originalRoutes, setOriginalRoutes] = useState(null); 
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [recalculating, setRecalculating] = useState({});
            const [isRecalculatingAll, setIsRecalculatingAll] = useState(false);
            
            // Drag Drop Swap
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverDriver, setDragOverDriver] = useState(null);
            const [swappingDriver, setSwappingDriver] = useState(null);

            // --- 1. CONFIG FETCH AND FIREBASE INIT ---
            useEffect(() => {
                const fetchConfig = async () => {
                    try {
                        const response = await fetch('/config');
                        const data = await response.json();
                        
                        // 1. Inicializar Firebase con la config segura del backend
                        if (data.firebaseConfig && data.firebaseConfig.apiKey) {
                            // Delay to ensure the script module is ready
                            const tryInitFb = () => {
                                if (window.initializeFirebaseGlobally) {
                                    window.initializeFirebaseGlobally(data.firebaseConfig);
                                } else {
                                    setTimeout(tryInitFb, 50);
                                }
                            };
                            tryInitFb();
                        } else {
                            console.warn("Firebase configuration incomplete.");
                        }

                        // 2. Set Google Maps API Key
                        if (data.googleApiKey) {
                            setGoogleApiKey(data.googleApiKey);
                        } else { 
                            setMapError("API Key Error: Backend did not return a key.");
                        }
                    } catch (err) { 
                        setMapError("Backend disconnected. Route optimization unavailable."); 
                    }
                };
                fetchConfig();
            }, []);

            // --- 2. AUTH LISTENER ---
            useEffect(() => {
                const initAuth = () => {
                    if (window.fbOnAuthStateChanged) {
                        window.fbOnAuthStateChanged(window.fbAuth, (currentUser) => {
                            setUser(currentUser);
                            setAuthLoading(false);
                        });
                    } else {
                        setTimeout(initAuth, 100);
                    }
                };
                initAuth();
            }, []);


            // --- 3. DATA SYNC (FIRESTORE) ---
            useEffect(() => {
                if (!user || !window.fbDb) return; 

                // Listen to Clients
                const qClients = window.fbQuery(window.fbCollection(window.fbDb, "clients"), window.fbOrderBy("name"));
                const unsubClients = window.fbOnSnapshot(qClients, (snapshot) => {
                    const clientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setClientDB(clientsData);
                });

                // Listen to Drivers
                const qDrivers = window.fbQuery(window.fbCollection(window.fbDb, "drivers"), window.fbOrderBy("name"));
                const unsubDrivers = window.fbOnSnapshot(qDrivers, (snapshot) => {
                    const driversData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // If no drivers exist yet, create default ones
                    if (driversData.length === 0 && !localStorage.getItem('drivers_initialized')) {
                        addDriverToFb("Jorge");
                        addDriverToFb("Miguel");
                        addDriverToFb("Carlos");
                        localStorage.setItem('drivers_initialized', 'true');
                    }
                    setDrivers(driversData);
                });

                return () => { unsubClients(); unsubDrivers(); };
            }, [user]);

            // --- 4. GOOGLE MAPS SCRIPT LOADING ---
            useEffect(() => {
                if (!googleApiKey) return;
                if (window.google && window.google.maps && window.google.maps.places) {
                    setScriptLoaded(true); return;
                }
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&loading=async`;
                script.async = true;
                script.defer = true;
                script.onload = () => setTimeout(() => setScriptLoaded(true), 100);
                document.head.appendChild(script);
            }, [googleApiKey]);

            // --- FIRESTORE ACTIONS ---
            const addDriverToFb = async (name) => {
                if(!window.fbDb) return;
                await window.fbAddDoc(window.fbCollection(window.fbDb, "drivers"), { name, active: true });
            };
            
            const toggleDriver = async (id, currentStatus) => {
                if(!window.fbDb) return;
                await window.fbUpdateDoc(window.fbDoc(window.fbDb, "drivers", id), { active: !currentStatus });
            };

            const deleteDriver = async (id) => {
                if(!window.fbDb) return;
                if (confirm('Delete driver?')) await window.fbDeleteDoc(window.fbDoc(window.fbDb, "drivers", id));
            };

            const saveClient = async () => {
                if (!clientFormName.trim() || !clientFormAddress.trim() || !window.fbDb) return;
                if (editingClientId) {
                    await window.fbUpdateDoc(window.fbDoc(window.fbDb, "clients", editingClientId), { name: clientFormName, address: clientFormAddress });
                    setEditingClientId(null);
                } else {
                    await window.fbAddDoc(window.fbCollection(window.fbDb, "clients"), { name: clientFormName, address: clientFormAddress });
                }
                setClientFormName(''); setClientFormAddress('');
            };

            const deleteClient = async (id) => {
                if(!window.fbDb) return;
                if(confirm('Delete client?')) {
                    await window.fbDeleteDoc(window.fbDoc(window.fbDb, "clients", id));
                    setSelectedClients(selectedClients.filter(cid => cid !== id));
                }
            };

            // --- LOCAL FUNCTIONS ---
            const addStop = () => {
                if (!newStopAddress.trim()) return;
                const stop = { id: Date.now(), name: newStopName.trim() || 'Unnamed Client', address: newStopAddress.trim() };
                setCurrentStops([...currentStops, stop]);
                
                // Auto-save to DB if new
                const exists = clientDB.some(c => c.address.toLowerCase() === stop.address.toLowerCase());
                if (!exists && window.fbDb) { // Check if fbDb is available before saving
                    window.fbAddDoc(window.fbCollection(window.fbDb, "clients"), { name: stop.name, address: stop.address });
                }
                setNewStopName(''); setNewStopAddress('');
            };

            const removeStop = (id) => setCurrentStops(currentStops.filter(s => s.id !== id));
            const selectClient = (client) => { setNewStopName(client.name); setNewStopAddress(client.address); };
            
            const handleLogout = () => window.fbSignOut(window.fbAuth);

            // ... (Optimization Logic)
            const handleOptimize = async () => {
                const activeDrivers = drivers.filter(d => d.active);
                if (currentStops.length === 0) return setError('No stops added.');
                if (activeDrivers.length === 0) return setError('Select at least one available driver.');
                setLoading(true); setError('');
                try {
                    const response = await fetch('/optimizar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ direcciones: currentStops.map(s => s.address), num_vans: activeDrivers.length, base_address: baseAddress, dwell_time: parseInt(dwellTime) })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Server error.');
                    const assignedRoutes = {};
                    Object.keys(data).forEach((vanKey, index) => {
                        const driverName = activeDrivers[index] ? activeDrivers[index].name : vanKey;
                        assignedRoutes[driverName] = data[vanKey];
                    });
                    setRoutes(assignedRoutes);
                    setOriginalRoutes(JSON.parse(JSON.stringify(assignedRoutes)));
                    setView('results');
                } catch (err) { setError('Connection Error: ' + err.message); } finally { setLoading(false); }
            };

            const recalculateRoute = async (driverName, stopList) => {
                setRecalculating(prev => ({ ...prev, [driverName]: true }));
                try {
                    const response = await fetch('/recalcular', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paradas: stopList, base_address: baseAddress, dwell_time: parseInt(dwellTime) })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    setRoutes(prevRoutes => ({ ...prevRoutes, [driverName]: { ...prevRoutes[driverName], duracion_estimada: data.duracion_estimada, link: data.link, paradas: stopList } }));
                } catch (err) { console.error(err); } finally { setRecalculating(prev => ({ ...prev, [driverName]: false })); }
            };

            const handleRecalculateAll = async () => {
                if (!routes) return;
                setIsRecalculatingAll(true);
                await Promise.all(Object.keys(routes).map(d => recalculateRoute(d, routes[d].paradas)));
                setIsRecalculatingAll(false);
            };

            // Drag & Drop
            const handleDragStart = (e, driverName, stopIndex) => { setDraggedItem({ driverName, stopIndex }); e.dataTransfer.effectAllowed = 'move'; };
            const handleDrop = (e, targetDriverName, targetIndex = null) => {
                e.preventDefault(); setDragOverDriver(null);
                if (!draggedItem) return;
                const sourceDriver = draggedItem.driverName;
                const sourceIndex = draggedItem.stopIndex;
                const newRoutes = JSON.parse(JSON.stringify(routes));
                const [movedStop] = newRoutes[sourceDriver].paradas.splice(sourceIndex, 1);
                let dest = newRoutes[targetDriverName].paradas;
                if (targetIndex !== null) {
                    let adjIdx = targetIndex;
                    if (sourceDriver === targetDriverName && sourceIndex < targetIndex) adjIdx -= 0; 
                    dest.splice(adjIdx, 0, movedStop);
                } else { dest.push(movedStop); }
                setRoutes(newRoutes);
                recalculateRoute(targetDriverName, newRoutes[targetDriverName].paradas);
                if (sourceDriver !== targetDriverName) recalculateRoute(sourceDriver, newRoutes[sourceDriver].paradas);
            };

            const getWhatsappLink = (link) => `https://wa.me/?text=${encodeURIComponent(`Hello, route for today:\n\n${link}\n\nDrive safely! `)}`;
            const filteredClients = useMemo(() => {
                const term = newStopName.toLowerCase().trim();
                if (!term) return [];
                return clientDB.filter(c => c.name.toLowerCase().includes(term)).slice(0, 5);
            }, [newStopName, clientDB]);

            // --- RENDER ---
            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-ess-blue"><div className="loader mr-2"></div> Loading System...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen text-slate-800 bg-white">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto"/>
                                <div className="hidden md:block pl-4 border-l border-slate-200">
                                    <h1 className="text-xl font-bold text-ess-blue leading-none">Route Planner</h1>
                                    <p className="text-xs text-slate-400 mt-1">Logged as: <span className="font-bold text-ess-green">{user.email}</span></p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {view !== 'clients' ? 
                                    <button onClick={() => setView('clients')} className="text-sm font-medium text-slate-600 hover:text-ess-blue bg-slate-50 border border-slate-200 px-3 py-2 rounded-lg flex items-center gap-2"><Icon name="database" className="h-4 w-4" /> Clients</button> : 
                                    <button onClick={() => setView('input')} className="text-sm font-medium text-white bg-ess-blue px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="layout-dashboard" className="h-4 w-4" /> Planner</button>
                                }
                                <button onClick={handleLogout} className="text-sm font-medium text-red-500 hover:bg-red-50 border border-transparent hover:border-red-100 px-3 py-2 rounded-lg flex items-center gap-2"><Icon name="log-out" className="h-4 w-4" /> Exit</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6">
                        {/* INPUT: BASE ADDRESS */}
                        {view !== 'clients' && (
                            <div className="mb-6 flex justify-end">
                                <div className="bg-ess-light px-4 py-2 rounded-lg border border-blue-100 flex items-center gap-2 w-full md:w-auto">
                                    <Icon name="map-pin" className="h-5 w-5 text-ess-blue shrink-0" />
                                    <div className="text-xs w-full"><span className="block text-slate-400 font-semibold uppercase">Base (Start/End)</span><GoogleAddressInput value={baseAddress} onChange={(e) => setBaseAddress(e.target.value)} className="bg-transparent font-bold text-slate-700 outline-none w-full" placeholder="Warehouse" disabled={!scriptLoaded} isLoaded={scriptLoaded} /></div>
                                </div>
                            </div>
                        )}

                        {view === 'global_map' && (<div><div className="flex justify-between mb-6"><button onClick={() => setView('results')} className="text-slate-600 hover:text-ess-blue px-4 py-2 rounded-lg font-bold border border-slate-200 flex items-center gap-2"><Icon name="arrow-left" className="h-5 w-5" /> Back</button></div><GlobalMapView routes={routes} baseAddress={baseAddress} /></div>)}

                        {view === 'clients' && (
                            <div className="max-w-4xl mx-auto animate-fade-in">
                                <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden">
                                    <div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center">
                                        <div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="database" className="h-5 w-5 text-ess-blue" /> Cloud Database</h2><p className="text-sm text-slate-500">Syncs across all devices instantly</p></div>
                                        <span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-slate-600 border border-slate-200">{clientDB.length} Clients</span>
                                    </div>
                                    <div className="p-6 bg-blue-50/50 border-b border-slate-200">
                                        <div className="flex flex-col md:flex-row gap-4">
                                            <input type="text" className="flex-1 p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Client Name" value={clientFormName} onChange={(e) => setClientFormName(e.target.value)} />
                                            <div className="flex-[2]"><GoogleAddressInput value={clientFormAddress} onChange={(e) => setClientFormAddress(e.target.value)} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Address" disabled={!scriptLoaded} isLoaded={scriptLoaded} /></div>
                                            <button onClick={saveClient} disabled={!clientFormName || !clientFormAddress} className="bg-ess-green text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2"><Icon name={editingClientId ? 'save' : 'plus'} className="h-4 w-4" /> {editingClientId ? 'Save' : 'Add'}</button>
                                        </div>
                                    </div>
                                    <div className="max-h-[600px] overflow-y-auto">
                                        <table className="w-full text-left border-collapse">
                                            <tbody className="divide-y divide-slate-100">{clientDB.map(client => (<tr key={client.id} className="hover:bg-slate-50"><td className="p-4 font-medium text-slate-800">{client.name}</td><td className="p-4 text-slate-600 text-sm flex items-center gap-2"><Icon name="map-pin" className="h-3 w-3 text-slate-400" /> {client.address}</td><td className="p-4 text-right"><div className="flex justify-end gap-2"><button onClick={() => {setEditingClientId(client.id); setClientFormName(client.name); setClientFormAddress(client.address);}} className="text-blue-600 p-1"><Icon name="pencil" className="h-4 w-4" /></button><button onClick={() => deleteClient(client.id)} className="text-red-500 p-1"><Icon name="trash-2" className="h-4 w-4" /></button></div></td></tr>))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'input' && (
                            <div className="grid lg:grid-cols-12 gap-8 animate-fade-in">
                                <div className="lg:col-span-8 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow relative z-20">
                                        <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><div className="bg-ess-green/10 p-2 rounded-full"><Icon name="plus" className="h-5 w-5 text-ess-green" /></div> Add Stop</h2>
                                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                                            <div className="relative">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Client</label>
                                                <input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-ess-blue" placeholder="Name" value={newStopName} onChange={(e) => setNewStopName(e.target.value)} />
                                                {filteredClients.length > 0 && <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 overflow-hidden z-50">{filteredClients.map((client, i) => (<div key={i} onClick={() => selectClient(client)} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50"><div className="font-bold text-slate-700 text-sm">{client.name}</div><div className="text-xs text-slate-500 truncate">{client.address}</div></div>))}</div>}
                                            </div>
                                            <div>
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Address</label>
                                                <GoogleAddressInput value={newStopAddress} onChange={(e) => setNewStopAddress(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-ess-blue" placeholder="Search Google Maps" disabled={!scriptLoaded} isLoaded={scriptLoaded} />
                                            </div>
                                        </div>
                                        <div className="flex justify-end"><button onClick={addStop} disabled={!newStopAddress} className="bg-ess-blue text-white px-6 py-2.5 rounded-lg font-bold shadow-md transition-colors flex items-center gap-2 disabled:opacity-50"><Icon name="corner-down-left" className="h-4 w-4" /> Add</button></div>
                                    </div>
                                    <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden min-h-[300px]">
                                        <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="list" className="h-5 w-5 text-slate-400" /> Today's Route</h3><span className="bg-ess-blue text-white text-xs font-bold px-2 py-1 rounded-full">{currentStops.length} Stops</span></div>
                                        {currentStops.length === 0 ? <div className="p-12 text-center text-slate-400"><Icon name="map" className="h-12 w-12 mx-auto mb-3 opacity-20" /><p>List is empty.</p></div> : <div className="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">{currentStops.map((stop, idx) => (<div key={stop.id} className="p-4 flex items-center gap-4 hover:bg-slate-50 group"><div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold text-sm border border-slate-200">{idx + 1}</div><div className="flex-1"><h4 className="font-bold text-slate-800">{stop.name}</h4><p className="text-sm text-slate-500 flex items-center gap-1"><Icon name="map-pin" className="h-3 w-3" /> {stop.address}</p></div><button onClick={() => removeStop(stop.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg"><Icon name="trash-2" className="h-4 w-4" /></button></div>))}</div>}
                                    </div>
                                </div>
                                <div className="lg:col-span-4 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-3 border-b border-slate-100"><Icon name="users" className="h-5 w-5 text-ess-blue" /> Drivers (Cloud)</h3>
                                        <div className="flex gap-2 mb-4"><input type="text" className="flex-1 p-2 border border-slate-300 rounded-lg text-sm outline-none" placeholder="Name..." value={newDriverName} onChange={(e) => setNewDriverName(e.target.value)} /><button onClick={() => {if(newDriverName.trim()){ addDriverToFb(newDriverName); setNewDriverName(''); }}} className="bg-slate-800 text-white px-3 rounded hover:bg-slate-900"><Icon name="plus" className="h-4 w-4" /></button></div>
                                        <div className="space-y-3 mb-6 max-h-[300px] overflow-y-auto pr-1">{drivers.map(driver => (<div key={driver.id} className="group relative"><label className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer ${driver.active ? 'border-ess-green/50 bg-green-50/30' : 'border-slate-100 bg-slate-50 opacity-60'}`}><div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${driver.active ? 'bg-ess-green' : 'bg-slate-300'}`}></div><span className={`font-medium ${driver.active ? 'text-slate-800' : 'text-slate-500'}`}>{driver.name}</span></div><input type="checkbox" checked={driver.active} onChange={() => toggleDriver(driver.id, driver.active)} className="w-5 h-5 accent-ess-green" /></label><button onClick={(e) => { e.preventDefault(); deleteDriver(driver.id); }} className="absolute -right-2 -top-2 bg-white text-slate-400 hover:text-red-500 border border-slate-200 rounded-full p-1 opacity-0 group-hover:opacity-100 shadow-sm"><Icon name="x" className="h-3 w-3" /></button></div>))}</div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-3 border-b border-slate-100"><Icon name="settings" className="h-5 w-5 text-ess-blue" /> Config</h3>
                                        <div><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Dwell Time (min)</label><input type="number" min="0" className="w-full p-2 border border-slate-300 rounded text-sm outline-none" value={dwellTime} onChange={(e) => setDwellTime(e.target.value)} /></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow sticky top-24">
                                        {error && <div className="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg border border-red-200 flex gap-2"><Icon name="alert-triangle" className="h-5 w-5 shrink-0 mt-0.5" /><span className="break-words font-medium">{error}</span></div>}
                                        <button onClick={handleOptimize} disabled={loading} className="w-full bg-ess-green hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-600/20 transition-all flex justify-center items-center gap-2 disabled:opacity-75">{loading ? <><div className="loader mr-2"></div> Working...</> : <><Icon name="zap" className="h-6 w-6" /> GENERATE</>}</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'results' && routes && (
                            <div className="animate-fade-in space-y-8">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <button onClick={() => setView('input')} className="text-slate-600 hover:text-ess-blue hover:bg-blue-50 px-6 py-3 rounded-lg font-bold transition-colors flex items-center gap-2 border border-slate-200"><Icon name="arrow-left" className="h-5 w-5" /> Back</button>
                                    <div className="flex gap-2">
                                        <button onClick={handleRestore} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 hover:text-ess-blue px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="rotate-ccw" className="h-3 w-3" /> Reset</button>
                                        <button onClick={() => setView('global_map')} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 hover:text-ess-blue px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="map" className="h-3 w-3" /> Map</button>
                                        <button onClick={handleRecalculateAll} disabled={isRecalculatingAll} className="text-xs font-bold text-white bg-ess-blue hover:bg-sky-700 px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm">{isRecalculatingAll ? <div className="loader w-3 h-3"></div> : <><Icon name="refresh-cw" className="h-3 w-3" /> Update</>}</button>
                                    </div>
                                </div>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {Object.entries(routes).map(([driverName, data]) => (
                                        <div key={driverName} className={`bg-white rounded-xl border border-slate-200 card-shadow flex flex-col h-full overflow-hidden transition-colors duration-300 ${dragOverDriver === driverName ? 'drop-target' : 'hover:border-ess-blue'}`} onDragOver={(e) => {e.preventDefault(); setDragOverDriver(driverName);}} onDrop={(e) => handleDrop(e, driverName)}>
                                            <div className="bg-slate-50 p-5 border-b border-slate-100">
                                                <div className="flex justify-between items-center mb-4 relative">
                                                    <h3 className="font-bold text-xl text-slate-800 flex items-center gap-3"><div className="bg-white p-2 rounded-lg border border-slate-200 shadow-sm"><Icon name="user" className="h-5 w-5 text-ess-blue" /></div> {driverName} <button onClick={() => setSwappingDriver(swappingDriver === driverName ? null : driverName)} className="text-slate-400 hover:text-ess-blue p-1 rounded hover:bg-blue-50"><Icon name="arrow-left-right" className="h-4 w-4" /></button></h3>
                                                    <span className="bg-ess-blue text-white text-xs font-bold px-3 py-1 rounded-full">{data.paradas.length} Stops</span>
                                                    {swappingDriver === driverName && (<div className="absolute top-10 left-0 bg-white border border-slate-200 shadow-xl rounded-lg z-50 p-2 w-48 animate-fade-in"><p className="text-xs font-bold text-slate-500 mb-2 px-2">Swap with:</p>{Object.keys(routes).filter(d => d !== driverName).map(other => (<button key={other} onClick={() => {const newRoutes={...routes}; const temp=newRoutes[driverName]; newRoutes[driverName]=newRoutes[other]; newRoutes[other]=temp; setRoutes(newRoutes); setSwappingDriver(null);}} className="w-full text-left px-3 py-2 hover:bg-blue-50 rounded text-sm text-slate-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-ess-green"></div>{other}</button>))}</div>)}
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-500"><div className="bg-white p-2 rounded border border-slate-100 flex items-center gap-2">{recalculating[driverName] ? <div className="loader w-3 h-3"></div> : <><Icon name="clock" className="h-4 w-4 text-ess-green" /> {Math.floor(data.duracion_estimada / 60)}h {Math.round(data.duracion_estimada % 60)}m</>}</div><div className="bg-white p-2 rounded border border-slate-100 flex items-center gap-2"><Icon name="truck" className="h-4 w-4 text-ess-green" /> On route</div></div>
                                            </div>
                                            <div className="p-0 flex-1 overflow-y-auto max-h-[500px]">
                                                <ul className="divide-y divide-slate-100">{data.paradas.map((stop, index) => (<li key={index} className="p-4 hover:bg-slate-50 transition-colors flex gap-4 group cursor-grab active:cursor-grabbing" draggable="true" onDragStart={(e) => handleDragStart(e, driverName, index)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, driverName, index)}><div className="flex flex-col items-center gap-1 pt-1"><span className="flex-shrink-0 w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold flex items-center justify-center border border-slate-200 group-hover:bg-ess-blue group-hover:text-white transition-colors">{index + 1}</span>{index < data.paradas.length - 1 && <div className="w-0.5 h-full bg-slate-100 group-hover:bg-slate-200 min-h-[10px]"></div>}</div><div><div className="font-bold text-sm text-slate-800">{stop.direccion}</div></div></li>))}</ul>
                                            </div>
                                            <div className="p-5 border-t border-slate-100 bg-slate-50/50 space-y-3"><a href={data.link} target="_blank" rel="noreferrer" className="w-full bg-white border border-slate-200 text-slate-700 hover:border-ess-blue hover:text-ess-blue font-bold py-2.5 rounded-lg transition-all flex justify-center items-center gap-2 text-sm shadow-sm"><Icon name="map" className="h-4 w-4" /> Open Map</a><a href={getWhatsappLink(data.link)} target="_blank" rel="noreferrer" className="w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-2.5 rounded-lg transition-all flex justify-center items-center gap-2 text-sm shadow-sm"><Icon name="message-circle" className="h-4 w-4" /> WhatsApp</a></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
