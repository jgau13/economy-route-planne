<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Sign Supply Route Planner</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, setDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.initializeFirebaseGlobally = (config) => {
            try {
                if (!config || !config.apiKey || config.apiKey.includes("Pega_aquí")) {
                    console.warn("⚠️ Esperando configuración de Firebase válida...");
                    return false; 
                }
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                window.fbSendPasswordResetEmail = sendPasswordResetEmail;
                window.fbUpdatePassword = updatePassword;
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbSetDoc = setDoc; 
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                window.fbGetDocs = getDocs;
                window.fbLimit = limit;
                window.fbWriteBatch = writeBatch;
                
                window.firebaseReady = true; 
                return true;
            } catch (e) {
                console.error("❌ Firebase Initialization Error:", e);
                window.firebaseInitError = e.message;
                return false;
            }
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ess: { blue: '#1b6e9b', green: '#6bbf5d', dark: '#0f4c6e', light: '#f0f9ff' } } }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .pac-container { 
            z-index: 99999 !important; 
            border-radius: 8px; 
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border: 1px solid #e2e8f0; 
            font-family: 'Inter', sans-serif;
            max-width: 90vw !important; 
            white-space: normal !important;
        }
        .pac-item { padding: 10px 12px; cursor: pointer; font-size: 14px; white-space: normal !important; }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        
        .draggable-source { opacity: 0.4; border: 2px dashed #cbd5e1; background: #f1f5f9; }
        .drop-target { background-color: #eff6ff; border: 2px dashed #1b6e9b; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-checkbox { width: 20px; height: 20px; accent-color: #1b6e9b; cursor: pointer; }

        @media print {
            @page { size: portrait; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-sheet, #printable-sheet *, #global-manifest, #global-manifest * { visibility: visible; }
            #printable-sheet, #global-manifest { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const COMPANY_PALETTE = [
            { hex: "#1b6e9b", tw: "bg-ess-blue text-white" },
            { hex: "#6bbf5d", tw: "bg-ess-green text-white" },
            { hex: "#0f4c6e", tw: "bg-ess-dark text-white" },
            { hex: "#0284c7", tw: "bg-sky-600 text-white" },
            { hex: "#0d9488", tw: "bg-teal-600 text-white" },
            { hex: "#1e40af", tw: "bg-blue-800 text-white" },
            { hex: "#059669", tw: "bg-emerald-600 text-white" },
            { hex: "#0e7490", tw: "bg-cyan-700 text-white" }
        ];

        const ConfigErrorScreen = ({ errorDetails }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border-l-4 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="h-8 w-8" /> System Error</h1>
                    <p className="text-slate-600 mb-4 font-bold">Connection failed.</p>
                    <div className="bg-red-50 p-4 rounded-lg border border-red-200 text-sm font-mono text-red-800 mb-4 break-words">Error: {errorDetails || "Unknown Configuration Error"}</div>
                    <button onClick={() => window.location.reload()} className="mt-6 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors">Retry Connection</button>
                </div>
            </div>
        );

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [msg, setMsg] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError(''); setMsg('');
                if (!window.fbSignIn) { setError("System not ready. Please refresh."); setLoading(false); return; }
                try { await window.fbSignIn(window.fbAuth, email, password); } 
                catch (err) { console.error(err); setError("Access Denied. Check credentials."); setLoading(false); }
            };

            const handleForgotPassword = async () => {
                if(!email) { setError("Please enter your email first."); return; }
                try {
                    await window.fbSendPasswordResetEmail(window.fbAuth, email);
                    setMsg("Password reset email sent! Check your inbox.");
                    setError('');
                } catch (e) { setError("Error sending email: " + e.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-16 mx-auto mb-4"/>
                            <h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Email</label><input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Password</label><input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium">{error}</div>}
                            {msg && <div className="p-3 bg-green-50 text-green-600 text-sm rounded-lg font-medium">{msg}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold hover:bg-sky-700 transition-colors flex justify-center">{loading ? <div className="loader"></div> : "Sign In"}</button>
                            <div className="text-center">
                                <button type="button" onClick={handleForgotPassword} className="text-sm text-slate-500 hover:text-ess-blue underline">Forgot your password?</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                if (iconData) { const el = lucide.createElement(iconData); el.setAttribute('class', className); setSvgHtml(el.outerHTML); }
            }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded, onKeyDown, inputRef: propInputRef }) => {
            const innerRef = useRef(null);
            const inputRef = propInputRef || innerRef;
            const onChangeRef = useRef(onChange);
            const lastSelectionTimeRef = useRef(0);
            const usedArrowsRef = useRef(false);

            useEffect(() => { onChangeRef.current = onChange; }, [onChange]);

            useEffect(() => {
                if (!isLoaded) return;
                const attemptInitialization = () => {
                    if (!window.google || !window.google.maps || !window.google.maps.places) { setTimeout(attemptInitialization, 300); return; }
                    if (!inputRef.current) return;
                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, { types: ['geocode', 'establishment'], componentRestrictions: { country: "us" }, fields: ['formatted_address', 'name', 'geometry'] });
                        autocomplete.addListener("place_changed", () => { 
                            lastSelectionTimeRef.current = Date.now(); 
                            const place = autocomplete.getPlace(); 
                            const address = place.formatted_address || place.name;
                            if (address) { onChangeRef.current({ target: { value: address } }); }
                        });
                    } catch (e) { setTimeout(attemptInitialization, 500); }
                };
                attemptInitialization();
            }, [isLoaded]);
            
            const handleInputKeyDown = (e) => { 
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { usedArrowsRef.current = true; return; }
                if (e.key === 'Enter') {
                    const timeSinceSelection = Date.now() - lastSelectionTimeRef.current;
                    if (usedArrowsRef.current || timeSinceSelection < 500) {
                        e.preventDefault(); e.stopPropagation(); usedArrowsRef.current = false; return;
                    }
                } else { usedArrowsRef.current = false; }
                if (onKeyDown) onKeyDown(e); 
            };

            return <input ref={inputRef} type="text" value={value} onChange={onChange} onKeyDown={handleInputKeyDown} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        const GlobalMapView = ({ routes, baseAddress, onlyMarkers = false, enableDrawing = false, onStopsSelected = null }) => {
            const mapRef = useRef(null);
            const googleMapRef = useRef(null);
            const markersRef = useRef([]); 
            const renderersRef = useRef([]); 
            const infoWindowRef = useRef(null); 
            const geocoderRef = useRef(null);
            const drawingManagerRef = useRef(null);
            const [mapLoading, setMapLoading] = useState(false); 
            const [mapReady, setMapReady] = useState(false); 
            
            const ROUTE_HEX_COLORS = COMPANY_PALETTE.map(c => c.hex);
            
            useEffect(() => {
                if (!window.google || !googleMapRef.current || !mapReady) return;
                
                if (enableDrawing) {
                    if (!drawingManagerRef.current) {
                        try {
                            drawingManagerRef.current = new window.google.maps.drawing.DrawingManager({
                                drawingMode: null, 
                                drawingControl: true,
                                drawingControlOptions: {
                                    position: window.google.maps.ControlPosition.TOP_CENTER,
                                    drawingModes: [window.google.maps.drawing.OverlayType.RECTANGLE],
                                },
                                rectangleOptions: {
                                    fillColor: '#1b6e9b',
                                    fillOpacity: 0.2,
                                    strokeWeight: 1,
                                    clickable: false,
                                    editable: true,
                                    zIndex: 1,
                                },
                            });
                            
                            drawingManagerRef.current.setMap(googleMapRef.current);

                            window.google.maps.event.addListener(drawingManagerRef.current, 'overlaycomplete', function(event) {
                                if (event.type === 'rectangle') {
                                    const rectangle = event.overlay;
                                    const bounds = rectangle.getBounds();
                                    const selected = [];
                                    
                                    markersRef.current.forEach(marker => {
                                        if (bounds.contains(marker.getPosition())) {
                                            if (marker.customInfo && marker.customInfo.originalIndex) {
                                                selected.push(marker.customInfo.originalIndex);
                                            }
                                        }
                                    });
                                    
                                    if (onStopsSelected) {
                                        onStopsSelected(selected.sort((a,b) => a - b));
                                    }
                                    
                                    setTimeout(() => rectangle.setMap(null), 600);
                                }
                            });
                        } catch(e) {
                            console.error("Error initializing drawing manager:", e);
                        }
                    } else {
                        drawingManagerRef.current.setMap(googleMapRef.current);
                    }
                } else {
                    if (drawingManagerRef.current) {
                        drawingManagerRef.current.setMap(null);
                    }
                }
            }, [enableDrawing, onStopsSelected, mapReady]); 

            useEffect(() => {
                if (!window.google || !mapRef.current) return;

                if (!googleMapRef.current) {
                    googleMapRef.current = new window.google.maps.Map(mapRef.current, { 
                        zoom: 10, center: { lat: 28.5383, lng: -81.3792 }, 
                        mapTypeControl: false, streetViewControl: false,
                        fullscreenControl: false, gestureHandling: 'greedy'
                    });
                    infoWindowRef.current = new window.google.maps.InfoWindow();
                    geocoderRef.current = new window.google.maps.Geocoder();
                    setMapReady(true); 
                }
                const map = googleMapRef.current;
                const directionsService = new window.google.maps.DirectionsService();
                const bounds = new window.google.maps.LatLngBounds();

                markersRef.current.forEach(m => m.setMap(null));
                markersRef.current = [];
                renderersRef.current.forEach(r => r.setMap(null));
                renderersRef.current = [];

                const getPinIcon = (color) => ({
                    path: "M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z",
                    fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1,
                    labelOrigin: new window.google.maps.Point(0, -30)
                });

                const addMarker = (location, title, label, color, content, originalIndex) => {
                    const marker = new window.google.maps.Marker({
                        position: location, map: map,
                        label: { text: label, color: "white", fontWeight: "bold", fontSize: "12px" },
                        icon: getPinIcon(color), title: title,
                        zIndex: 100
                    });
                    marker.customInfo = { originalIndex: originalIndex };
                    
                    marker.addListener("click", () => { infoWindowRef.current.setContent(content); infoWindowRef.current.open(map, marker); });
                    markersRef.current.push(marker);
                    bounds.extend(location);
                    map.fitBounds(bounds);
                };

                const parseCoord = (coordData) => {
                    if (!coordData) return null;
                    if (typeof coordData === 'string') {
                        const [lat, lng] = coordData.split(',').map(Number);
                        if (!isNaN(lat) && !isNaN(lng)) return { lat, lng };
                    } else if (Array.isArray(coordData)) {
                        return { lat: coordData[0], lng: coordData[1] };
                    } else if (typeof coordData === 'object' && coordData.lat) {
                        return coordData;
                    }
                    return null;
                };

                const renderFallbackMarkers = (stops, color, groupName) => {
                    stops.forEach((stop, i) => {
                        if (!stop || !stop.direccion) return;
                        const pos = parseCoord(stop.coord || stop.latlng);
                        const stopIdx = stop.originalIndex || i + 1;
                        const contentString = `<div style="padding: 4px; font-family: sans-serif;"><strong style="color:${color}">${groupName}</strong><br/><b>${stop.nombre || 'Client'}</b><br/><span style="font-size:11px">${stop.direccion}</span></div>`;

                        if (pos) {
                            addMarker(pos, stop.nombre || 'Client', stopIdx.toString(), color, contentString, stopIdx);
                        } else {
                            setTimeout(() => {
                                if (geocoderRef.current) {
                                    geocoderRef.current.geocode({ address: stop.direccion }, (results, status) => {
                                        if (status === 'OK' && results[0]) {
                                            const loc = results[0].geometry.location;
                                            addMarker(loc, stop.nombre || 'Client', stopIdx.toString(), color, contentString, stopIdx);
                                        }
                                    });
                                }
                            }, i * 300);
                        }
                    });
                };

                const routeEntries = Object.entries(routes);
                if (routeEntries.length > 0 && !onlyMarkers) setMapLoading(true);

                if (baseAddress) {
                      geocoderRef.current.geocode({ address: baseAddress }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const baseLoc = results[0].geometry.location;
                            const baseMarker = new window.google.maps.Marker({
                                position: baseLoc, map: map,
                                icon: { path: window.google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#1e293b", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" },
                                title: "Warehouse", zIndex: 999
                            });
                            markersRef.current.push(baseMarker);
                            bounds.extend(baseLoc);
                            map.fitBounds(bounds);
                        }
                     });
                }

                let processedCount = 0;
                routeEntries.forEach(([groupName, routeData], index) => {
                    if (!routeData || !routeData.paradas || routeData.paradas.length === 0) {
                        processedCount++;
                        if(processedCount === routeEntries.length) setMapLoading(false);
                        return;
                    }
                    
                    let color = ROUTE_HEX_COLORS[index % ROUTE_HEX_COLORS.length];
                    if (groupName.startsWith('Ungrouped') || groupName === 'Sin Asignar') color = '#000000';

                    if (onlyMarkers) {
                        renderFallbackMarkers(routeData.paradas, color, groupName);
                        return;
                    }

                    const waypoints = routeData.paradas
                        .filter(stop => stop && stop.direccion)
                        .map(stop => ({ location: stop.direccion, stopover: true }));
                    
                    if (waypoints.length <= 25 && waypoints.length > 0) {
                        directionsService.route({ 
                            origin: baseAddress, destination: baseAddress, waypoints: waypoints, 
                            optimizeWaypoints: false, travelMode: window.google.maps.TravelMode.DRIVING 
                        }, (response, status) => {
                            processedCount++;
                            if(processedCount === routeEntries.length) setMapLoading(false);

                            if (status === 'OK') {
                                const renderer = new window.google.maps.DirectionsRenderer({ 
                                    map: map, directions: response, 
                                    polylineOptions: { strokeColor: color, strokeOpacity: 0.6, strokeWeight: 4 }, 
                                    suppressMarkers: true, preserveViewport: true 
                                });
                                renderersRef.current.push(renderer);
                                bounds.union(response.routes[0].bounds);
                                map.fitBounds(bounds);
                                
                                const legs = response.routes[0].legs;
                                routeData.paradas.forEach((stop, i) => {
                                    if (i < legs.length && stop) {
                                        const stopIdx = stop.originalIndex || i + 1;
                                        addMarker(legs[i].end_location, stop.nombre || 'Client', stopIdx.toString(), color, `<div style="padding:4px;"><b>${stop.nombre}</b><br/>${stop.direccion}</div>`, stopIdx);
                                    }
                                });
                            } else {
                                renderFallbackMarkers(routeData.paradas, color, groupName);
                            }
                        });
                    } else {
                        processedCount++;
                        if(processedCount === routeEntries.length) setMapLoading(false);
                        renderFallbackMarkers(routeData.paradas, color, groupName);
                    }
                });
            }, [routes, baseAddress, onlyMarkers]);
            
            return (
                <div className="w-full h-full flex flex-col relative">
                    {mapLoading && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-white/50 backdrop-blur-sm">
                            <div className="bg-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 border border-ess-blue">
                                <div className="loader w-4 h-4 border-ess-blue"></div>
                                <span className="text-xs font-bold text-ess-blue">Drawing Map Routes...</span>
                            </div>
                        </div>
                    )}
                    <div className="flex-1 min-h-[400px]"><div ref={mapRef} className="w-full h-full rounded-xl"></div></div>
                </div>
            );
        };

        const PrintableSheet = ({ routeData, driverName, vehicle, config, duration }) => {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US');
            const timeStr = today.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            return (
                <div id="printable-sheet" className="hidden print:block bg-white text-black p-4 font-sans text-sm">
                    <div className="flex justify-between items-start mb-6 border-b-2 border-black pb-4">
                        <div className="flex items-center gap-4">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto" />
                            <div>
                                <h1 className="text-xl font-bold uppercase tracking-wide">Route Manifest</h1>
                                <p className="font-bold text-md">{dateStr}</p>
                            </div>
                        </div>
                        <div className="text-right space-y-1">
                            <div className="text-base"><span className="font-bold">Driver:</span> {driverName}</div>
                            <div className="text-base"><span className="font-bold">Truck:</span> {vehicle || "_______"}</div>
                            <div className="text-base"><span className="font-bold">Print Date:</span> {timeStr}</div>
                            {duration && <div className="text-base"><span className="font-bold">Est. Time:</span> {Math.floor(duration/60)}h {Math.round(duration%60)}m</div>}
                        </div>
                    </div>
                    <table className="w-full border-collapse border border-black mb-4">
                        <thead>
                            <tr className="bg-white">
                                <th className="border border-black p-1 w-8 text-center text-xs">#</th>
                                <th className="border border-black p-2 text-left w-auto">Customer / Address</th>
                                <th className="border border-black p-2 w-20 text-center text-xs">Invoices</th>
                                <th className="border border-black p-2 w-10 text-center text-xs">Pcs</th>
                                <th className="border border-black p-2 w-12 text-center text-xs">COD</th>
                                <th className="border border-black p-2 w-32 text-left text-xs">Signature</th>
                            </tr>
                        </thead>
                        <tbody>
                            {routeData.map((stop, index) => (
                                <tr key={index} className="h-14">
                                    <td className="border border-black p-1 text-center font-bold">{index + 1}</td>
                                    <td className="border border-black p-2 align-top">
                                        <div className="font-bold text-sm truncate">{stop.nombre}</div>
                                        <div className="text-[10px] text-gray-600 leading-tight">{stop.direccion}</div>
                                    </td>
                                    <td className="border border-black p-1 text-center font-mono font-bold text-sm align-middle break-words">{stop.invoices || '-'}</td>
                                    <td className="border border-black p-1 text-center font-bold text-sm align-middle">{stop.pieces || '-'}</td>
                                    <td className="border border-black p-1 text-center font-bold text-sm align-middle"></td>
                                    <td className="border border-black p-1"></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <div className="flex justify-between items-end mt-4 pt-4 border-t border-black text-[10px]">
                        <div className="space-y-4">
                            <div>Checked by: __________________________</div>
                            <div>Time: __________________________</div>
                        </div>
                        <div className="text-right">
                            <div className="font-bold text-xs">{config.companyName}</div>
                            <div>PHONE: {config.phone}</div>
                            <div>{config.address}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalManifest = ({ routes, config }) => {
            const todayNow = new Date();
            const todayStr = todayNow.toLocaleDateString('en-US');
            const timeStr = todayNow.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            return (
                <div id="global-manifest" className="hidden print:block bg-white text-black p-8 font-sans">
                    <div className="flex justify-between items-center mb-8 border-b-2 border-black pb-4">
                        <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto" />
                        <div className="text-right">
                            <h1 className="text-2xl font-bold uppercase">All Routes Summary</h1>
                            <p className="text-lg font-bold">{todayStr} {timeStr}</p>
                        </div>
                    </div>
                    <div className="space-y-8">
                        {Object.entries(routes).map(([driver, data], idx) => (
                            <div key={idx} className="break-inside-avoid">
                                <div className="bg-gray-100 border border-black p-2 font-bold text-lg mb-2 flex justify-between items-center">
                                    <span>{driver}</span>
                                    <div className="flex gap-4 text-sm">
                                        {data.duracion_estimada > 0 && <span>Est. Time: {Math.floor(data.duracion_estimada/60)}h {Math.round(data.duracion_estimada%60)}m</span>}
                                        <span>{data.paradas.length} Stops</span>
                                    </div>
                                </div>
                                <table className="w-full border-collapse border border-black text-xs">
                                    <thead>
                                        <tr>
                                            <th className="border border-black p-1 w-8">#</th>
                                            <th className="border border-black p-1 text-left">Customer / Address</th>
                                            <th className="border border-black p-1 w-20 text-center">Invoices</th>
                                            <th className="border border-black p-1 w-12 text-center">Pcs</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.paradas.map((stop, sIdx) => (
                                            <tr key={sIdx}>
                                                <td className="border border-black p-1 text-center">{sIdx + 1}</td>
                                                <td className="border border-black p-1"><b>{stop.nombre}</b> - {stop.direccion}</td>
                                                <td className="border border-black p-1 text-center">{stop.invoices}</td>
                                                <td className="border border-black p-1 text-center">{stop.pieces}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [dbReady, setDbReady] = useState(false);
            const [systemError, setSystemError] = useState(null);

            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [googleApiKey, setGoogleApiKey] = useState(null);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            const [view, setView] = useState('input'); 
            
            const [baseAddress, setBaseAddress] = useState('8350 Parkline Blvd, Orlando, FL 32809, EE. UU.');
            const [dwellTime, setDwellTime] = useState(6);
            const [companyConfig, setCompanyConfig] = useState({ companyName: "ECONOMY SIGN SUPPLY ORLANDO", phone: "407-901-0900", address: "8350 PARKLINE BLVD, ORLANDO, FLORIDA 32809" });
            const [savedPin, setSavedPin] = useState('0000'); 

            const [currentStops, setCurrentStops] = useState([]);
            const [optimizedStops, setOptimizedStops] = useState(null); 
            
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [newDriverName, setNewDriverName] = useState('');
            const [newDriverPhone, setNewDriverPhone] = useState('');
            const [newVehicleName, setNewVehicleName] = useState(''); 
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAddressSuggestions, setShowAddressSuggestions] = useState(false); 
            const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(-1); 
            
            const [showAddDetailsModal, setShowAddDetailsModal] = useState(false); 
            const [tempStopData, setTempStopData] = useState(null);
            const [tempInvoices, setTempInvoices] = useState('');
            const [tempPieces, setTempPieces] = useState('');

            const [showAddRouteModal, setShowAddRouteModal] = useState(false);
            const [showManualStopModal, setShowManualStopModal] = useState(false);
            const [targetDriverForManual, setTargetDriverForManual] = useState(null);

            const [showDriverModal, setShowDriverModal] = useState(false);
            const [targetGroupForDriver, setTargetGroupForDriver] = useState(null);
            const [quickDriverName, setQuickDriverName] = useState('');

            const [showPinModal, setShowPinModal] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [pendingView, setPendingView] = useState('');

            const [printData, setPrintData] = useState(null); 
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [showGlobalPrint, setShowGlobalPrint] = useState(false); 
            const [selectedVehicleForPrint, setSelectedVehicleForPrint] = useState('');

            const [settingsMsg, setSettingsMsg] = useState('');
            const [newPin, setNewPin] = useState('');

            const [routes, setRoutes] = useState(null);
            const [originalRoutes, setOriginalRoutes] = useState(null); 
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [recalculating, setRecalculating] = useState({});
            
            const [clientFormName, setClientFormName] = useState('');
            const [clientFormAddress, setClientFormAddress] = useState('');
            const [showClientDbAddressSuggestions, setShowClientDbAddressSuggestions] = useState(false); 
            const [editingClientId, setEditingClientId] = useState(null);
            const [selectedStops, setSelectedStops] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverDriver, setDragOverDriver] = useState(null);
            const [swappingDriver, setSwappingDriver] = useState(null);
            const [isRecalculatingAll, setIsRecalculatingAll] = useState(false);
            const [editingStop, setEditingStop] = useState(null);
            const [editingDraftId, setEditingDraftId] = useState(null);
            
            const [viewingDriver, setViewingDriver] = useState(null);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [historyData, setHistoryData] = useState([]);

            const [zones, setZones] = useState([]);
            const [zoneAssignments, setZoneAssignments] = useState({}); 
            const [newZoneName, setNewZoneName] = useState('');
            const [draggedDriver, setDraggedDriver] = useState(null); 
            const [selectedDriversForZone, setSelectedDriversForZone] = useState([]); 

            const [savedRoutes, setSavedRoutes] = useState([]);
            const [showSaveRouteModal, setShowSaveRouteModal] = useState(false);
            const [showLoadRouteModal, setShowLoadRouteModal] = useState(false);
            const [routeSaveName, setRouteSaveName] = useState('');

            const [stopGroups, setStopGroups] = useState([]); 
            const [stopSelectionInput, setStopSelectionInput] = useState('');
            const [groupNameInput, setGroupNameInput] = useState('');
            const [editingGroupId, setEditingGroupId] = useState(null);

            const [showBulkImportModal, setShowBulkImportModal] = useState(false);
            const [bulkInputText, setBulkInputText] = useState('');
            const [importLoading, setImportLoading] = useState(false);
            const [editingDriverId, setEditingDriverId] = useState(null);

            const mainClientInputRef = useRef(null); 
            const invisibleAddressInputRef = useRef(null);
            const piecesInputRef = useRef(null);
            const resultsContainerRef = useRef(null); 
            const fileInputRef = useRef(null);

            const handleEnter = (e, callback) => { if (e.key === 'Enter') callback(); };
            const handleLogout = () => window.fbSignOut ? window.fbSignOut(window.fbAuth) : window.location.reload();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const getUserCollection = (collName) => user ? window.fbCollection(window.fbDb, 'artifacts', appId, 'users', user.uid, collName) : null;
            const getUserDocRef = (collName, docId) => user ? window.fbDoc(window.fbDb, 'artifacts', appId, 'users', user.uid, collName, docId) : null;

            useEffect(() => {
                const fetchConfig = async () => {
                    try {
                        const response = await fetch('/config');
                        const data = await response.json();
                        if (data.firebaseConfig?.apiKey) {
                            const tryInitFb = () => { if (window.initializeFirebaseGlobally && window.initializeFirebaseGlobally(data.firebaseConfig)) setDbReady(true); else setTimeout(tryInitFb, 50); };
                            tryInitFb();
                        } else { setSystemError("Missing Firebase Config."); setAuthLoading(false); }
                        if (data.googleApiKey) setGoogleApiKey(data.googleApiKey);
                    } catch (err) { setAuthLoading(false); }
                };
                fetchConfig();
            }, []);

            useEffect(() => {
                const initAuth = () => {
                    if (window.fbOnAuthStateChanged) window.fbOnAuthStateChanged(window.fbAuth, (u) => { setUser(u); setAuthLoading(false); });
                    else setTimeout(initAuth, 100);
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (!user || !window.fbDb || !dbReady) return;
                window.fbOnSnapshot(window.fbQuery(getUserCollection("clients"), window.fbOrderBy("name")), (s) => setClientDB(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("drivers"), window.fbOrderBy("name")), (s) => setDrivers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("draft_stops"), window.fbOrderBy("createdAt", "desc")), (s) => setCurrentStops(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("vehicles"), window.fbOrderBy("name")), (s) => setVehicles(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("saved_routes"), window.fbOrderBy("timestamp", "desc")), (s) => setSavedRoutes(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("zones"), window.fbOrderBy("name")), (s) => setZones(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("route_history"), window.fbOrderBy("timestamp", "desc"), window.fbLimit(3)), (s) => setHistoryData(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                window.fbOnSnapshot(getUserDocRef("settings", "zone_assignments"), (docSnap) => { if (docSnap.exists()) setZoneAssignments(docSnap.data()); });
                window.fbOnSnapshot(getUserDocRef("settings", "config"), (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        if (d.baseAddress) setBaseAddress(d.baseAddress);
                        if (d.adminPin) setSavedPin(d.adminPin);
                        setCompanyConfig(prev => ({ ...prev, companyName: d.companyName || prev.companyName, phone: d.companyPhone || prev.phone, address: d.companyAddress || prev.address }));
                    }
                });
            }, [user, dbReady]);

            useEffect(() => {
                if (!googleApiKey) return;
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places,drawing&loading=async`;
                script.async = true; script.onload = () => setTimeout(() => setScriptLoaded(true), 100);
                document.head.appendChild(script);
            }, [googleApiKey]);

            // Handlers
            const addDriverToFb = async () => { 
                if (!newDriverName.trim() || !window.fbDb) return;
                await window.fbAddDoc(getUserCollection("drivers"), { name: newDriverName, phone: newDriverPhone, active: true });
                setNewDriverName(''); setNewDriverPhone('');
            };
            const updateDriver = async (id, data) => { if (window.fbDb) await window.fbUpdateDoc(getUserDocRef("drivers", id), data); setEditingDriverId(null); };
            const toggleDriver = async (id, status) => { if(window.fbDb) await window.fbUpdateDoc(getUserDocRef("drivers", id), { active: !status }); };
            const deleteDriver = async (id) => { if(window.fbDb && confirm('Delete?')) await window.fbDeleteDoc(getUserDocRef("drivers", id)); };
            const addVehicleToFb = async (name) => { if(window.fbDb) await window.fbAddDoc(getUserCollection("vehicles"), { name }); };
            const deleteVehicle = async (id) => { if(window.fbDb && confirm('Delete Vehicle?')) await window.fbDeleteDoc(getUserDocRef("vehicles", id)); };
            const assignVehicleToDriver = async (vehicleId, driverName) => { if (window.fbDb) await window.fbUpdateDoc(getUserDocRef("vehicles", vehicleId), { assignedDriver: driverName }); }; 

            const saveClient = async () => { 
                if (!clientFormName || !window.fbDb) return; 
                const finalName = formatClientName(clientFormName);
                if (editingClientId) { await window.fbUpdateDoc(getUserDocRef("clients", editingClientId), { name: finalName, address: clientFormAddress }); setEditingClientId(null); } 
                else { await window.fbAddDoc(getUserCollection("clients"), { name: finalName, address: clientFormAddress }); } 
                setClientFormName(''); setClientFormAddress(''); 
            };
            const deleteClient = async (id) => { if(window.fbDb && confirm('Delete?')) await window.fbDeleteDoc(getUserDocRef("clients", id)); };
            const addClientToRoute = async (client) => {
                if (!window.fbDb) return;
                await window.fbAddDoc(getUserCollection("draft_stops"), { name: client.name, address: client.address, createdAt: Date.now() });
            };

            const handleBulkImport = async () => {
                if (!bulkInputText.trim() || !window.fbDb) return;
                setImportLoading(true);
                try {
                    const lines = bulkInputText.split('\n');
                    const batchSize = 400; 
                    let batch = window.fbWriteBatch(window.fbDb);
                    let count = 0;
                    for (let line of lines) {
                        const parts = line.split('\t'); 
                        if (parts.length < 2) continue;
                        const name = formatClientName(parts[0]); 
                        const address = parts[1].trim();
                        if (!name || !address) continue;
                        const docRef = window.fbDoc(getUserCollection("clients"));
                        batch.set(docRef, { name, address });
                        count++;
                        if (count >= batchSize) { await batch.commit(); batch = window.fbWriteBatch(window.fbDb); count = 0; }
                    }
                    if (count > 0) await batch.commit();
                    alert("Import successful!"); setBulkInputText(''); setShowBulkImportModal(false);
                } catch (e) { alert("Error: " + e.message); } finally { setImportLoading(false); }
            };

            const confirmAddStop = async () => {
                const addrToCheck = tempStopData?.address || newStopAddress;
                if (!addrToCheck || !/\b\d{5}\b/.test(addrToCheck)) return alert("Address must contain a Zip Code.");
                const finalName = formatClientName(tempStopData?.name || newStopName || 'Client');
                const finalAddress = addrToCheck;

                if (window.fbDb && finalAddress) {
                    const normalize = s => s ? s.toLowerCase().trim() : "";
                    if (!clientDB.some(c => normalize(c.address) === normalize(finalAddress))) {
                        window.fbAddDoc(getUserCollection("clients"), { name: finalName, address: finalAddress }).catch(err => console.error(err));
                    }
                }
                
                if (editingDraftId && window.fbDb) {
                      await window.fbUpdateDoc(getUserDocRef("draft_stops", editingDraftId), { name: finalName, address: finalAddress, invoices: tempInvoices, pieces: tempPieces });
                } else if (editingStop && routes) {
                    const newRoutes = JSON.parse(JSON.stringify(routes)); const stop = newRoutes[editingStop.driverName].paradas[editingStop.index]; 
                    stop.nombre = finalName; stop.direccion = finalAddress; stop.invoices = tempInvoices; stop.pieces = tempPieces; 
                    setRoutes(newRoutes);
                } else if (targetDriverForManual && routes) {
                     const newRoutes = JSON.parse(JSON.stringify(routes)); 
                     newRoutes[targetDriverForManual].paradas.push({ nombre: finalName, direccion: finalAddress, invoices: tempInvoices, pieces: tempPieces }); 
                     setRoutes(newRoutes);
                } else if (window.fbDb) {
                    await window.fbAddDoc(getUserCollection("draft_stops"), { name: finalName, address: finalAddress, invoices: tempInvoices, pieces: tempPieces, createdAt: Date.now() });
                }
                setNewStopName(''); setNewStopAddress(''); setShowSuggestions(false); setShowAddressSuggestions(false); setShowAddDetailsModal(false); setShowManualStopModal(false); setEditingDraftId(null); setEditingStop(null); setTempStopData(null); setTempInvoices(''); setTempPieces('');
                setTimeout(() => mainClientInputRef.current?.focus(), 100);
            };

            const initiateAddStop = () => {
                if (!newStopAddress) return;
                if (currentStops.some(s => s.address === newStopAddress)) if (!confirm("Duplicate address. Continue?")) return;
                setTempStopData({ name: newStopName || 'Client', address: newStopAddress }); setShowAddDetailsModal(true);
            };

            const recalculateRoute = async (dName, stops) => { 
                setRecalculating(p => ({...p, [dName]: true})); 
                try { 
                    const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: stops, num_vans: 1, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); 
                    const d = await res.json(); if(!res.ok) throw new Error(d.error);
                    const routeKey = Object.keys(d)[0];
                    setRoutes(p => ({ ...p, [dName]: { ...p[dName], duracion_estimada: d[routeKey].duracion_estimada, link: d[routeKey].link, paradas: d[routeKey].paradas } })); 
                } catch (e) { alert("Error: " + e.message); } finally { setRecalculating(p => ({...p, [dName]: false})); } 
            };

            const handleOptimizeRemaining = async (driverName) => {
                const currentRoute = routes[driverName].paradas; setRecalculating(p => ({...p, [driverName]: true})); 
                try { 
                    const res = await fetch('/optimizar_restantes', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ paradas: currentRoute, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); 
                    const d = await res.json(); if(!res.ok) throw new Error(d.error);
                    setRoutes(p => ({ ...p, [driverName]: { ...p[driverName], duracion_estimada: d.duracion_estimada, link: d.link, paradas: d.paradas } })); 
                } catch (e) { console.error(e); } finally { setRecalculating(p => ({...p, [driverName]: false})); }
            };

            const getWhatsappLink = (l, driverName) => {
                const driver = drivers.find(d => d.name === driverName);
                const phone = driver?.phone ? driver.phone.replace(/\D/g, '') : '';
                const text = encodeURIComponent(`Hello, route:\n\n${l}\n\nDrive safely!`);
                return phone ? `https://wa.me/${phone}?text=${text}` : `https://wa.me/?text=${text}`;
            };

            const handleNavClick = (targetView) => { if (targetView === 'input' || targetView === 'results') { setView('input'); return; } setPendingView(targetView); setPinInput(''); setShowPinModal(true); };
            const submitPin = () => { if (pinInput === savedPin) { setShowPinModal(false); setView(pendingView); } else { alert("Incorrect PIN"); setPinInput(''); } };

            const handlePlanZones = async () => {
                if (currentStops.length === 0) return setError('No stops.');
                setLoading(true); setError('');
                try {
                    const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: currentStops, num_vans: 1, base_address: baseAddress, dwell_time: 0 }) });
                    const data = await res.json(); if (!res.ok) throw new Error(data.error);
                    const routeKey = Object.keys(data)[0]; 
                    setOptimizedStops(data[routeKey].paradas);
                    setView('zone_planning');
                } catch (e) { setError(e.message); } finally { setLoading(false); }
            };

            // Drag and Drop Logic
            const handleDragStart = (e, dName, sIdx) => { e.dataTransfer.effectAllowed = 'move'; setDraggedItem({ driverName: dName, stopIndex: sIdx }); };
            const handleDrop = (e, targetDriver) => {
                if (!draggedItem) return;
                const newRoutes = JSON.parse(JSON.stringify(routes));
                const [stop] = newRoutes[draggedItem.driverName].paradas.splice(draggedItem.stopIndex, 1);
                newRoutes[targetDriver].paradas.push(stop);
                setRoutes(newRoutes); setDraggedItem(null);
            };

            const selectClient = (c) => { setNewStopName(c.name); setNewStopAddress(c.address); setShowSuggestions(false); };
            const getClientNameFromAddress = (addr) => { const c = clientDB.find(x => x.address === addr); return c ? c.name : "Client"; };

            const handleSelectionFromMap = (selectedIndices) => {
                if (selectedIndices && selectedIndices.length > 0) setStopSelectionInput(selectedIndices.join(', '));
            };

            const openEditStopModal = (driverName, index, stopData) => { setEditingStop({ driverName, index }); setTempStopData({ name: stopData.nombre, address: stopData.direccion }); setTempInvoices(stopData.invoices || ''); setTempPieces(stopData.pieces || ''); setShowAddDetailsModal(true); };
            const deleteStopFromRoute = (driverName, index) => { const nr = JSON.parse(JSON.stringify(routes)); nr[driverName].paradas.splice(index, 1); setRoutes(nr); };

            if (systemError) return <ConfigErrorScreen errorDetails={systemError} />;
            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-ess-blue font-bold text-lg">Loading...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen text-slate-800 bg-white pb-24">
                    {printData && showPrintModal && <PrintableSheet routeData={printData.stops} driverName={printData.driverName} vehicle={selectedVehicleForPrint} config={companyConfig} duration={printData.duration} />}
                    {showGlobalPrint && routes && <GlobalManifest routes={routes} config={companyConfig} />}
                    
                    {showPinModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 no-print">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                                <h3 className="font-bold text-lg mb-4 flex items-center justify-center gap-2"><Icon name="lock" className="h-5 w-5" /> Security PIN</h3>
                                <input type="password" title="PIN" className="w-full p-3 border border-slate-300 rounded-lg outline-none text-center text-2xl tracking-widest" maxLength="6" value={pinInput} onChange={e => setPinInput(e.target.value)} onKeyDown={(e) => handleEnter(e, submitPin)} autoFocus />
                                <div className="mt-6 flex gap-3">
                                    <button onClick={() => setShowPinModal(false)} className="flex-1 py-3 text-slate-500 font-bold">Cancel</button>
                                    <button onClick={submitPin} className="flex-1 py-3 bg-slate-800 text-white rounded-lg font-bold">Unlock</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 no-print">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-10 w-auto" />
                                <div className="hidden md:block pl-4 border-l border-slate-200 text-xs text-slate-400">
                                    Logged as: <span className="font-bold text-ess-green">{user.email}</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => handleNavClick('input')} className={`text-sm font-medium px-3 py-2 rounded-lg ${view === 'input' || view === 'results' || view === 'zone_planning' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 hover:bg-slate-50'}`}><Icon name="layout-dashboard" className="h-4 w-4 inline mr-1"/> Planner</button>
                                <button onClick={() => handleNavClick('clients')} className={`text-sm font-medium px-3 py-2 rounded-lg ${view === 'clients' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 hover:bg-slate-50'}`}><Icon name="database" className="h-4 w-4 inline mr-1"/> Clients</button>
                                <button onClick={() => handleNavClick('vehicles')} className={`text-sm font-medium px-3 py-2 rounded-lg ${view === 'vehicles' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 hover:bg-slate-50'}`}><Icon name="truck" className="h-4 w-4 inline mr-1"/> Fleet & Drivers</button>
                                <button onClick={() => handleNavClick('settings')} className={`text-sm font-medium px-3 py-2 rounded-lg ${view === 'settings' ? 'bg-ess-blue text-white shadow-sm' : 'text-slate-600 hover:bg-slate-50'}`}><Icon name="settings" className="h-4 w-4 inline mr-1"/> Settings</button>
                                <button onClick={handleLogout} className="text-sm font-medium text-red-500 hover:bg-red-50 border border-transparent hover:border-red-100 px-3 py-2 rounded-lg ml-2"><Icon name="log-out" className="h-4 w-4" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6 no-print">
                        {view === 'vehicles' && (
                            <div className="max-w-7xl mx-auto animate-fade-in space-y-8">
                                <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden">
                                    <div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center">
                                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon name="truck" className="h-5 w-5 text-ess-blue" /> Vehicles Management</h2>
                                    </div>
                                    <div className="p-6">
                                        <div className="flex gap-4 mb-6">
                                            <input type="text" className="flex-1 p-3 border border-slate-300 rounded-lg text-sm" placeholder="Vehicle Name / Plate ID" value={newVehicleName} onChange={e => setNewVehicleName(e.target.value)} onKeyDown={e => handleEnter(e, () => {if(newVehicleName.trim()){addVehicleToFb(newVehicleName); setNewVehicleName('');}})} />
                                            <button onClick={() => {if(newVehicleName.trim()){addVehicleToFb(newVehicleName); setNewVehicleName('');}}} className="bg-ess-green text-white px-6 py-2 rounded-lg font-bold">Add Truck</button>
                                        </div>
                                        <table className="w-full text-left">
                                            <thead className="text-xs font-bold text-slate-500 uppercase border-b"><tr><th className="p-4">Truck ID</th><th className="p-4">Default Driver</th><th className="p-4 text-right">Actions</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {vehicles.map(v => (
                                                    <tr key={v.id}>
                                                        <td className="p-4 font-bold">{v.name}</td>
                                                        <td className="p-4"><select className="w-full p-2 border rounded-lg" value={v.assignedDriver || ""} onChange={(e) => assignVehicleToDriver(v.id, e.target.value)}><option value="">-- Unassigned --</option>{drivers.filter(d => d.active).map(d => <option key={d.id} value={d.name}>{d.name}</option>)}</select></td>
                                                        <td className="p-4 text-right"><button onClick={() => deleteVehicle(v.id)} className="text-red-500"><Icon name="trash-2" className="h-5 w-5" /></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden">
                                    <div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center">
                                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon name="users" className="h-5 w-5 text-ess-blue" /> Drivers Management</h2>
                                    </div>
                                    <div className="p-6">
                                        <div className="flex flex-col md:flex-row gap-4 mb-6">
                                            <input type="text" className="flex-1 p-3 border border-slate-300 rounded-lg text-sm" placeholder="Driver Name" value={newDriverName} onChange={e => setNewDriverName(e.target.value)} onKeyDown={e => handleEnter(e, addDriverToFb)} />
                                            <div className="flex-1 relative">
                                                <input type="text" className="w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="WhatsApp (e.g. 1407...)" value={newDriverPhone} onChange={e => setNewDriverPhone(e.target.value)} onKeyDown={e => handleEnter(e, addDriverToFb)} />
                                                <span className="absolute right-3 top-3 text-[10px] text-slate-400">Include "1" for US</span>
                                            </div>
                                            <button onClick={addDriverToFb} className="bg-ess-green text-white px-6 py-2 rounded-lg font-bold">Add Driver</button>
                                        </div>
                                        <table className="w-full text-left">
                                            <thead className="text-xs font-bold text-slate-500 uppercase border-b"><tr><th className="p-4">Name</th><th className="p-4">WhatsApp #</th><th className="p-4 text-center">Status</th><th className="p-4 text-right">Actions</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {drivers.map(d => (
                                                    <tr key={d.id} className="hover:bg-slate-50">
                                                        <td className="p-4 font-bold">{d.name}</td>
                                                        <td className="p-4">
                                                            {editingDriverId === d.id ? (
                                                                <input type="text" className="p-1 border rounded w-32" defaultValue={d.phone} onBlur={e => updateDriver(d.id, { phone: e.target.value })} autoFocus />
                                                            ) : (
                                                                <div className="flex items-center gap-2">{d.phone || 'No number'}<button onClick={() => setEditingDriverId(d.id)}><Icon name="pencil" className="h-3 w-3 text-slate-400" /></button></div>
                                                            )}
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <input type="checkbox" checked={d.active} onChange={() => toggleDriver(d.id, d.active)} className="w-4 h-4 accent-green-600" />
                                                        </td>
                                                        <td className="p-4 text-right"><button onClick={() => deleteDriver(d.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Icon name="trash-2" className="h-5 w-5" /></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'results' && routes && (
                            <div className="animate-fade-in space-y-4">
                                <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 card-shadow">
                                    <button onClick={() => setView('zone_planning')} className="text-slate-600 font-bold flex items-center gap-2 hover:text-ess-blue transition-colors"><Icon name="arrow-left" className="h-4 w-4" /> Back to Planning</button>
                                    <div className="flex gap-2">
                                        <button onClick={() => setView('global_map')} className="bg-white border border-slate-300 px-4 py-2 rounded-lg font-bold hover:bg-slate-50">Map View</button>
                                        <button onClick={handleGlobalPrint} className="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-black transition-colors"><Icon name="printer" className="h-4 w-4" /> Print All</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    {Object.entries(routes).map(([driverName, data]) => (
                                        <div key={driverName} className="bg-white rounded-xl border border-slate-200 card-shadow flex flex-col overflow-hidden relative" onDragOver={e => e.preventDefault()} onDrop={e => handleDrop(e, driverName)}>
                                            <div className="absolute top-2 right-2">
                                                <button onClick={() => recalculateRoute(driverName, data.paradas)} className="bg-white p-1 rounded-full border border-slate-200 shadow-sm hover:bg-blue-50">
                                                    {recalculating[driverName] ? <div className="loader w-3 h-3 border-2"></div> : <Icon name="refresh-cw" className="h-4 w-4 text-ess-blue" />}
                                                </button>
                                            </div>
                                            <div className="bg-slate-50 p-4 border-b">
                                                <h3 className="font-bold text-lg text-slate-800">{driverName}</h3>
                                                <div className="flex justify-between items-center text-xs text-slate-500 mt-1">
                                                    <span className="flex items-center gap-1"><Icon name="clock" className="h-3 w-3" /> {Math.floor(data.duracion_estimada / 60)}h {Math.round(data.duracion_estimada % 60)}m</span>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleOptimizeRemaining(driverName)} title="Optimize Remaining (Keep 1st)" className="hover:text-purple-600"><Icon name="wand-2" className="h-4 w-4" /></button>
                                                        <button onClick={() => recalculateRoute(driverName, data.paradas)} title="Full Re-optimize (Shuffle All)" className="hover:text-blue-600"><Icon name="shuffle" className="h-4 w-4" /></button>
                                                        <button onClick={() => openPrintModal(driverName, data.paradas, data.duracion_estimada)} className="hover:text-black"><Icon name="printer" className="h-4 w-4" /></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <ul className="flex-1 divide-y max-h-[400px] overflow-y-auto">
                                                {data.paradas.map((stop, i) => (
                                                    <li key={i} draggable onDragStart={e => handleDragStart(e, driverName, i)} className="p-3 text-xs flex gap-3 hover:bg-slate-50 cursor-grab active:cursor-grabbing group relative">
                                                        <span className="w-5 h-5 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-500 border border-slate-200 shrink-0">{i+1}</span>
                                                        <div className="flex-1 overflow-hidden">
                                                            <div className="font-bold text-slate-700 truncate">{stop.nombre}</div>
                                                            <div className="text-slate-400 truncate">{stop.direccion}</div>
                                                        </div>
                                                        <div className="absolute right-2 opacity-0 group-hover:opacity-100 flex gap-1">
                                                            <button onClick={() => openEditStopModal(driverName, i, stop)}><Icon name="pencil" className="h-3 w-3 text-blue-400" /></button>
                                                            <button onClick={() => deleteStopFromRoute(driverName, i)}><Icon name="trash-2" className="h-3 w-3 text-red-400" /></button>
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                            <div className="p-4 border-t bg-slate-50/50 flex gap-2">
                                                <a href={data.link} target="_blank" rel="noreferrer" className="flex-1 bg-white border p-2 rounded text-center hover:border-ess-blue transition-colors"><Icon name="send" className="h-4 w-4 mx-auto text-slate-600" /></a>
                                                <a href={getWhatsappLink(data.link, driverName)} target="_blank" rel="noreferrer" className="flex-1 bg-[#25D366] text-white p-2 rounded text-center hover:bg-[#128C7E] transition-colors"><Icon name="message-circle" className="h-4 w-4 mx-auto" /></a>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'input' && (
                            <div className="grid lg:grid-cols-12 gap-8 animate-fade-in">
                                <div className="lg:col-span-7 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Icon name="plus" className="h-5 w-5 text-ess-green" /> Add Stop</h2>
                                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                                            <div className="relative">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Client</label>
                                                <input ref={mainClientInputRef} type="text" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" placeholder="Search saved or type new..." value={newStopName} onChange={e => {setNewStopName(e.target.value); setShowSuggestions(true);}} />
                                                {showSuggestions && newStopName && (
                                                    <div className="absolute top-full w-full bg-white border shadow-xl rounded-lg z-50 overflow-hidden">
                                                        {clientDB.filter(c => c.name.toLowerCase().includes(newStopName.toLowerCase())).slice(0,5).map((c, i) => (
                                                            <div key={i} onClick={() => selectClient(c)} className="p-3 hover:bg-slate-50 cursor-pointer border-b text-sm">
                                                                <div className="font-bold text-slate-700">{c.name}</div>
                                                                <div className="text-xs text-slate-400 truncate">{c.address}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="relative">
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Address</label>
                                                <GoogleAddressInput value={newStopAddress} onChange={e => setNewStopAddress(e.target.value)} onKeyDown={e => handleEnter(e, initiateAddStop)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" placeholder="Google Maps Search" isLoaded={scriptLoaded} />
                                            </div>
                                        </div>
                                        <div className="flex justify-end"><button onClick={initiateAddStop} disabled={!newStopAddress} className="bg-ess-blue text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-sky-700 disabled:opacity-50">Next Details</button></div>
                                    </div>
                                    
                                    <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden min-h-[300px]">
                                        <div className="bg-slate-50 p-4 border-b flex justify-between items-center font-bold text-slate-700">
                                            <div className="flex items-center gap-2"><Icon name="list" className="h-5 w-5 text-slate-400" /> Today's List</div>
                                            <span className="bg-ess-blue text-white px-2 py-0.5 rounded-full text-xs font-bold">{currentStops.length} Stops</span>
                                        </div>
                                        <div className="divide-y max-h-[500px] overflow-y-auto">
                                            {currentStops.length === 0 ? <p className="p-8 text-center text-slate-400 italic">No stops added for today yet.</p> : 
                                            currentStops.map((stop, idx) => (
                                                <div key={stop.id} className="p-4 flex items-center gap-4 hover:bg-slate-50 group">
                                                    <div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-500 border">{idx+1}</div>
                                                    <div className="flex-1 overflow-hidden">
                                                        <h4 className="font-bold text-slate-800 truncate">{stop.name}</h4>
                                                        <p className="text-xs text-slate-500 truncate">{stop.address}</p>
                                                    </div>
                                                    <button onClick={() => window.fbDeleteDoc(getUserDocRef("draft_stops", stop.id))} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 p-2"><Icon name="trash-2" className="h-4 w-4"/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="lg:col-span-5 space-y-6">
                                    <div className="bg-ess-light p-4 rounded-xl border border-blue-100">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Base Address (Start/End)</label>
                                        <GoogleAddressInput value={baseAddress} onChange={e => setBaseAddress(e.target.value)} className="w-full bg-transparent font-bold text-ess-blue outline-none" isLoaded={scriptLoaded} />
                                    </div>
                                    
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center gap-2"><Icon name="users" className="h-4 w-4" /> Driver Availability</h3>
                                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-2 max-h-[350px] overflow-y-auto">
                                            {drivers.map(d => (
                                                <label key={d.id} className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${d.active ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                                    <span className={`font-bold text-sm truncate pr-2 ${d.active ? 'text-slate-800' : 'text-slate-400'}`}>{d.name}</span>
                                                    <input type="checkbox" checked={d.active} onChange={() => toggleDriver(d.id, d.active)} className="w-4 h-4 accent-ess-green shrink-0" />
                                                </label>
                                            ))}
                                        </div>
                                        <div className="mt-4 pt-3 border-t text-center">
                                            <button onClick={() => handleNavClick('vehicles')} className="text-xs text-ess-blue font-bold hover:underline">Manage Fleet & Details →</button>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        {routes && <button onClick={() => setView('results')} className="w-full bg-white border-2 border-ess-green text-ess-green font-bold py-3 rounded-xl mb-3 hover:bg-green-50 transition-colors">GO TO PREVIOUS RESULTS</button>}
                                        <button onClick={handlePlanZones} disabled={currentStops.length === 0 || loading} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex justify-center items-center gap-2 hover:bg-black transition-all disabled:opacity-50">
                                            {loading ? <div className="loader"></div> : <><Icon name="map" className="h-6 w-6" /> PLAN ZONES & MAP</>}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'clients' && (
                             <div className="max-w-5xl mx-auto animate-fade-in space-y-6">
                                <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden">
                                    <div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center">
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="database" className="h-5 w-5 text-ess-blue" /> Client Database</h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => setShowBulkImportModal(true)} className="bg-white border p-2 rounded-lg text-xs font-bold hover:bg-slate-50"><Icon name="upload" className="h-3 w-3 inline mr-1"/> Import Excel</button>
                                            <span className="bg-ess-blue text-white px-3 py-1 rounded-full text-xs font-bold">{clientDB.length} Total</span>
                                        </div>
                                    </div>
                                    <div className="p-6 bg-blue-50/30 border-b">
                                        <div className="flex gap-4">
                                            <input type="text" className="flex-1 p-3 border rounded-lg" placeholder="Client Name" value={clientFormName} onChange={e => setClientFormName(e.target.value)} />
                                            <GoogleAddressInput value={clientFormAddress} onChange={e => setClientFormAddress(e.target.value)} className="flex-[2] p-3 border rounded-lg" placeholder="Address" isLoaded={scriptLoaded} />
                                            <button onClick={saveClient} className="bg-ess-green text-white px-6 rounded-lg font-bold">Add Client</button>
                                        </div>
                                    </div>
                                    <div className="max-h-[600px] overflow-y-auto">
                                        <table className="w-full text-left">
                                            <tbody className="divide-y">
                                                {clientDB.map(c => (
                                                    <tr key={c.id} className="hover:bg-slate-50">
                                                        <td className="p-4 font-bold text-slate-700">{c.name}</td>
                                                        <td className="p-4 text-sm text-slate-500">{c.address}</td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={() => addClientToRoute(c)} className="p-2 text-ess-blue hover:bg-blue-50 rounded mr-2"><Icon name="plus-circle" className="h-4 w-4"/></button>
                                                            <button onClick={() => {setEditingClientId(c.id); setClientFormName(c.name); setClientFormAddress(c.address);}} className="p-2 text-slate-400 hover:text-blue-500"><Icon name="pencil" className="h-4 w-4"/></button>
                                                            <button onClick={() => deleteClient(c.id)} className="p-2 text-slate-400 hover:text-red-500"><Icon name="trash-2" className="h-4 w-4"/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                             </div>
                        )}
                    </main>

                    {/* Modals */}
                    {showAddDetailsModal && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                                <h3 className="font-bold text-lg mb-4 text-slate-800">Stop Details</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Invoices (Optional)</label><input type="text" className="w-full p-3 border rounded-lg" value={tempInvoices} onChange={e => setTempInvoices(e.target.value)} autoFocus /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Pieces Shipped</label><input type="number" className="w-full p-3 border rounded-lg" value={tempPieces} onChange={e => setTempPieces(e.target.value)} onKeyDown={e => handleEnter(e, confirmAddStop)} /></div>
                                </div>
                                <div className="mt-6 flex gap-3">
                                    <button onClick={() => setShowAddDetailsModal(false)} className="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">Cancel</button>
                                    <button onClick={confirmAddStop} className="flex-1 py-3 bg-ess-blue text-white rounded-lg font-bold shadow-lg">Save Stop</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showPrintModal && printData && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 no-print">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                                <div className="bg-slate-50 p-4 border-b flex justify-between items-center font-bold"><h3>Print Manifest</h3><button onClick={() => setShowPrintModal(false)}><Icon name="x" className="h-5 w-5" /></button></div>
                                <div className="p-6">
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Assign Truck</label>
                                    <select title="Truck" className="w-full p-3 border rounded-lg mb-4 bg-white" value={selectedVehicleForPrint} onChange={e => setSelectedVehicleForPrint(e.target.value)}>
                                        <option value="">-- Select Truck --</option>
                                        {vehicles.map(v => <option key={v.id} value={v.name}>{v.name}</option>)}
                                    </select>
                                    <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                                        <p className="mb-1"><b>Driver:</b> {printData.driverName}</p>
                                        <p><b>Stops:</b> {printData.stops.length}</p>
                                    </div>
                                </div>
                                <div className="p-4 border-t flex gap-3 bg-white">
                                    <button onClick={() => setShowPrintModal(false)} className="flex-1 py-3 border border-slate-300 font-bold rounded-lg">Cancel</button>
                                    <button onClick={() => window.print()} className="flex-1 py-3 bg-slate-800 text-white rounded-lg font-bold shadow-lg">Print Now</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showBulkImportModal && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl h-[80vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-lg">Excel Bulk Import</h3>
                                    <button onClick={() => setShowBulkImportModal(false)}><Icon name="x" className="h-5 w-5"/></button>
                                </div>
                                <p className="text-sm text-slate-500 mb-4">Paste columns from Excel: Name [TAB] Address</p>
                                <textarea className="flex-1 p-3 border rounded-lg font-mono text-xs outline-none focus:ring-2 focus:ring-ess-blue" placeholder="Paste rows here..." value={bulkInputText} onChange={e => setBulkInputText(e.target.value)} />
                                <div className="mt-4 flex gap-3">
                                    <button onClick={() => setShowBulkImportModal(false)} className="flex-1 py-3 border font-bold rounded-lg">Cancel</button>
                                    <button onClick={handleBulkImport} disabled={importLoading || !bulkInputText.trim()} className="flex-1 py-3 bg-ess-blue text-white rounded-lg font-bold shadow-lg flex justify-center">
                                        {importLoading ? <div className="loader"></div> : "Import All"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'zone_planning' && (
                        <div className="grid grid-cols-12 gap-6 h-[calc(100vh-120px)] animate-fade-in">
                            <div className="col-span-4 bg-white rounded-xl border card-shadow flex flex-col overflow-hidden">
                                <div className="p-4 bg-slate-800 text-white font-bold flex justify-between items-center">
                                    <span>Step 1: Create Zones</span>
                                    <button onClick={() => setView('input')} className="text-xs bg-white/20 px-2 py-1 rounded">Back</button>
                                </div>
                                <div className="p-4 border-b bg-slate-50 space-y-2">
                                    <div className="text-[10px] font-bold text-slate-400 uppercase">Select Stop Numbers</div>
                                    <input type="text" placeholder="e.g. 1-5, 8, 10-12" className="w-full p-2 border rounded" value={stopSelectionInput} onChange={e => setStopSelectionInput(e.target.value)} />
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Zone Name" className="flex-1 p-2 border rounded uppercase" value={groupNameInput} onChange={e => setGroupNameInput(e.target.value)} />
                                        <button onClick={() => {
                                            if(!groupNameInput || !stopSelectionInput) return;
                                            const indices = new Set();
                                            stopSelectionInput.split(',').forEach(p => {
                                                const part = p.trim();
                                                if(part.includes('-')){
                                                    const [s, e] = part.split('-').map(n => parseInt(n.trim())-1);
                                                    for(let i=s; i<=e; i++) if(optimizedStops[i]) indices.add(i);
                                                } else {
                                                    const idx = parseInt(part)-1;
                                                    if(optimizedStops[idx]) indices.add(idx);
                                                }
                                            });
                                            if(indices.size > 0) {
                                                setStopGroups([...stopGroups, { id: Date.now(), name: groupNameInput.toUpperCase(), stops: Array.from(indices).sort((a,b)=>a-b), assignedDrivers: [] }]);
                                                setGroupNameInput(''); setStopSelectionInput('');
                                            }
                                        }} className="bg-ess-blue text-white px-4 rounded font-bold">Create</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {stopGroups.map((g, idx) => (
                                        <div key={g.id} className="border border-slate-200 rounded-lg p-3 bg-white shadow-sm">
                                            <div className="flex justify-between items-center font-bold text-slate-800 mb-2">
                                                <span className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${COMPANY_PALETTE[idx % 8].tw.split(' ')[0]}`}></div> {g.name}</span>
                                                <button onClick={() => setStopGroups(stopGroups.filter(x => x.id !== g.id))} className="text-red-400 hover:text-red-600"><Icon name="trash-2" className="h-4 w-4" /></button>
                                            </div>
                                            <div className="text-[10px] text-slate-400 mb-3">Stops: {g.stops.map(i => i+1).join(', ')}</div>
                                            <div className="flex flex-wrap gap-1 border-t pt-2">
                                                {drivers.filter(d => d.active).map(driver => (
                                                    <button key={driver.id} onClick={() => {
                                                        const isAssigned = g.assignedDrivers.includes(driver.name);
                                                        const newDrivers = isAssigned ? g.assignedDrivers.filter(n => n !== driver.name) : [...g.assignedDrivers, driver.name];
                                                        setStopGroups(stopGroups.map(x => x.id === g.id ? {...x, assignedDrivers: newDrivers} : x));
                                                    }} className={`text-[10px] px-2 py-1 rounded border transition-colors ${g.assignedDrivers.includes(driver.name) ? 'bg-green-100 border-green-300 text-green-800 font-bold' : 'bg-white text-slate-500'}`}>{driver.name}</button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {stopGroups.length === 0 && <p className="text-center text-slate-400 text-sm py-10 italic">Create zones by selecting stop ranges.</p>}
                                </div>
                                <div className="p-4 border-t bg-slate-50">
                                    <button onClick={async () => {
                                        if(stopGroups.length === 0) return;
                                        setLoading(true); setError('');
                                        try {
                                            const finalRoutes = {};
                                            const groupedIndices = new Set();
                                            for(const g of stopGroups) {
                                                if(g.assignedDrivers.length === 0) continue;
                                                g.stops.forEach(i => groupedIndices.add(i));
                                                const groupStops = g.stops.map(idx => optimizedStops[idx]);
                                                const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: groupStops, num_vans: g.assignedDrivers.length, base_address: baseAddress, dwell_time: dwellTime }) });
                                                const data = await res.json();
                                                Object.keys(data).forEach((key, i) => { finalRoutes[g.assignedDrivers[i] || key] = data[key]; });
                                            }
                                            // Handle Ungrouped
                                            const ungrouped = optimizedStops.filter((_, i) => !groupedIndices.has(i));
                                            if(ungrouped.length > 0) {
                                                const activeDriversInGroups = new Set(stopGroups.flatMap(g => g.assignedDrivers));
                                                const freeDrivers = drivers.filter(d => d.active && !activeDriversInGroups.has(d.name));
                                                if(freeDrivers.length > 0) {
                                                    const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: ungrouped, num_vans: freeDrivers.length, base_address: baseAddress, dwell_time: dwellTime }) });
                                                    const data = await res.json();
                                                    Object.keys(data).forEach((key, i) => { finalRoutes[freeDrivers[i]?.name || `Extra-${i}`] = data[key]; });
                                                }
                                            }
                                            setRoutes(finalRoutes); setView('results');
                                        } catch(e) { setError(e.message); } finally { setLoading(false); }
                                    }} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 transition-all">GENERATE FINAL ROUTES</button>
                                </div>
                            </div>
                            <div className="col-span-8 border rounded-xl card-shadow overflow-hidden relative bg-white">
                                <GlobalMapView routes={{ 'Planner': { paradas: optimizedStops.map((s,i)=>({...s, originalIndex: i+1})) } }} baseAddress={baseAddress} onlyMarkers={true} enableDrawing={true} onStopsSelected={handleSelectionFromMap} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
