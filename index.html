<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Planner</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Funci√≥n global para iniciar Firebase
        window.initializeFirebaseGlobally = (config) => {
            try {
                if (!config.apiKey || config.apiKey.includes("TU_API_KEY")) {
                    console.error("‚ö†Ô∏è Firebase Config no v√°lida. Revisa tus variables de entorno.");
                    return false; 
                }
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // Exponemos las funciones de Firebase al objeto window para usarlas en React
                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                window.fbSendPasswordResetEmail = sendPasswordResetEmail;
                window.fbUpdatePassword = updatePassword;
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbSetDoc = setDoc; 
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                window.fbGetDocs = getDocs;
                window.fbLimit = limit;
                
                window.firebaseReady = true; 
                return true;
            } catch (e) {
                console.error("‚ùå Error Inicializando Firebase:", e);
                window.firebaseInitError = e.message;
                return false;
            }
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ess: { blue: '#1b6e9b', green: '#6bbf5d', dark: '#0f4c6e', light: '#f0f9ff' } } }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .pac-container { 
            z-index: 99999 !important; 
            border-radius: 8px; 
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border: 1px solid #e2e8f0; 
            font-family: 'Inter', sans-serif;
            max-width: 90vw !important; 
            white-space: normal !important;
        }
        .pac-item { padding: 10px 12px; cursor: pointer; font-size: 14px; white-space: normal !important; }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        
        .draggable-source { opacity: 0.4; border: 2px dashed #cbd5e1; background: #f1f5f9; }
        .drop-target { background-color: #eff6ff; border: 2px dashed #1b6e9b; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-checkbox { width: 20px; height: 20px; accent-color: #1b6e9b; cursor: pointer; }

        @media print {
            @page { size: portrait; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-sheet, #printable-sheet *, #global-manifest, #global-manifest * { visibility: visible; }
            #printable-sheet, #global-manifest { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =========================================================
        // PANTALLAS Y COMPONENTES
        // =========================================================

        const ConfigErrorScreen = ({ errorDetails }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border-l-4 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="h-8 w-8" /> Error de Configuraci√≥n</h1>
                    <p className="text-slate-600 mb-4 font-bold">No se pudo conectar.</p>
                    <div className="bg-red-50 p-4 rounded-lg border border-red-200 text-sm font-mono text-red-800 mb-4 break-words">Detalle: {errorDetails || "Error desconocido"}</div>
                    <button onClick={() => window.location.reload()} className="mt-6 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors">Reintentar</button>
                </div>
            </div>
        );

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [msg, setMsg] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError(''); setMsg('');
                if (!window.fbSignIn) { setError("Sistema no listo. Refresca la p√°gina."); setLoading(false); return; }
                try { await window.fbSignIn(window.fbAuth, email, password); } 
                catch (err) { console.error(err); setError("Acceso denegado. Revisa tus credenciales."); setLoading(false); }
            };

            const handleForgotPassword = async () => {
                if(!email) { setError("Ingresa tu email primero."); return; }
                try {
                    await window.fbSendPasswordResetEmail(window.fbAuth, email);
                    setMsg("Email de restablecimiento enviado.");
                    setError('');
                } catch (e) { setError("Error enviando email: " + e.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>
                            <p className="text-sm text-slate-400">Login Seguro</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Email</label><input type="email" required className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-ess-blue" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Password</label><input type="password" required className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-ess-blue" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium">{error}</div>}
                            {msg && <div className="p-3 bg-green-50 text-green-600 text-sm rounded-lg font-medium">{msg}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold hover:bg-sky-700 transition-colors flex justify-center">{loading ? <div className="loader"></div> : "Iniciar Sesi√≥n"}</button>
                            <div className="text-center">
                                <button type="button" onClick={handleForgotPassword} className="text-sm text-slate-500 hover:text-ess-blue underline">¬øOlvidaste tu contrase√±a?</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                if (iconData) { const el = lucide.createElement(iconData); el.setAttribute('class', className); setSvgHtml(el.outerHTML); }
            }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded, onKeyDown, inputRef: propInputRef }) => {
            const innerRef = useRef(null);
            const inputRef = propInputRef || innerRef;
            const onChangeRef = useRef(onChange);

            useEffect(() => { onChangeRef.current = onChange; }, [onChange]);

            useEffect(() => {
                if (!isLoaded) return;
                const attemptInitialization = () => {
                    if (!window.google || !window.google.maps || !window.google.maps.places) { setTimeout(attemptInitialization, 300); return; }
                    if (!inputRef.current) return;
                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, { types: ['geocode', 'establishment'], componentRestrictions: { country: "us" }, fields: ['formatted_address', 'name', 'geometry'] });
                        autocomplete.addListener("place_changed", () => { 
                            const place = autocomplete.getPlace(); 
                            const address = place.formatted_address || place.name;
                            if (address) { onChangeRef.current({ target: { value: address } }); }
                        });
                    } catch (e) { setTimeout(attemptInitialization, 500); }
                };
                attemptInitialization();
            }, [isLoaded]);
            
            return <input ref={inputRef} type="text" value={value} onChange={onChange} onKeyDown={(e) => onKeyDown && onKeyDown(e)} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        // --- GLOBAL MAP VIEW (Marcadores Nativos) ---
        const GlobalMapView = ({ routes, baseAddress }) => {
            const mapRef = useRef(null);
            const googleMapRef = useRef(null);
            const markersRef = useRef([]); 
            const renderersRef = useRef([]); 
            const infoWindowRef = useRef(null); 
            const ROUTE_COLORS = ["#1b6e9b", "#6bbf5d", "#e11d48", "#d97706", "#7c3aed", "#db2777"];
            
            useEffect(() => {
                if (!window.google || !mapRef.current) return;

                if (!googleMapRef.current) {
                    googleMapRef.current = new window.google.maps.Map(mapRef.current, { 
                        zoom: 10, center: { lat: 28.5383, lng: -81.3792 }, 
                        mapTypeControl: false, streetViewControl: false,
                        fullscreenControl: false, gestureHandling: 'greedy'
                    });
                    infoWindowRef.current = new window.google.maps.InfoWindow();
                }
                const map = googleMapRef.current;
                const directionsService = new window.google.maps.DirectionsService();
                const bounds = new window.google.maps.LatLngBounds();

                markersRef.current.forEach(m => m.setMap(null));
                markersRef.current = [];
                renderersRef.current.forEach(r => r.setMap(null));
                renderersRef.current = [];

                const getPinIcon = (color) => {
                    return {
                        path: "M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z",
                        fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1,
                        labelOrigin: new window.google.maps.Point(0, -30)
                    };
                };

                Object.entries(routes).forEach(([driverName, routeData], index) => {
                    if (routeData.paradas.length === 0) return;
                    const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                    const waypoints = routeData.paradas.map(stop => ({ location: stop.direccion, stopover: true }));
                    
                    directionsService.route({ 
                        origin: baseAddress, destination: baseAddress, waypoints: waypoints, 
                        optimizeWaypoints: false, travelMode: window.google.maps.TravelMode.DRIVING 
                    }, (response, status) => {
                        if (status === 'OK') {
                            const renderer = new window.google.maps.DirectionsRenderer({ 
                                map: map, directions: response, 
                                polylineOptions: { strokeColor: color, strokeOpacity: 0.7, strokeWeight: 5 }, 
                                suppressMarkers: true, preserveViewport: true 
                            });
                            renderersRef.current.push(renderer);
                            bounds.union(response.routes[0].bounds);
                            map.fitBounds(bounds);

                            const legs = response.routes[0].legs;

                            if (legs.length > 0) {
                                const baseMarker = new window.google.maps.Marker({
                                    position: legs[0].start_location, map: map,
                                    icon: { path: window.google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#333", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" },
                                    title: "Warehouse"
                                });
                                baseMarker.addListener("click", () => {
                                    infoWindowRef.current.setContent(`<div style="padding:4px;"><h3 style="font-weight:bold;">üè≠ Base</h3><p style="font-size:12px;">${baseAddress}</p></div>`);
                                    infoWindowRef.current.open(map, baseMarker);
                                });
                                markersRef.current.push(baseMarker);
                            }

                            routeData.paradas.forEach((stop, i) => {
                                if (i < legs.length) {
                                    const marker = new window.google.maps.Marker({
                                        position: legs[i].end_location, map: map,
                                        label: { text: (i + 1).toString(), color: "white", fontWeight: "bold", fontSize: "14px" },
                                        icon: getPinIcon(color), title: stop.nombre
                                    });
                                    const contentString = `<div style="min-width: 200px; padding: 4px; font-family: sans-serif;"><div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;"><span style="background:${color}; color:white; font-weight:bold; padding:2px 8px; border-radius:12px; font-size:12px;">#${i + 1}</span><h3 style="font-weight:bold; font-size:15px; margin:0;">${stop.nombre}</h3></div><p style="font-size:12px; color:#444; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:8px;">üìç ${stop.direccion}</p>${(stop.invoices || stop.pieces) ? `<div style="font-size:12px; background:#f8fafc; padding:6px; border-radius:4px; border:1px solid #e2e8f0;">${stop.invoices ? `<div><strong>Inv:</strong> ${stop.invoices}</div>` : ''}${stop.pieces ? `<div><strong>Pcs:</strong> ${stop.pieces}</div>` : ''}</div>` : ''}</div>`;
                                    marker.addListener("click", () => { infoWindowRef.current.setContent(contentString); infoWindowRef.current.open(map, marker); });
                                    markersRef.current.push(marker);
                                }
                            });
                        }
                    });
                });
            }, [routes, baseAddress]);
            
            return (
                <div className="w-full h-full flex flex-col">
                    <div className="flex flex-wrap gap-3 mb-2 px-1">
                        {Object.keys(routes).map((driver, index) => (
                            <div key={driver} className="flex items-center gap-1.5 text-xs font-bold text-slate-700 bg-white px-2 py-1 rounded shadow-sm border border-slate-100">
                                <span className="w-3 h-3 rounded-full shadow-sm" style={{ backgroundColor: ROUTE_COLORS[index % ROUTE_COLORS.length] }}></span>{driver}
                            </div>
                        ))}
                    </div>
                    <div className="flex-1 min-h-[400px]"><div ref={mapRef} className="w-full h-full rounded-xl"></div></div>
                </div>
            );
        };

        const PrintableSheet = ({ routeData, driverName, vehicle, config }) => {
            const today = new Date();
            return (
                <div id="printable-sheet" className="hidden print:block bg-white text-black p-4 font-sans text-sm">
                    <div className="flex justify-between items-start mb-6 border-b-2 border-black pb-4">
                        <div className="flex items-center gap-4">
                            <div>
                                <h1 className="text-xl font-bold uppercase tracking-wide">Route Manifest</h1>
                                <p className="font-bold text-md">{today.toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div className="text-right space-y-1">
                            <div className="text-base"><span className="font-bold">Driver:</span> {driverName}</div>
                            <div className="text-base"><span className="font-bold">Truck:</span> {vehicle || "_______"}</div>
                        </div>
                    </div>
                    <table className="w-full border-collapse border border-black mb-4">
                        <thead><tr className="bg-white"><th className="border border-black p-1 w-8">#</th><th className="border border-black p-2 text-left">Customer / Address</th><th className="border border-black p-2 w-20">Invoices</th><th className="border border-black p-2 w-10">Pcs</th><th className="border border-black p-2 w-32">Signature</th></tr></thead>
                        <tbody>
                            {routeData.map((stop, index) => (
                                <tr key={index} className="h-14">
                                    <td className="border border-black p-1 text-center font-bold">{index + 1}</td>
                                    <td className="border border-black p-2 align-top"><div className="font-bold text-sm truncate">{stop.nombre}</div><div className="text-[10px] text-gray-600 leading-tight">{stop.direccion}</div></td>
                                    <td className="border border-black p-1 text-center font-mono font-bold text-sm align-middle break-words">{stop.invoices || '-'}</td>
                                    <td className="border border-black p-1 text-center font-bold text-sm align-middle">{stop.pieces || '-'}</td>
                                    <td className="border border-black p-1"></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <div className="flex justify-between items-end mt-4 pt-4 border-t border-black">
                        <div className="text-[10px]"><div className="font-bold text-xs">{config.companyName || "COMPANY NAME"}</div><div>PHONE: {config.phone || "000-000-0000"}</div><div>{config.address || "Company Address"}</div></div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [dbReady, setDbReady] = useState(false);
            const [systemError, setSystemError] = useState(null);

            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [googleApiKey, setGoogleApiKey] = useState(null);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            const [view, setView] = useState('input'); 
            
            const [baseAddress, setBaseAddress] = useState('Orlando, FL'); // Valor por defecto seguro
            const [dwellTime, setDwellTime] = useState(6);
            const [companyConfig, setCompanyConfig] = useState({ companyName: "MI EMPRESA", phone: "", address: "" });
            const [savedPin, setSavedPin] = useState('0000'); 

            const [currentStops, setCurrentStops] = useState([]);
            const [routes, setRoutes] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            // Estados para Inputs y Modales
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [newDriverName, setNewDriverName] = useState('');
            const [newVehicleName, setNewVehicleName] = useState(''); 
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAddDetailsModal, setShowAddDetailsModal] = useState(false); 
            const [tempStopData, setTempStopData] = useState(null);
            const [tempInvoices, setTempInvoices] = useState('');
            const [tempPieces, setTempPieces] = useState('');
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [printData, setPrintData] = useState(null);
            const [selectedVehicleForPrint, setSelectedVehicleForPrint] = useState('');
            const [viewingDriver, setViewingDriver] = useState(null);

            const mainClientInputRef = useRef(null); 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const getUserCollection = (collName) => user ? window.fbCollection(window.fbDb, 'artifacts', appId, 'users', user.uid, collName) : null;
            const getUserDocRef = (collName, docId) => user ? window.fbDoc(window.fbDb, 'artifacts', appId, 'users', user.uid, collName, docId) : null;

            useEffect(() => {
                const fetchConfig = async () => {
                    try {
                        const response = await fetch('/config');
                        const data = await response.json();
                        if (data.firebaseConfig && data.firebaseConfig.apiKey) {
                            const tryInitFb = () => { if (window.initializeFirebaseGlobally) { if (window.initializeFirebaseGlobally(data.firebaseConfig)) setDbReady(true); } else setTimeout(tryInitFb, 50); };
                            tryInitFb();
                        } else { setSystemError("Falta Configuraci√≥n de Firebase."); setAuthLoading(false); }
                        if (data.googleApiKey) setGoogleApiKey(data.googleApiKey);
                    } catch (err) { setAuthLoading(false); }
                };
                fetchConfig();
            }, []);

            useEffect(() => {
                const initAuth = () => {
                    if (window.fbOnAuthStateChanged) {
                        window.fbOnAuthStateChanged(window.fbAuth, (currentUser) => { setUser(currentUser); setAuthLoading(false); });
                    } else { setTimeout(initAuth, 100); }
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (!user || !window.fbDb || !dbReady) return;
                window.fbOnSnapshot(window.fbQuery(getUserCollection("clients"), window.fbOrderBy("name")), (s) => setClientDB(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("drivers"), window.fbOrderBy("name")), (s) => setDrivers(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("draft_stops"), window.fbOrderBy("createdAt", "desc")), (s) => setCurrentStops(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                window.fbOnSnapshot(window.fbQuery(getUserCollection("vehicles"), window.fbOrderBy("name")), (s) => setVehicles(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                
                const userSettingsRef = getUserDocRef("settings", "config");
                window.fbOnSnapshot(userSettingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.baseAddress) setBaseAddress(data.baseAddress);
                        if (data.companyName) setCompanyConfig(prev => ({ ...prev, companyName: data.companyName }));
                        if (data.companyPhone) setCompanyConfig(prev => ({ ...prev, phone: data.companyPhone }));
                        if (data.companyAddress) setCompanyConfig(prev => ({ ...prev, address: data.companyAddress }));
                        if (data.adminPin) setSavedPin(data.adminPin);
                    }
                });
            }, [user, dbReady]);

            useEffect(() => {
                if (!googleApiKey) return;
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&loading=async`;
                script.async = true; script.defer = true;
                script.onload = () => setTimeout(() => setScriptLoaded(true), 100);
                document.head.appendChild(script);
            }, [googleApiKey]);

            // Acciones B√°sicas
            const addDriverToFb = async (name) => { if(window.fbDb) await window.fbAddDoc(getUserCollection("drivers"), { name, active: true }); };
            const deleteDriver = async (id) => { if(window.fbDb && confirm('Delete?')) await window.fbDeleteDoc(getUserDocRef("drivers", id)); };
            const toggleDriver = async (id, status) => { if(window.fbDb) await window.fbUpdateDoc(getUserDocRef("drivers", id), { active: !status }); };
            const handleLogout = () => { if(window.fbSignOut && window.fbAuth) window.fbSignOut(window.fbAuth); else window.location.reload(); };
            
            const handleOptimize = async () => { 
                const activeDrivers = drivers.filter(d => d.active); 
                if (currentStops.length === 0) return setError('No hay paradas.'); 
                setLoading(true); setError(''); 
                try { 
                    const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: currentStops, num_vans: activeDrivers.length, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); 
                    const d = await res.json(); 
                    if (!res.ok) throw new Error(d.error || 'Server error.');
                    const assigned = {}; Object.keys(d).forEach((k, i) => assigned[activeDrivers[i] ? activeDrivers[i].name : k] = d[k]); 
                    setRoutes(assigned); 
                    setView('results'); 
                } catch (e) { setError(e.message); } finally { setLoading(false); } 
            };

            const initiateAddStop = () => {
                if (!newStopAddress) return;
                setTempStopData({ name: newStopName || 'Client', address: newStopAddress }); setTempInvoices(''); setTempPieces(''); setShowAddDetailsModal(true);
            };

            const confirmAddStop = async () => {
                await window.fbAddDoc(getUserCollection("draft_stops"), { name: tempStopData.name, address: tempStopData.address, invoices: tempInvoices, pieces: tempPieces, createdAt: Date.now() });
                setNewStopName(''); setNewStopAddress(''); setShowAddDetailsModal(false); setTempStopData(null);
            };

            const openDriverMap = (name, data) => setViewingDriver({ name, data });
            const filteredClients = useMemo(() => clientDB.filter(c => (c.name || "").toLowerCase().includes(newStopName.toLowerCase())).slice(0, 5), [newStopName, clientDB]);

            if (systemError) return <ConfigErrorScreen errorDetails={systemError} />;
            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-ess-blue font-bold text-lg">Cargando...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen text-slate-800 bg-white pb-24">
                    {/* MODALES Y MAPAS */}
                    {printData && showPrintModal && <PrintableSheet routeData={printData.stops} driverName={printData.driverName} vehicle={selectedVehicleForPrint} config={companyConfig} />}
                    {viewingDriver && (<div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 animate-fade-in"><div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden relative"><div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center z-10 relative"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="map" className="h-5 w-5 text-ess-blue" /> Ruta: {viewingDriver.name}</h3><button onClick={() => setViewingDriver(null)} className="text-slate-400 hover:text-red-500"><Icon name="x" className="h-6 w-6" /></button></div><div className="flex-1 relative w-full h-full"><GlobalMapView routes={{ [viewingDriver.name]: viewingDriver.data }} baseAddress={baseAddress} /></div></div></div>)}
                    {showAddDetailsModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 no-print animate-fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm"><h3 className="font-bold text-lg mb-4 text-slate-800">Detalles de Parada</h3><div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Cliente</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none bg-slate-50" value={tempStopData?.name || ''} disabled /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Invoices (Opcional)</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none" value={tempInvoices} onChange={e => setTempInvoices(e.target.value)} autoFocus /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Piezas</label><input type="number" className="w-full p-3 border border-slate-300 rounded-lg outline-none" value={tempPieces} onChange={e => setTempPieces(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && confirmAddStop()} /></div></div><div className="mt-6 flex gap-3"><button onClick={() => setShowAddDetailsModal(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-bold">Cancelar</button><button onClick={confirmAddStop} className="flex-1 py-3 bg-ess-blue text-white rounded-lg font-bold shadow-lg">Guardar</button></div></div></div>)}

                    {/* HEADER */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 no-print">
                         <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4"><h1 className="text-xl font-bold text-ess-blue leading-none">Route Planner</h1></div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setView('input')} className={`text-sm font-medium px-3 py-2 rounded-lg flex items-center gap-2 ${view === 'input' ? 'bg-ess-blue text-white' : 'text-slate-600 bg-slate-50'}`}><Icon name="layout-dashboard" className="h-4 w-4" /> Planner</button>
                                <button onClick={handleLogout} className="text-sm font-medium text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg ml-2">Salir</button>
                            </div>
                        </div>
                    </header>

                    {/* MAIN */}
                    <main className="max-w-7xl mx-auto p-6 no-print">
                        {view === 'input' && (
                            <div className="grid lg:grid-cols-12 gap-8 animate-fade-in">
                                <div className="lg:col-span-7 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow relative z-20">
                                            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">Agregar Parada</h2>
                                            <div className="grid md:grid-cols-2 gap-4 mb-4">
                                                <div className="relative">
                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Cliente</label>
                                                    <input ref={mainClientInputRef} type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Nombre" value={newStopName} onChange={(e) => { setNewStopName(e.target.value); setShowSuggestions(true); }} />
                                                    {showSuggestions && filteredClients.length > 0 && <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 overflow-hidden z-50">{filteredClients.map((c, i) => (<div key={i} onClick={() => { setNewStopName(c.name); setNewStopAddress(c.address); setShowSuggestions(false); }} className="p-3 cursor-pointer hover:bg-blue-50 border-b border-slate-50"><div className="font-bold text-slate-700 text-sm">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}
                                                </div>
                                                <div className="relative">
                                                    <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Direcci√≥n</label>
                                                    <GoogleAddressInput value={newStopAddress} onChange={(e) => setNewStopAddress(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && initiateAddStop()} className="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="Buscar en Google Maps" disabled={!scriptLoaded} isLoaded={scriptLoaded} />
                                                </div>
                                            </div>
                                            <div className="flex justify-end"><button onClick={initiateAddStop} disabled={!newStopAddress} className="bg-ess-blue text-white px-6 py-2.5 rounded-lg font-bold shadow-md flex items-center gap-2 disabled:opacity-50">Siguiente</button></div>
                                    </div>
                                    <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden min-h-[300px]">
                                            <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold text-slate-700">Ruta de Hoy ({currentStops.length})</h3></div>
                                            <div className="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">
                                                {currentStops.map((stop, idx) => (
                                                    <div key={stop.id} className="p-4 flex items-center gap-4 hover:bg-slate-50 group">
                                                        <div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold text-sm border border-slate-200">{idx + 1}</div>
                                                        <div className="flex-1"><h4 className="font-bold text-slate-800">{stop.name}</h4><p className="text-sm text-slate-500">{stop.address}</p></div>
                                                        <button onClick={async () => { if(window.fbDb) await window.fbDeleteDoc(getUserDocRef("draft_stops", stop.id)); }} className="text-red-500 hover:bg-red-50 p-2 rounded"><Icon name="trash-2" className="h-4 w-4" /></button>
                                                    </div>
                                                ))}
                                            </div>
                                    </div>
                                </div>
                                <div className="lg:col-span-5 space-y-6">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-700 mb-4 pb-3 border-b border-slate-100">Conductores Activos</h3>
                                        <div className="grid gap-2 mb-4">{drivers.map(driver => (<label key={driver.id} className={`flex items-center justify-between p-2 rounded-lg border cursor-pointer ${driver.active ? 'border-green-500 bg-green-50' : 'border-slate-200'}`}><span className="font-bold text-sm">{driver.name}</span><input type="checkbox" checked={driver.active} onChange={() => toggleDriver(driver.id, driver.active)} className="accent-green-600" /></label>))}</div>
                                        <div className="flex gap-2"><input type="text" className="flex-1 p-2 border rounded text-sm" placeholder="Nuevo Conductor" value={newDriverName} onChange={e => setNewDriverName(e.target.value)} /><button onClick={() => { if(newDriverName) { addDriverToFb(newDriverName); setNewDriverName(''); }}} className="bg-slate-800 text-white px-3 rounded">+</button></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow sticky top-24">
                                        {error && <div className="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg border border-red-200">{error}</div>}
                                        {routes && <button onClick={() => setView('results')} className="w-full bg-white border-2 border-ess-green text-ess-green hover:bg-green-50 py-4 rounded-xl font-bold text-lg shadow-lg mb-3">VER RESULTADOS</button>}
                                        <button onClick={handleOptimize} disabled={loading} className="w-full bg-ess-green hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg disabled:opacity-75">{loading ? "Calculando..." : "GENERAR RUTA"}</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'results' && routes && (
                            <div className="animate-fade-in space-y-8">
                                <button onClick={() => setView('input')} className="text-slate-600 px-6 py-3 rounded-lg font-bold border border-slate-200 bg-white hover:bg-slate-50">‚Üê Volver</button>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                                    {Object.entries(routes).map(([driverName, data]) => (
                                        <div key={driverName} className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden">
                                            <div className="bg-slate-50 p-5 border-b border-slate-100 flex justify-between items-center"><h3 className="font-bold text-xl text-slate-800">{driverName}</h3><div className="text-xs font-bold bg-white px-2 py-1 rounded border">{Math.round(data.duracion_estimada / 60)}h {Math.round(data.duracion_estimada % 60)}m</div></div>
                                            <ul className="divide-y divide-slate-100 max-h-[400px] overflow-y-auto">{data.paradas.map((stop, i) => (<li key={i} className="p-3 flex gap-3 hover:bg-slate-50"><span className="font-bold text-slate-400">#{i+1}</span><div><div className="font-bold text-sm">{stop.nombre}</div><div className="text-xs text-slate-500">{stop.direccion}</div></div></li>))}</ul>
                                            <div className="p-4 bg-slate-50 border-t flex gap-2">
                                                <button onClick={() => openDriverMap(driverName, data)} className="flex-1 bg-white border font-bold py-2 rounded text-sm hover:bg-blue-50">Ver Mapa</button>
                                                <button onClick={() => { setPrintData({ driverName, stops: data.paradas }); setShowPrintModal(true); }} className="px-3 bg-slate-800 text-white rounded"><Icon name="printer" className="h-4 w-4" /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
