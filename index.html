<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Sign Supply Route Planner</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs (Módulos) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.initializeFirebaseGlobally = (config) => {
            try {
                if (!config.apiKey || config.apiKey.includes("Pega_aquí")) {
                    throw new Error("Invalid API Key in configuration.");
                }
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                
                window.firebaseReady = true; 
                console.log("✅ Firebase Initialized Securely.");
                return true;
            } catch (e) {
                console.error("❌ Firebase Initialization Error:", e);
                window.firebaseInitError = e.message;
                return false;
            }
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ess: { blue: '#1b6e9b', green: '#6bbf5d', dark: '#0f4c6e', light: '#f0f9ff' } } }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .pac-container { z-index: 99999 !important; border-radius: 8px; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; font-family: 'Inter', sans-serif; }
        .pac-item { padding: 10px 12px; cursor: pointer; font-size: 14px; }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        .draggable-source { opacity: 0.4; border: 2px dashed #cbd5e1; background: #f8fafc; }
        .drop-target { background-color: #f0f9ff; border: 2px dashed #1b6e9b; }
        #global-map-container { height: 70vh; width: 100%; border-radius: 12px; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Checkbox Custom Style */
        .custom-checkbox { width: 20px; height: 20px; accent-color: #1b6e9b; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ERROR SCREEN ---
        const ConfigErrorScreen = ({ errorDetails }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border-l-4 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="h-8 w-8" /> System Error</h1>
                    <p className="text-slate-600 mb-4 font-bold">Connection failed.</p>
                    <div className="bg-red-50 p-4 rounded-lg border border-red-200 text-sm font-mono text-red-800 mb-4 break-words">Error: {errorDetails || "Unknown Configuration Error"}</div>
                    <button onClick={() => window.location.reload()} className="mt-6 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors">Retry Connection</button>
                </div>
            </div>
        );

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                if (!window.fbSignIn) { setError("System not ready."); setLoading(false); return; }
                try { await window.fbSignIn(window.fbAuth, email, password); } 
                catch (err) { setError("Access Denied."); setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-16 mx-auto mb-4"/>
                            <h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Email</label><input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Password</label><input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold hover:bg-sky-700 transition-colors flex justify-center">{loading ? <div className="loader"></div> : "Sign In"}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS ---
        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                if (iconData) { const el = lucide.createElement(iconData); el.setAttribute('class', className); setSvgHtml(el.outerHTML); }
            }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded }) => {
            const inputRef = useRef(null);
            const autoCompleteRef = useRef(null);
            useEffect(() => {
                if (!isLoaded) return;
                const attemptInitialization = () => {
                    if (!window.google || !window.google.maps || !window.google.maps.places) { setTimeout(attemptInitialization, 300); return; }
                    if (!inputRef.current || autoCompleteRef.current) return;
                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, { types: ['geocode', 'establishment'], componentRestrictions: { country: "us" }, fields: ['formatted_address', 'name', 'geometry'] });
                        autocomplete.addListener("place_changed", () => { const place = autocomplete.getPlace(); if (place.formatted_address) onChange({ target: { value: place.formatted_address } }); });
                        autoCompleteRef.current = autocomplete;
                    } catch (e) { setTimeout(attemptInitialization, 500); }
                };
                attemptInitialization();
            }, [isLoaded]);
            return <input ref={inputRef} type="text" value={value} onChange={onChange} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        const GlobalMapView = ({ routes, baseAddress }) => {
            const mapRef = useRef(null);
            const ROUTE_COLORS = ["#1b6e9b", "#6bbf5d", "#e11d48", "#d97706", "#7c3aed", "#db2777"];
            useEffect(() => {
                if (!window.google || !mapRef.current) return;
                const map = new window.google.maps.Map(mapRef.current, { zoom: 10, center: { lat: 28.5383, lng: -81.3792 }, mapTypeControl: false, streetViewControl: false });
                const directionsService = new window.google.maps.DirectionsService();
                const bounds = new window.google.maps.LatLngBounds();
                Object.entries(routes).forEach(([driverName, routeData], index) => {
                    if (routeData.paradas.length === 0) return;
                    const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                    const waypoints = routeData.paradas.map(stop => ({ location: stop.direccion, stopover: true }));
                    directionsService.route({ origin: baseAddress, destination: baseAddress, waypoints: waypoints, optimizeWaypoints: false, travelMode: window.google.maps.TravelMode.DRIVING }, (response, status) => {
                        if (status === 'OK') {
                            new window.google.maps.DirectionsRenderer({ map: map, directions: response, polylineOptions: { strokeColor: color, strokeOpacity: 0.7, strokeWeight: 5 }, suppressMarkers: false, preserveViewport: true });
                            bounds.union(response.routes[0].bounds);
                            map.fitBounds(bounds);
                        }
                    });
                });
            }, [routes, baseAddress]);
            return (<div className="animate-fade-in space-y-4"><div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-4 items-center justify-between"><h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="map" className="h-5 w-5 text-ess-blue" /> Global Fleet Map</h2><div className="flex flex-wrap gap-3">{Object.keys(routes).map((driver, index) => (<div key={driver} className="flex items-center gap-1.5 text-xs font-medium text-slate-600"><span className="w-3 h-3 rounded-full" style={{ backgroundColor: ROUTE_COLORS[index % ROUTE_COLORS.length] }}></span>{driver}</div>))}</div></div><div className="bg-white p-1 rounded-xl border border-slate-200 shadow-lg"><div id="global-map-container" ref={mapRef}></div></div></div>);
        };

        // --- APP PRINCIPAL ---
        function App() {
            // STATES
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [systemError, setSystemError] = useState(null); 
            const [dbReady, setDbReady] = useState(false);

            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);
            const [googleApiKey, setGoogleApiKey] = useState(null);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            const [view, setView] = useState('input'); 
            const [baseAddress, setBaseAddress] = useState('8350 Parkline Blvd, Orlando, FL 32809, EE. UU.');
            const [dwellTime, setDwellTime] = useState(10); 
            const [currentStops, setCurrentStops] = useState([]);
            
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [newDriverName, setNewDriverName] = useState('');
            const [clientFormName, setClientFormName] = useState('');
            const [clientFormAddress, setClientFormAddress] = useState('');
            const [editingClientId, setEditingClientId] = useState(null);
            const [selectedClients, setSelectedClients] = useState([]);

            const [routes, setRoutes] = useState(null);
            const [originalRoutes, setOriginalRoutes] = useState(null); 
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [recalculating, setRecalculating] = useState({});
            const [isRecalculatingAll, setIsRecalculatingAll] = useState(false);
            
            // --- NUEVOS ESTADOS PARA TABLET/SELECCIÓN ---
            const [selectedStops, setSelectedStops] = useState([]); // [{driver: 'Jorge', index: 0}, ...]
            
            // --- 1. PERSISTENCIA DE RUTA ACTUAL (Draft Mode) ---
            useEffect(() => {
                // Cargar al inicio
                const savedStops = localStorage.getItem('ess_draft_stops');
                if (savedStops) {
                    try { setCurrentStops(JSON.parse(savedStops)); } catch (e) {}
                }
            }, []);

            useEffect(() => {
                // Guardar cada vez que cambie
                localStorage.setItem('ess_draft_stops', JSON.stringify(currentStops));
            }, [currentStops]);

            const clearDraftRoute = () => {
                if(confirm("Are you sure you want to clear the entire list?")) {
                    setCurrentStops([]);
                    localStorage.removeItem('ess_draft_stops');
                }
            };

            // --- INIT & AUTH ---
            useEffect(() => {
                const fetchConfig = async () => {
                    try {
                        const response = await fetch('/config');
                        const data = await response.json();
                        if (data.firebaseConfig && data.firebaseConfig.apiKey) {
                            const tryInitFb = () => {
                                if (window.initializeFirebaseGlobally) {
                                    const success = window.initializeFirebaseGlobally(data.firebaseConfig);
                                    if (success) setDbReady(true); 
                                } else { setTimeout(tryInitFb, 50); }
                            };
                            tryInitFb();
                        } else {
                            setSystemError("Missing Firebase Variables in Render.");
                            setAuthLoading(false); return;
                        }
                        if (data.googleApiKey) setGoogleApiKey(data.googleApiKey);
                    } catch (err) { setAuthLoading(false); }
                };
                fetchConfig();
            }, []);

            useEffect(() => {
                let attempts = 0;
                const initAuth = () => {
                    if (window.firebaseInitError) { setSystemError(window.firebaseInitError); setAuthLoading(false); return; }
                    if (window.fbOnAuthStateChanged) {
                        window.fbOnAuthStateChanged(window.fbAuth, (currentUser) => { setUser(currentUser); setAuthLoading(false); });
                    } else {
                        attempts++;
                        if (!systemError) setTimeout(initAuth, 100);
                    }
                };
                initAuth();
            }, [systemError]);

            // --- DATA SYNC ---
            useEffect(() => {
                if (!user || !window.fbDb || !dbReady) return;
                const qClients = window.fbQuery(window.fbCollection(window.fbDb, "clients"), window.fbOrderBy("name"));
                window.fbOnSnapshot(qClients, (s) => setClientDB(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const qDrivers = window.fbQuery(window.fbCollection(window.fbDb, "drivers"), window.fbOrderBy("name"));
                window.fbOnSnapshot(qDrivers, (s) => {
                    const d = s.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (d.length === 0 && !localStorage.getItem('drivers_initialized')) {
                        addDriverToFb("Jorge"); addDriverToFb("Miguel"); addDriverToFb("Carlos");
                        localStorage.setItem('drivers_initialized', 'true');
                    }
                    setDrivers(d);
                });
            }, [user, dbReady]);

            useEffect(() => {
                if (!googleApiKey) return;
                if (window.google && window.google.maps && window.google.maps.places) { setScriptLoaded(true); return; }
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&loading=async`;
                script.async = true; script.defer = true;
                script.onload = () => setTimeout(() => setScriptLoaded(true), 100);
                document.head.appendChild(script);
            }, [googleApiKey]);

            // --- ACTIONS ---
            const addDriverToFb = async (name) => { if(window.fbDb) await window.fbAddDoc(window.fbCollection(window.fbDb, "drivers"), { name, active: true }); };
            const toggleDriver = async (id, status) => { if(window.fbDb) await window.fbUpdateDoc(window.fbDoc(window.fbDb, "drivers", id), { active: !status }); };
            const deleteDriver = async (id) => { if(window.fbDb && confirm('Delete?')) await window.fbDeleteDoc(window.fbDoc(window.fbDb, "drivers", id)); };
            const saveClient = async () => { if (!clientFormName || !window.fbDb) return; if (editingClientId) { await window.fbUpdateDoc(window.fbDoc(window.fbDb, "clients", editingClientId), { name: clientFormName, address: clientFormAddress }); setEditingClientId(null); } else { await window.fbAddDoc(window.fbCollection(window.fbDb, "clients"), { name: clientFormName, address: clientFormAddress }); } setClientFormName(''); setClientFormAddress(''); };
            const deleteClient = async (id) => { if(window.fbDb && confirm('Delete?')) { await window.fbDeleteDoc(window.fbDoc(window.fbDb, "clients", id)); setSelectedClients(selectedClients.filter(c => c !== id)); } };
            
            // --- ADD STOP CON VALIDACIÓN DE DUPLICADOS ---
            const addStop = () => { 
                if (!newStopAddress) return; 
                
                // --- DUPLICATE CHECK ---
                const isDuplicate = currentStops.some(s => s.address === newStopAddress);
                if (isDuplicate) {
                    const proceed = confirm("This client is already listed for today's route. Do you want to continue anyway?");
                    if (!proceed) return;
                }
                // -----------------------

                const stop = { id: Date.now(), name: newStopName || 'Client', address: newStopAddress }; 
                setCurrentStops([...currentStops, stop]); 
                if (!clientDB.some(c => c.address === stop.address) && window.fbDb) window.fbAddDoc(window.fbCollection(window.fbDb, "clients"), { name: stop.name, address: stop.address }); 
                setNewStopName(''); 
                setNewStopAddress(''); 
            };

            const removeStop = (id) => setCurrentStops(currentStops.filter(s => s.id !== id));
            const selectClient = (c) => { setNewStopName(c.name); setNewStopAddress(c.address); };
            const handleLogout = () => window.fbSignOut(window.fbAuth);
            
            // --- OPTIMIZATION & LOOKUP ---
            const getClientNameFromAddress = (address) => {
                // Buscamos primero en el draft actual, luego en la BD completa
                const fromDraft = currentStops.find(s => s.address === address);
                if (fromDraft) return fromDraft.name;
                const fromDB = clientDB.find(c => c.address === address);
                return fromDB ? fromDB.name : "Client";
            };

            const handleOptimize = async () => { 
                const activeDrivers = drivers.filter(d => d.active); 
                if (currentStops.length === 0) return setError('No stops.'); 
                setLoading(true); setError(''); 
                try { 
                    const res = await fetch('/optimizar', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ direcciones: currentStops.map(s=>s.address), num_vans: activeDrivers.length, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); 
                    const d = await res.json(); 
                    
                    if (!res.ok) {
                        // DETECCIÓN DE DIRECCIONES INVÁLIDAS
                        if (d.invalid_addresses && d.invalid_addresses.length > 0) {
                            const badAddresses = d.invalid_addresses.map(a => `• ${a}`).join('\n');
                            throw new Error(`Google Maps no encontró estas direcciones:\n${badAddresses}\n\nPor favor, corrígelas.`);
                        }
                        throw new Error(d.error || 'Server error.');
                    }
                    
                    const assigned = {}; 
                    Object.keys(d).forEach((k, i) => assigned[activeDrivers[i] ? activeDrivers[i].name : k] = d[k]); 
                    setRoutes(assigned); 
                    setOriginalRoutes(JSON.parse(JSON.stringify(assigned))); 
                    setView('results'); 
                } catch (e) { 
                    setError(e.message); // El mensaje ahora será detallado
                } finally { 
                    setLoading(false); 
                } 
            };

            const recalculateRoute = async (dName, stops) => { 
                setRecalculating(p => ({...p, [dName]: true})); 
                try { 
                    const res = await fetch('/recalcular', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ paradas: stops, base_address: baseAddress, dwell_time: parseInt(dwellTime) }) }); 
                    const d = await res.json(); 
                    setRoutes(p => ({...p, [dName]: {...p[dName], duracion_estimada: d.duracion_estimada, link: d.link, paradas: stops}})); 
                } catch (e) { console.error(e); } finally { setRecalculating(p => ({...p, [dName]: false})); } 
            };

            const handleOptimizeRemaining = async (driverName) => {
                const currentRoute = routes[driverName].paradas;
                if (currentRoute.length < 3) {
                    alert("Needs at least 3 stops (Fixed #1 + 2 others) to optimize.");
                    return;
                }
                
                setRecalculating(p => ({...p, [driverName]: true})); 
                try {
                    const res = await fetch('/optimizar_restantes', { 
                        method: 'POST', 
                        headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify({ 
                            paradas: currentRoute, 
                            base_address: baseAddress, 
                            dwell_time: parseInt(dwellTime) 
                        }) 
                    });
                    
                    const d = await res.json();
                    if(!res.ok) throw new Error(d.error);
                    
                    // Actualizamos con la nueva ruta optimizada
                    setRoutes(p => ({
                        ...p, 
                        [driverName]: {
                            ...p[driverName], 
                            duracion_estimada: d.duracion_estimada, 
                            link: d.link, 
                            paradas: d.paradas
                        }
                    }));
                } catch (e) {
                    console.error(e);
                    alert("Optimization failed: " + e.message);
                } finally {
                    setRecalculating(p => ({...p, [driverName]: false})); 
                }
            };

            const handleRecalculateAll = async () => { if (!routes) return; setIsRecalculatingAll(true); await Promise.all(Object.keys(routes).map(d => recalculateRoute(d, routes[d].paradas))); setIsRecalculatingAll(false); };
            const handleRestore = () => { if (confirm("Restore original routes?")) setRoutes(JSON.parse(JSON.stringify(originalRoutes))); };

            // --- REVERSE FUNCTION ---
            const reverseRoute = (driverName) => {
                const newRoutes = JSON.parse(JSON.stringify(routes));
                newRoutes[driverName].paradas.reverse();
                setRoutes(newRoutes);
                recalculateRoute(driverName, newRoutes[driverName].paradas);
            };

            // --- TABLET/MOBILE ACTIONS (MOVE & TRANSFER) ---
            const toggleStopSelection = (driverName, index) => {
                setSelectedStops(prev => {
                    const exists = prev.find(p => p.driver === driverName && p.index === index);
                    if (exists) return prev.filter(p => !(p.driver === driverName && p.index === index));
                    return [...prev, { driver: driverName, index }];
                });
            };

            const moveStop = (driverName, index, direction) => {
                const newRoutes = JSON.parse(JSON.stringify(routes));
                const stops = newRoutes[driverName].paradas;
                const newIndex = index + direction;
                
                if (newIndex < 0 || newIndex >= stops.length) return; // Out of bounds

                // Swap
                [stops[index], stops[newIndex]] = [stops[newIndex], stops[index]];
                setRoutes(newRoutes);
                recalculateRoute(driverName, stops);
            };

            const transferSelectedStops = (targetDriver) => {
                if (selectedStops.length === 0) return;
                
                const newRoutes = JSON.parse(JSON.stringify(routes));
                // Sort selected stops by index descending to avoid shift issues when splicing
                const sortedSelection = [...selectedStops].sort((a, b) => b.index - a.index);
                
                const movedItems = [];

                // Remove from sources
                sortedSelection.forEach(sel => {
                    const [removed] = newRoutes[sel.driver].paradas.splice(sel.index, 1);
                    movedItems.push(removed);
                });

                // Add to target (reverse to maintain relative order if needed, or just push)
                movedItems.reverse().forEach(item => {
                    newRoutes[targetDriver].paradas.push(item);
                });

                setRoutes(newRoutes);
                setSelectedStops([]); // Clear selection

                // Recalculate all affected drivers
                const affectedDrivers = new Set(sortedSelection.map(s => s.driver));
                affectedDrivers.add(targetDriver);
                
                affectedDrivers.forEach(d => recalculateRoute(d, newRoutes[d].paradas));
            };

            const getWhatsappLink = (l) => `https://wa.me/?text=${encodeURIComponent(`Hello, route:\n\n${l}\n\nDrive safely!`)}`;
            const filteredClients = useMemo(() => { const t = newStopName.toLowerCase().trim(); return t ? clientDB.filter(c => c.name.toLowerCase().includes(t)).slice(0, 5) : []; }, [newStopName, clientDB]);

            if (systemError) return <ConfigErrorScreen errorDetails={systemError} />;
            if (authLoading) return <div className="min-h-screen flex items-center justify-center text-ess-blue font-bold text-lg"><div className="loader mr-3"></div> Loading System...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen text-slate-800 bg-white pb-24">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto"/>
                                <div className="hidden md:block pl-4 border-l border-slate-200"><h1 className="text-xl font-bold text-ess-blue leading-none">Route Planner</h1><p className="text-xs text-slate-400 mt-1">Logged as: <span className="font-bold text-ess-green">{user.email}</span></p></div>
                            </div>
                            <div className="flex items-center gap-3">
                                {view !== 'clients' ? <button onClick={() => setView('clients')} className="text-sm font-medium text-slate-600 hover:text-ess-blue bg-slate-50 border border-slate-200 px-3 py-2 rounded-lg flex items-center gap-2"><Icon name="database" className="h-4 w-4" /> Clients</button> : <button onClick={() => setView('input')} className="text-sm font-medium text-white bg-ess-blue px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="layout-dashboard" className="h-4 w-4" /> Planner</button>}
                                <button onClick={handleLogout} className="text-sm font-medium text-red-500 hover:bg-red-50 border border-transparent hover:border-red-100 px-3 py-2 rounded-lg flex items-center gap-2"><Icon name="log-out" className="h-4 w-4" /> Exit</button>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto p-6">
                        {view !== 'clients' && <div className="mb-6 flex justify-end"><div className="bg-ess-light px-4 py-2 rounded-lg border border-blue-100 flex items-center gap-2 w-full md:w-auto"><Icon name="map-pin" className="h-5 w-5 text-ess-blue shrink-0" /><div className="text-xs w-full"><span className="block text-slate-400 font-semibold uppercase">Base (Start/End)</span><GoogleAddressInput value={baseAddress} onChange={(e) => setBaseAddress(e.target.value)} className="bg-transparent font-bold text-slate-700 outline-none w-full" placeholder="Warehouse" disabled={!scriptLoaded} isLoaded={scriptLoaded} /></div></div></div>}
                        {view === 'global_map' && <div><div className="flex justify-between mb-6"><button onClick={() => setView('results')} className="text-slate-600 hover:text-ess-blue px-4 py-2 rounded-lg font-bold border border-slate-200 flex items-center gap-2"><Icon name="arrow-left" className="h-5 w-5" /> Back</button></div><GlobalMapView routes={routes} baseAddress={baseAddress} /></div>}
                        {view === 'clients' && (
                            <div className="max-w-4xl mx-auto animate-fade-in"><div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden"><div className="bg-slate-50 p-6 border-b border-slate-200 flex justify-between items-center"><div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="database" className="h-5 w-5 text-ess-blue" /> Cloud Database</h2></div><span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-slate-600 border border-slate-200">{clientDB.length} Clients</span></div><div className="p-6 bg-blue-50/50 border-b border-slate-200"><div className="flex flex-col md:flex-row gap-4"><input type="text" className="flex-1 p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Client Name" value={clientFormName} onChange={(e) => setClientFormName(e.target.value)} /><div className="flex-[2]"><GoogleAddressInput value={clientFormAddress} onChange={(e) => setClientFormAddress(e.target.value)} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Address" disabled={!scriptLoaded} isLoaded={scriptLoaded} /></div><button onClick={saveClient} disabled={!clientFormName || !clientFormAddress} className="bg-ess-green text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2"><Icon name={editingClientId ? 'save' : 'plus'} className="h-4 w-4" /> {editingClientId ? 'Save' : 'Add'}</button></div></div><div className="max-h-[600px] overflow-y-auto"><table className="w-full text-left border-collapse"><tbody className="divide-y divide-slate-100">{clientDB.map(c => (<tr key={c.id} className="hover:bg-slate-50"><td className="p-4 font-medium">{c.name}</td><td className="p-4 text-sm text-slate-600">{c.address}</td><td className="p-4 text-right"><div className="flex justify-end gap-2"><button onClick={()=>{setEditingClientId(c.id); setClientFormName(c.name); setClientFormAddress(c.address)}} className="text-blue-600 p-1"><Icon name="pencil" className="h-4 w-4"/></button><button onClick={()=>deleteClient(c.id)} className="text-red-500 p-1"><Icon name="trash-2" className="h-4 w-4"/></button></div></td></tr>))}</tbody></table></div></div></div>
                        )}
                        {view === 'input' && (
                            <div className="grid lg:grid-cols-12 gap-8 animate-fade-in"><div className="lg:col-span-8 space-y-6"><div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow relative z-20"><h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><div className="bg-ess-green/10 p-2 rounded-full"><Icon name="plus" className="h-5 w-5 text-ess-green" /></div> Add Stop</h2><div className="grid md:grid-cols-2 gap-4 mb-4"><div className="relative"><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Client</label><input type="text" className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-ess-blue" placeholder="Name" value={newStopName} onChange={(e) => setNewStopName(e.target.value)} />{filteredClients.length > 0 && <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-xl rounded-lg mt-1 overflow-hidden z-50">{filteredClients.map((c, i) => (<div key={i} onClick={() => selectClient(c)} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50"><div className="font-bold text-slate-700 text-sm">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.address}</div></div>))}</div>}</div><div><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Address</label><GoogleAddressInput value={newStopAddress} onChange={(e) => setNewStopAddress(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-ess-blue" placeholder="Search Google Maps" disabled={!scriptLoaded} isLoaded={scriptLoaded} /></div></div><div className="flex justify-end"><button onClick={addStop} disabled={!newStopAddress} className="bg-ess-blue text-white px-6 py-2.5 rounded-lg font-bold shadow-md transition-colors flex items-center gap-2 disabled:opacity-50"><Icon name="corner-down-left" className="h-4 w-4" /> Add</button></div></div><div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden min-h-[300px]"><div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="list" className="h-5 w-5 text-slate-400" /> Today's Route</h3><div className="flex items-center gap-2">{currentStops.length > 0 && <button onClick={clearDraftRoute} className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 flex items-center gap-1"><Icon name="eraser" className="h-3 w-3" /> Clear List</button>}<span className="bg-ess-blue text-white text-xs font-bold px-2 py-1 rounded-full">{currentStops.length} Stops</span></div></div>{currentStops.length === 0 ? <div className="p-12 text-center text-slate-400"><Icon name="map" className="h-12 w-12 mx-auto mb-3 opacity-20" /><p>List is empty.</p></div> : <div className="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">{currentStops.map((stop, idx) => (<div key={stop.id} className="p-4 flex items-center gap-4 hover:bg-slate-50 group"><div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold text-sm border border-slate-200">{idx + 1}</div><div className="flex-1"><h4 className="font-bold text-slate-800">{stop.name}</h4><p className="text-sm text-slate-500 flex items-center gap-1"><Icon name="map-pin" className="h-3 w-3" /> {stop.address}</p></div><button onClick={() => removeStop(stop.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg"><Icon name="trash-2" className="h-4 w-4" /></button></div>))}</div>}</div></div><div className="lg:col-span-4 space-y-6"><div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow"><h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-3 border-b border-slate-100"><Icon name="users" className="h-5 w-5 text-ess-blue" /> Drivers (Cloud)</h3><div className="flex gap-2 mb-4"><input type="text" className="flex-1 p-2 border border-slate-300 rounded-lg text-sm outline-none" placeholder="Name..." value={newDriverName} onChange={(e) => setNewDriverName(e.target.value)} /><button onClick={() => {if(newDriverName.trim()){ addDriverToFb(newDriverName); setNewDriverName(''); }}} className="bg-slate-800 text-white px-3 rounded hover:bg-slate-900"><Icon name="plus" className="h-4 w-4" /></button></div><div className="space-y-3 mb-6 max-h-[300px] overflow-y-auto pr-1">{drivers.map(driver => (<div key={driver.id} className="group relative"><label className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer ${driver.active ? 'border-ess-green/50 bg-green-50/30' : 'border-slate-100 bg-slate-50 opacity-60'}`}><div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${driver.active ? 'bg-ess-green' : 'bg-slate-300'}`}></div><span className={`font-medium ${driver.active ? 'text-slate-800' : 'text-slate-500'}`}>{driver.name}</span></div><input type="checkbox" checked={driver.active} onChange={() => toggleDriver(driver.id, driver.active)} className="w-5 h-5 accent-ess-green" /></label><button onClick={(e) => { e.preventDefault(); deleteDriver(driver.id); }} className="absolute -right-2 -top-2 bg-white text-slate-400 hover:text-red-500 border border-slate-200 rounded-full p-1 opacity-0 group-hover:opacity-100 shadow-sm"><Icon name="x" className="h-3 w-3" /></button></div>))}</div></div><div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow"><h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-3 border-b border-slate-100"><Icon name="settings" className="h-5 w-5 text-ess-blue" /> Config</h3><div><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Dwell Time (min)</label><input type="number" min="0" className="w-full p-2 border border-slate-300 rounded text-sm outline-none" value={dwellTime} onChange={(e) => setDwellTime(e.target.value)} /></div></div><div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow sticky top-24">{error && <div className="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg border border-red-200 flex gap-2"><Icon name="alert-triangle" className="h-5 w-5 shrink-0 mt-0.5" /><span className="break-words font-medium">{error}</span></div>}<button onClick={handleOptimize} disabled={loading} className="w-full bg-ess-green hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-600/20 transition-all flex justify-center items-center gap-2 disabled:opacity-75">{loading ? <><div className="loader mr-2"></div> Working...</> : <><Icon name="zap" className="h-6 w-6" /> GENERATE</>}</button></div></div></div>
                        )}
                        
                        {view === 'results' && routes && (
                            <div className="animate-fade-in space-y-8">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <button onClick={() => setView('input')} className="text-slate-600 hover:text-ess-blue hover:bg-blue-50 px-6 py-3 rounded-lg font-bold transition-colors flex items-center gap-2 border border-slate-200"><Icon name="arrow-left" className="h-5 w-5" /> Back</button>
                                    <div className="flex gap-2">
                                        <button onClick={handleRestore} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 hover:text-ess-blue px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="rotate-ccw" className="h-3 w-3" /> Reset</button>
                                        <button onClick={() => setView('global_map')} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 hover:text-ess-blue px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Icon name="map" className="h-3 w-3" /> Map</button>
                                        <button onClick={handleRecalculateAll} disabled={isRecalculatingAll} className="text-xs font-bold text-white bg-ess-blue hover:bg-sky-700 px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm">{isRecalculatingAll ? <div className="loader w-3 h-3"></div> : <><Icon name="refresh-cw" className="h-3 w-3" /> Update</>}</button>
                                    </div>
                                </div>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {Object.entries(routes).map(([driverName, data]) => (
                                        <div key={driverName} className="bg-white rounded-xl border border-slate-200 card-shadow flex flex-col h-full overflow-hidden">
                                            <div className="bg-slate-50 p-5 border-b border-slate-100">
                                                <div className="flex justify-between items-center mb-4 relative">
                                                    <h3 className="font-bold text-xl text-slate-800 flex items-center gap-3">
                                                        <div className="bg-white p-2 rounded-lg border border-slate-200 shadow-sm"><Icon name="user" className="h-5 w-5 text-ess-blue" /></div> 
                                                        {driverName} 
                                                    </h3>
                                                    <span className="bg-ess-blue text-white text-xs font-bold px-3 py-1 rounded-full">{data.paradas.length} Stops</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-500">
                                                    <div className="bg-white p-2 rounded border border-slate-100 flex items-center gap-2">{recalculating[driverName] ? <div className="loader w-3 h-3"></div> : <><Icon name="clock" className="h-4 w-4 text-ess-green" /> {Math.floor(data.duracion_estimada / 60)}h {Math.round(data.duracion_estimada % 60)}m</>}</div>
                                                    
                                                    {/* NEW ACTIONS: REVERSE AND OPTIMIZE REMAINING */}
                                                    <div className="flex gap-1">
                                                        <button 
                                                            onClick={() => reverseRoute(driverName)}
                                                            className="bg-white hover:bg-blue-50 text-slate-600 hover:text-ess-blue p-1.5 rounded border border-slate-200 flex items-center justify-center transition-colors"
                                                            title="Reverse Order"
                                                        >
                                                            <Icon name="arrow-up-down" className="h-4 w-4" />
                                                        </button>
                                                        <button 
                                                            onClick={() => handleOptimizeRemaining(driverName)}
                                                            className="bg-white hover:bg-purple-50 text-slate-600 hover:text-purple-600 p-1.5 rounded border border-slate-200 flex items-center gap-1 text-xs font-bold transition-colors"
                                                            title="Optimize Rest (Fix #1)"
                                                        >
                                                            <Icon name="wand-2" className="h-4 w-4" /> Opt. Rest
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="p-0 flex-1 overflow-y-auto max-h-[500px]">
                                                <ul className="divide-y divide-slate-100">
                                                    {data.paradas.map((stop, index) => (
                                                        <li key={index} className={`p-4 hover:bg-slate-50 transition-colors flex gap-3 group items-start ${selectedStops.find(s => s.driver === driverName && s.index === index) ? 'bg-blue-50' : ''}`}>
                                                            
                                                            {/* CONTROL: CHECKBOX */}
                                                            <div className="pt-1">
                                                                <input 
                                                                    type="checkbox" 
                                                                    className="custom-checkbox"
                                                                    checked={!!selectedStops.find(s => s.driver === driverName && s.index === index)}
                                                                    onChange={() => toggleStopSelection(driverName, index)}
                                                                />
                                                            </div>

                                                            <div className="flex flex-col items-center gap-1 pt-1">
                                                                <span className="flex-shrink-0 w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold flex items-center justify-center border border-slate-200 group-hover:bg-ess-blue group-hover:text-white transition-colors">{index + 1}</span>
                                                                {index < data.paradas.length - 1 && <div className="w-0.5 h-full bg-slate-100 group-hover:bg-slate-200 min-h-[10px]"></div>}
                                                            </div>
                                                            
                                                            <div className="flex-1">
                                                                {/* NAME LOOKUP HERE */}
                                                                <div className="font-bold text-sm text-slate-800">{getClientNameFromAddress(stop.direccion)}</div>
                                                                <div className="text-xs text-slate-500 mt-0.5">{stop.direccion}</div>
                                                            </div>

                                                            {/* CONTROL: ARROWS */}
                                                            <div className="flex flex-col gap-1">
                                                                <button onClick={() => moveStop(driverName, index, -1)} disabled={index === 0} className="p-1 text-slate-400 hover:text-ess-blue disabled:opacity-20"><Icon name="chevron-up" className="h-4 w-4" /></button>
                                                                <button onClick={() => moveStop(driverName, index, 1)} disabled={index === data.paradas.length - 1} className="p-1 text-slate-400 hover:text-ess-blue disabled:opacity-20"><Icon name="chevron-down" className="h-4 w-4" /></button>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                            <div className="p-5 border-t border-slate-100 bg-slate-50/50 space-y-3">
                                                <a href={data.link} target="_blank" rel="noreferrer" className="w-full bg-white border border-slate-200 text-slate-700 hover:border-ess-blue hover:text-ess-blue font-bold py-2.5 rounded-lg transition-all flex justify-center items-center gap-2 text-sm shadow-sm"><Icon name="map" className="h-4 w-4" /> Open Map</a>
                                                <a href={getWhatsappLink(data.link)} target="_blank" rel="noreferrer" className="w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-2.5 rounded-lg transition-all flex justify-center items-center gap-2 text-sm shadow-sm"><Icon name="message-circle" className="h-4 w-4" /> WhatsApp</a>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {/* FLOATING TOOLBAR FOR TRANSFER */}
                                {selectedStops.length > 0 && (
                                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white p-4 rounded-xl shadow-2xl flex items-center gap-4 z-50 animate-fade-in w-11/12 max-w-lg">
                                        <div className="font-bold whitespace-nowrap">{selectedStops.length} Selected</div>
                                        <div className="h-6 w-px bg-slate-600"></div>
                                        <div className="flex items-center gap-2 overflow-x-auto w-full">
                                            <span className="text-xs text-slate-400 uppercase font-bold mr-2">Transfer to:</span>
                                            {drivers.filter(d => d.active).map(driver => (
                                                <button 
                                                    key={driver.id} 
                                                    onClick={() => transferSelectedStops(driver.name)}
                                                    className="bg-white text-slate-900 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-ess-green hover:text-white transition-colors whitespace-nowrap"
                                                >
                                                    {driver.name}
                                                </button>
                                            ))}
                                        </div>
                                        <button onClick={() => setSelectedStops([])} className="p-2 hover:bg-slate-700 rounded-full"><Icon name="x" className="h-5 w-5" /></button>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
