<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Sign Supply Route Planner</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, setDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.initializeFirebaseGlobally = (config) => {
            try {
                if (!config || !config.apiKey || config.apiKey.includes("Pega_aquí")) {
                    console.warn("⚠️ Esperando configuración de Firebase válida...");
                    return false; 
                }
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.fbAuth = auth;
                window.fbDb = db;
                window.fbSignIn = signInWithEmailAndPassword;
                window.fbSignOut = signOut;
                window.fbOnAuthStateChanged = onAuthStateChanged;
                window.fbSendPasswordResetEmail = sendPasswordResetEmail;
                window.fbUpdatePassword = updatePassword;
                window.fbCollection = collection;
                window.fbAddDoc = addDoc;
                window.fbSetDoc = setDoc; 
                window.fbOnSnapshot = onSnapshot;
                window.fbDoc = doc;
                window.fbUpdateDoc = updateDoc;
                window.fbDeleteDoc = deleteDoc;
                window.fbQuery = query;
                window.fbOrderBy = orderBy;
                window.fbGetDocs = getDocs;
                window.fbLimit = limit;
                window.fbWriteBatch = writeBatch;
                
                window.firebaseReady = true; 
                return true;
            } catch (e) {
                console.error("❌ Firebase Initialization Error:", e);
                window.firebaseInitError = e.message;
                return false;
            }
        };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ess: { blue: '#1b6e9b', green: '#6bbf5d', dark: '#0f4c6e', light: '#f0f9ff' } } }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* GOOGLE MAPS AUTOCOMPLETE FIXES */
        .pac-container { 
            z-index: 99999 !important; 
            border-radius: 8px; 
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border: 1px solid #e2e8f0; 
            font-family: 'Inter', sans-serif;
            max-width: 90vw !important; 
            white-space: normal !important;
        }
        .pac-item { 
            padding: 10px 12px; 
            cursor: pointer; 
            font-size: 14px; 
            white-space: normal !important; 
        }
        .pac-item:hover { background-color: #f0f9ff; }
        .pac-item-query { font-size: 14px; color: #1e293b; font-weight: 600; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #1b6e9b; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-checkbox { width: 20px; height: 20px; accent-color: #1b6e9b; cursor: pointer; }

        @media print {
            @page { size: portrait; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-sheet, #printable-sheet *, #global-manifest, #global-manifest * { visibility: visible; }
            #printable-sheet, #global-manifest { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- PALETA DE COLORES DE ALTO CONTRASTE ---
        const ZONE_COLORS = [
            { hex: "#e11d48", tw: "bg-rose-600 text-white" },      // Rojo
            { hex: "#2563eb", tw: "bg-blue-600 text-white" },      // Azul
            { hex: "#16a34a", tw: "bg-green-600 text-white" },     // Verde
            { hex: "#d97706", tw: "bg-amber-600 text-white" },     // Naranja
            { hex: "#7c3aed", tw: "bg-violet-600 text-white" },    // Violeta
            { hex: "#0891b2", tw: "bg-cyan-600 text-white" },      // Cian
            { hex: "#db2777", tw: "bg-pink-600 text-white" },      // Rosa
            { hex: "#4b5563", tw: "bg-gray-600 text-white" }       // Gris
        ];

        const ConfigErrorScreen = ({ errorDetails }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border-l-4 border-red-500">
                    <h1 className="text-2xl font-bold text-red-600 mb-2 flex items-center gap-2"><Icon name="alert-triangle" className="h-8 w-8" /> System Error</h1>
                    <p className="text-slate-600 mb-4 font-bold">Connection failed.</p>
                    <div className="bg-red-50 p-4 rounded-lg border border-red-200 text-sm font-mono text-red-800 mb-4 break-words">Error: {errorDetails || "Unknown Configuration Error"}</div>
                    <button onClick={() => window.location.reload()} className="mt-6 w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition-colors">Retry Connection</button>
                </div>
            </div>
        );

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                if (!window.fbSignIn) { setError("System not ready. Please refresh."); setLoading(false); return; }
                try { await window.fbSignIn(window.fbAuth, email, password); } 
                catch (err) { console.error(err); setError("Access Denied. Check credentials."); setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-16 mx-auto mb-4"/>
                            <h1 className="text-2xl font-bold text-ess-blue">Route Planner</h1>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Email</label><input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Password</label><input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-ess-blue outline-none" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg font-medium">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-ess-blue text-white py-3 rounded-lg font-bold hover:bg-sky-700 transition-colors flex justify-center">{loading ? <div className="loader"></div> : "Sign In"}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Icon = ({ name, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);
            useEffect(() => {
                if (typeof lucide === 'undefined') return;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = lucide.icons[iconName] || lucide.icons[name];
                if (iconData) { const el = lucide.createElement(iconData); el.setAttribute('class', className); setSvgHtml(el.outerHTML); }
            }, [name, className]);
            if (!svgHtml) return <span className={className}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'contents' }} />;
        };

        const GoogleAddressInput = ({ value, onChange, placeholder, className, disabled, isLoaded, onKeyDown, inputRef: propInputRef }) => {
            const innerRef = useRef(null);
            const inputRef = propInputRef || innerRef;
            const onChangeRef = useRef(onChange);
            
            useEffect(() => { onChangeRef.current = onChange; }, [onChange]);

            useEffect(() => {
                if (!isLoaded) return;
                const attemptInitialization = () => {
                    if (!window.google || !window.google.maps || !window.google.maps.places) { setTimeout(attemptInitialization, 300); return; }
                    if (!inputRef.current) return;
                    try {
                        const autocomplete = new window.google.maps.places.Autocomplete(inputRef.current, { types: ['geocode', 'establishment'], componentRestrictions: { country: "us" }, fields: ['formatted_address', 'name', 'geometry'] });
                        autocomplete.addListener("place_changed", () => { 
                            const place = autocomplete.getPlace(); 
                            const address = place.formatted_address || place.name;
                            if (address) { onChangeRef.current({ target: { value: address } }); }
                        });
                    } catch (e) { setTimeout(attemptInitialization, 500); }
                };
                attemptInitialization();
            }, [isLoaded]);
            
            return <input ref={inputRef} type="text" value={value} onChange={onChange} onKeyDown={onKeyDown} className={className} placeholder={placeholder} disabled={disabled} autoComplete="off" />;
        };

        const GlobalMapView = ({ routes, baseAddress, enableDrawing = false, onStopsSelected = null }) => {
            const mapRef = useRef(null);
            const googleMapRef = useRef(null);
            const markersRef = useRef([]); 
            const renderersRef = useRef([]); 
            const infoWindowRef = useRef(null); 
            const geocoderRef = useRef(null);
            const drawingManagerRef = useRef(null);
            
            useEffect(() => {
                if (!window.google || !googleMapRef.current) return;
                
                if (enableDrawing) {
                    if (!drawingManagerRef.current) {
                        try {
                            drawingManagerRef.current = new window.google.maps.drawing.DrawingManager({
                                drawingMode: null, 
                                drawingControl: true,
                                drawingControlOptions: {
                                    position: window.google.maps.ControlPosition.TOP_CENTER,
                                    drawingModes: [
                                        window.google.maps.drawing.OverlayType.RECTANGLE,
                                        window.google.maps.drawing.OverlayType.POLYGON 
                                    ],
                                },
                                rectangleOptions: {
                                    fillColor: '#1b6e9b',
                                    fillOpacity: 0.2,
                                    strokeWeight: 1,
                                    clickable: false,
                                    editable: true,
                                    zIndex: 1,
                                },
                                polygonOptions: {
                                    fillColor: '#1b6e9b',
                                    fillOpacity: 0.2,
                                    strokeWeight: 1,
                                    clickable: false,
                                    editable: true,
                                    zIndex: 1,
                                }
                            });
                            
                            drawingManagerRef.current.setMap(googleMapRef.current);

                            window.google.maps.event.addListener(drawingManagerRef.current, 'overlaycomplete', function(event) {
                                if (event.type === 'rectangle' || event.type === 'polygon') {
                                    const shape = event.overlay;
                                    const selected = [];
                                    
                                    markersRef.current.forEach(marker => {
                                        let isInside = false;
                                        if (event.type === 'rectangle') {
                                            if (shape.getBounds().contains(marker.getPosition())) isInside = true;
                                        } else if (event.type === 'polygon') {
                                            if (window.google.maps.geometry && window.google.maps.geometry.poly) {
                                                if (window.google.maps.geometry.poly.containsLocation(marker.getPosition(), shape)) isInside = true;
                                            }
                                        }

                                        if (isInside && marker.customInfo && marker.customInfo.originalIndex !== undefined) {
                                            selected.push(marker.customInfo.originalIndex);
                                        }
                                    });
                                    
                                    if (onStopsSelected) {
                                        onStopsSelected(selected.sort((a,b) => a - b));
                                    }
                                    
                                    setTimeout(() => shape.setMap(null), 600);
                                }
                            });
                        } catch(e) { console.error(e); }
                    } else {
                        drawingManagerRef.current.setMap(googleMapRef.current);
                    }
                } else {
                    if (drawingManagerRef.current) drawingManagerRef.current.setMap(null);
                }
            }, [enableDrawing]);

            useEffect(() => {
                if (!window.google || !mapRef.current) return;

                if (!googleMapRef.current) {
                    googleMapRef.current = new window.google.maps.Map(mapRef.current, { 
                        zoom: 10, center: { lat: 28.5383, lng: -81.3792 }, 
                        mapTypeControl: false, streetViewControl: false,
                        fullscreenControl: false, gestureHandling: 'greedy'
                    });
                    infoWindowRef.current = new window.google.maps.InfoWindow();
                    geocoderRef.current = new window.google.maps.Geocoder();
                }
                const map = googleMapRef.current;
                const directionsService = new window.google.maps.DirectionsService();
                const bounds = new window.google.maps.LatLngBounds();

                // Clear previous
                markersRef.current.forEach(m => m.setMap(null));
                markersRef.current = [];
                renderersRef.current.forEach(r => r.setMap(null));
                renderersRef.current = [];

                const getPinIcon = (color, text) => ({
                    path: "M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z",
                    fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1.1,
                    labelOrigin: new window.google.maps.Point(0, -30)
                });

                const addMarker = (location, title, label, color, content, originalIndex) => {
                    const marker = new window.google.maps.Marker({
                        position: location, map: map,
                        label: { text: label, color: "white", fontWeight: "bold", fontSize: "11px" },
                        icon: getPinIcon(color), title: title,
                        zIndex: 100
                    });
                    marker.customInfo = { originalIndex: originalIndex };
                    marker.addListener("click", () => { 
                        infoWindowRef.current.setContent(content); 
                        infoWindowRef.current.open(map, marker); 
                    });
                    markersRef.current.push(marker);
                    bounds.extend(location);
                    map.fitBounds(bounds);
                };

                const parseCoord = (coordData) => {
                    if (!coordData) return null;
                    if (typeof coordData === 'string') {
                        const [lat, lng] = coordData.split(',').map(Number);
                        if (!isNaN(lat) && !isNaN(lng)) return { lat, lng };
                    } else if (typeof coordData === 'object' && coordData.lat) {
                        return coordData;
                    }
                    return null;
                };

                // Base Warehouse Marker
                if (baseAddress) {
                      geocoderRef.current.geocode({ address: baseAddress }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const baseLoc = results[0].geometry.location;
                            new window.google.maps.Marker({
                                position: baseLoc, map: map,
                                icon: { path: window.google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: "#000", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" },
                                title: "Warehouse", zIndex: 999
                            });
                            bounds.extend(baseLoc);
                            map.fitBounds(bounds);
                        }
                     });
                }

                // Render Stops
                const routeEntries = Object.entries(routes);
                
                routeEntries.forEach(([groupName, routeData], index) => {
                    if (!routeData || !routeData.paradas) return;
                    
                    let color = routeData.color || '#334155'; // Default dark slate
                    const isOptimized = !!routeData.duracion_estimada;

                    // If optimized route, draw the line
                    if (isOptimized && routeData.paradas.length > 0) {
                        const waypoints = routeData.paradas.map(stop => ({ location: stop.direccion, stopover: true }));
                        if (waypoints.length <= 25) {
                            directionsService.route({ 
                                origin: baseAddress, destination: baseAddress, waypoints: waypoints, 
                                optimizeWaypoints: false, travelMode: window.google.maps.TravelMode.DRIVING 
                            }, (response, status) => {
                                if (status === 'OK') {
                                    const renderer = new window.google.maps.DirectionsRenderer({ 
                                        map: map, directions: response, 
                                        polylineOptions: { strokeColor: color, strokeOpacity: 0.7, strokeWeight: 5 }, 
                                        suppressMarkers: true, preserveViewport: true 
                                    });
                                    renderersRef.current.push(renderer);
                                    
                                    // Add numbered markers for optimized route
                                    const legs = response.routes[0].legs;
                                    routeData.paradas.forEach((stop, i) => {
                                        if (i < legs.length) {
                                            const content = `<div style="font-family:sans-serif; padding:5px;"><strong>${i+1}. ${stop.nombre}</strong><br><span style="color:#666">${stop.direccion}</span></div>`;
                                            addMarker(legs[i].end_location, stop.nombre, (i+1).toString(), color, content, null);
                                        }
                                    });
                                }
                            });
                        }
                    } else {
                        // Just dots for planning phase
                        routeData.paradas.forEach((stop, i) => {
                            if (!stop.direccion) return;
                            const pos = parseCoord(stop.coord || stop.latlng);
                            const label = (stop.originalIndex || i + 1).toString();
                            const content = `<div style="font-family:sans-serif; padding:5px;"><strong>${label}. ${stop.nombre}</strong><br><span style="color:#666">${stop.direccion}</span><br><span style="color:${color}; font-weight:bold;">${groupName}</span></div>`;

                            if (pos) {
                                addMarker(pos, stop.nombre, label, color, content, stop.originalIndex);
                            } else {
                                geocoderRef.current.geocode({ address: stop.direccion }, (results, status) => {
                                    if (status === 'OK' && results[0]) {
                                        addMarker(results[0].geometry.location, stop.nombre, label, color, content, stop.originalIndex);
                                    }
                                });
                            }
                        });
                    }
                });

            }, [routes, baseAddress]);
            
            return <div className="w-full h-full rounded-xl" ref={mapRef}></div>;
        };

        const PrintableSheet = ({ routeData, driverName, vehicle, phone, config, duration, zoneName }) => {
            const today = new Date();
            const hours = Math.floor((duration || 0) / 60);
            const minutes = Math.round((duration || 0) % 60);

            return (
                <div id="printable-sheet" className="hidden print:block bg-white text-black p-4 font-sans text-sm">
                    <div className="flex justify-between items-start mb-6 border-b-2 border-black pb-4">
                        <div className="flex items-center gap-4">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-12 w-auto" />
                            <div>
                                <h1 className="text-xl font-bold uppercase tracking-wide">Route Manifest</h1>
                                <p className="font-bold text-md">{today.toLocaleDateString()}</p>
                                <p className="font-bold text-lg uppercase mt-1 bg-black text-white inline-block px-2 rounded-sm">{zoneName}</p>
                            </div>
                        </div>
                        <div className="text-right space-y-1">
                            <div className="text-base"><span className="font-bold">Driver:</span> {driverName}</div>
                            <div className="text-base"><span className="font-bold">Truck:</span> {vehicle || "_______"}</div>
                            <div className="text-base"><span className="font-bold">Phone:</span> {phone || "_______"}</div>
                            <div className="text-base"><span className="font-bold">Est. Time:</span> {hours}h {minutes}m</div>
                        </div>
                    </div>
                    <table className="w-full border-collapse border border-black mb-4">
                        <thead>
                            <tr className="bg-white">
                                <th className="border border-black p-1 w-8 text-center text-xs">#</th>
                                <th className="border border-black p-2 text-left w-auto">Customer / Address</th>
                                <th className="border border-black p-2 w-20 text-center text-xs">Invoices</th>
                                <th className="border border-black p-2 w-10 text-center text-xs">Pcs</th>
                                <th className="border border-black p-2 w-32 text-left text-xs">Print Name</th>
                                <th className="border border-black p-2 w-16 text-left text-xs">TIME</th>
                            </tr>
                        </thead>
                        <tbody>
                            {routeData.map((stop, index) => (
                                <tr key={index} className="h-14">
                                    <td className="border border-black p-1 text-center font-bold">{index + 1}</td>
                                    <td className="border border-black p-2 align-top">
                                        <div className="font-bold text-sm truncate">{stop.nombre}</div>
                                        <div className="text-[10px] text-gray-600 leading-tight">{stop.direccion}</div>
                                    </td>
                                    <td className="border border-black p-1 text-center font-mono font-bold text-sm align-middle">{stop.invoices || '-'}</td>
                                    <td className="border border-black p-1 text-center font-bold text-sm align-middle">{stop.pieces || '-'}</td>
                                    <td className="border border-black p-1"></td>
                                    <td className="border border-black p-1"></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [dbReady, setDbReady] = useState(false);
            const [clientDB, setClientDB] = useState([]);
            const [drivers, setDrivers] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [googleApiKey, setGoogleApiKey] = useState(null);
            const [scriptLoaded, setScriptLoaded] = useState(false);
            
            // STATES DE LA APP UNIFICADA
            const [view, setView] = useState('planning'); // 'planning', 'results', 'clients', 'vehicles', 'settings'
            const [currentStops, setCurrentStops] = useState([]);
            const [stopGroups, setStopGroups] = useState([]); // {id, name, stops: [indices], color}
            
            // INPUTS
            const [newStopName, setNewStopName] = useState('');
            const [newStopAddress, setNewStopAddress] = useState('');
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // MODALS & HELPERS
            const [showZoneModal, setShowZoneModal] = useState(false);
            const [tempZoneSelection, setTempZoneSelection] = useState([]);
            const [zoneNameInput, setZoneNameInput] = useState('');
            
            // RESULTS STATE
            const [optimizedRoutes, setOptimizedRoutes] = useState(null); // { "Zone A": {paradas:[], duration...} }
            const [driverAssignments, setDriverAssignments] = useState({}); // { "Zone A": driverId }
            const [printData, setPrintData] = useState(null);

            const inputRef = useRef(null);

            // INITIALIZATION
            useEffect(() => {
                fetch('/config').then(r => r.json()).then(data => {
                    if (data.firebaseConfig && window.initializeFirebaseGlobally(data.firebaseConfig)) setDbReady(true);
                    setGoogleApiKey(data.googleApiKey);
                });
                
                const initAuth = setInterval(() => {
                    if (window.fbOnAuthStateChanged && window.fbAuth) {
                        window.fbOnAuthStateChanged(window.fbAuth, u => setUser(u));
                        clearInterval(initAuth);
                    }
                }, 500);
            }, []);

            useEffect(() => {
                if (!googleApiKey) return;
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places,drawing,geometry&loading=async`;
                script.async = true; script.defer = true;
                script.onload = () => setScriptLoaded(true);
                document.head.appendChild(script);
            }, [googleApiKey]);

            // DATA SYNC
            useEffect(() => {
                if (!user || !window.fbDb) return;
                const uid = user.uid;
                const appId = 'default-app-id';
                const userRef = (c) => window.fbCollection(window.fbDb, 'artifacts', appId, 'users', uid, c);
                
                window.fbOnSnapshot(window.fbQuery(userRef('clients')), s => setClientDB(s.docs.map(d => ({id: d.id, ...d.data()}))));
                window.fbOnSnapshot(window.fbQuery(userRef('drivers')), s => setDrivers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                window.fbOnSnapshot(window.fbQuery(userRef('vehicles')), s => setVehicles(s.docs.map(d => ({id: d.id, ...d.data()}))));
                window.fbOnSnapshot(window.fbQuery(userRef('draft_stops'), window.fbOrderBy('createdAt')), s => setCurrentStops(s.docs.map(d => ({id: d.id, ...d.data()}))));
            }, [user, dbReady]);

            // --- LOGIC ---

            const handleAddStop = async () => {
                if (!newStopAddress.trim()) return;
                const name = newStopName.trim() || "Client";
                await window.fbAddDoc(window.fbCollection(window.fbDb, 'artifacts', 'default-app-id', 'users', user.uid, 'draft_stops'), {
                    name, address: newStopAddress, createdAt: Date.now()
                });
                setNewStopName(''); setNewStopAddress('');
                if(inputRef.current) inputRef.current.focus();
            };

            const handleMapSelection = (indices) => {
                setTempZoneSelection(indices);
                setZoneNameInput('');
                setShowZoneModal(true);
            };

            const confirmCreateZone = () => {
                if (!zoneNameInput.trim()) return;
                const color = ZONE_COLORS[stopGroups.length % ZONE_COLORS.length].hex;
                const newGroup = {
                    id: Date.now(),
                    name: zoneNameInput.toUpperCase(),
                    stops: tempZoneSelection,
                    color: color
                };
                setStopGroups([...stopGroups, newGroup]);
                setShowZoneModal(false);
            };

            const clearZone = (id) => setStopGroups(stopGroups.filter(g => g.id !== id));

            // MAP DATA CONSTRUCTION FOR PLANNING VIEW
            const planningMapRoutes = useMemo(() => {
                const mapData = {};
                const groupedIndices = new Set();

                // Add Created Zones
                stopGroups.forEach(g => {
                    const stops = g.stops.map(i => {
                        groupedIndices.add(i);
                        return { ...currentStops[i], originalIndex: i + 1 };
                    }).filter(s => s); // Filter undefined if list changed
                    
                    if (stops.length > 0) {
                        mapData[g.name] = { paradas: stops, color: g.color };
                    }
                });

                // Add Ungrouped Stops (Black)
                const ungrouped = currentStops.map((s, i) => ({...s, originalIndex: i + 1})).filter((_, i) => !groupedIndices.has(i));
                if (ungrouped.length > 0) {
                    mapData['Ungrouped'] = { paradas: ungrouped, color: '#000000' };
                }

                return mapData;
            }, [currentStops, stopGroups]);

            const generateRoutes = async () => {
                if (stopGroups.length === 0 && currentStops.length === 0) return;
                setLoading(true); setError('');

                try {
                    // Prepare tasks based on ZONES
                    const tasks = [];
                    
                    // 1. Process Created Zones
                    stopGroups.forEach(g => {
                        const stops = g.stops.map(i => currentStops[i]);
                        if (stops.length > 0) {
                            tasks.push({
                                zoneName: g.name,
                                color: g.color,
                                body: {
                                    direcciones: stops,
                                    num_vans: 1, // 1 Van per zone default
                                    base_address: "8350 Parkline Blvd, Orlando, FL 32809",
                                    dwell_time: 6
                                }
                            });
                        }
                    });

                    // 2. Process Ungrouped (if any) as "Unassigned Zone"
                    const groupedIndices = new Set(stopGroups.flatMap(g => g.stops));
                    const ungroupedStops = currentStops.filter((_, i) => !groupedIndices.has(i));
                    
                    if (ungroupedStops.length > 0) {
                        tasks.push({
                            zoneName: "UNASSIGNED",
                            color: "#000000",
                            body: {
                                direcciones: ungroupedStops,
                                num_vans: 1,
                                base_address: "8350 Parkline Blvd, Orlando, FL 32809",
                                dwell_time: 6
                            }
                        });
                    }

                    // 3. Call API for each task
                    const results = {};
                    await Promise.all(tasks.map(async (task) => {
                        const res = await fetch('/optimizar', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(task.body)
                        });
                        const data = await res.json();
                        // The backend returns keys like "Van 1". Map this to our Zone Name.
                        // Since we sent 1 van, we take the first result.
                        const firstKey = Object.keys(data)[0];
                        if (firstKey) {
                            results[task.zoneName] = { 
                                ...data[firstKey], 
                                color: task.color 
                            };
                        }
                    }));

                    setOptimizedRoutes(results);
                    setView('results');

                } catch (e) {
                    setError("Error generating routes: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const assignDriver = (zoneName, driverId) => {
                setDriverAssignments(prev => ({ ...prev, [zoneName]: driverId }));
            };

            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 pb-20">
                    {/* MODAL CREAR ZONA */}
                    {showZoneModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                                <h3 className="text-xl font-bold mb-4">Create Zone</h3>
                                <p className="text-sm text-slate-500 mb-4">{tempZoneSelection.length} stops selected.</p>
                                <input 
                                    autoFocus
                                    type="text" 
                                    className="w-full p-3 border rounded-lg text-lg font-bold uppercase mb-4 focus:ring-2 focus:ring-ess-blue outline-none" 
                                    placeholder="Zone Name (e.g. NORTH)" 
                                    value={zoneNameInput}
                                    onChange={e => setZoneNameInput(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && confirmCreateZone()}
                                />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowZoneModal(false)} className="flex-1 py-3 text-slate-500 font-bold">Cancel</button>
                                    <button onClick={confirmCreateZone} className="flex-1 py-3 bg-ess-blue text-white rounded-lg font-bold">Create</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <div className="bg-white border-b border-slate-200 sticky top-0 z-40 px-6 py-3 flex justify-between items-center no-print">
                        <div className="flex items-center gap-3">
                            <img src="https://economysignsupply.com/wp-content/uploads/2024/07/ess-logo-svg-100.svg" alt="ESS" className="h-10" />
                            <h1 className="font-bold text-slate-700 hidden sm:block">Route Planner</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            {view === 'results' && (
                                <button onClick={() => setView('planning')} className="px-4 py-2 border rounded-lg font-bold hover:bg-slate-50 text-sm flex items-center gap-2">
                                    <Icon name="arrow-left" className="h-4 w-4" /> Edit Zones
                                </button>
                            )}
                            {view === 'planning' && stopGroups.length > 0 && (
                                <button onClick={generateRoutes} disabled={loading} className="px-6 py-2 bg-slate-800 text-white rounded-lg font-bold text-sm shadow-lg hover:bg-black flex items-center gap-2">
                                    {loading ? <div className="loader w-4 h-4 border-white"></div> : <><Icon name="play" className="h-4 w-4" /> GENERATE ROUTES</>}
                                </button>
                            )}
                            <button onClick={() => window.location.reload()} className="text-red-500 font-bold text-xs hover:bg-red-50 px-2 py-1 rounded">Logout</button>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-4 space-y-4">
                        
                        {/* VISTA DE PLANIFICACIÓN (ADD STOPS + MAPA) */}
                        {view === 'planning' && (
                            <div className="animate-fade-in space-y-4">
                                
                                {/* 1. ADD STOP CARD (Image 1 Style) */}
                                <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                                        <div className="bg-green-100 p-1.5 rounded-full text-green-700"><Icon name="plus" className="h-5 w-5" /></div>
                                        Add Stop
                                    </h2>
                                    <div className="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Client</label>
                                            <input 
                                                ref={inputRef}
                                                type="text" 
                                                className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-ess-blue" 
                                                placeholder="Name" 
                                                value={newStopName} 
                                                onChange={e => {
                                                    setNewStopName(e.target.value);
                                                    setShowSuggestions(true);
                                                }}
                                                onKeyDown={e => e.key === 'Enter' && document.getElementById('addr-input').focus()}
                                            />
                                            {showSuggestions && newStopName && (
                                                <div className="absolute bg-white border shadow-xl z-50 rounded-lg mt-1 w-64">
                                                    {clientDB.filter(c=>c.name.toLowerCase().includes(newStopName.toLowerCase())).slice(0,5).map(c => (
                                                        <div key={c.id} onClick={()=>{setNewStopName(c.name); setNewStopAddress(c.address); setShowSuggestions(false);}} className="p-3 hover:bg-blue-50 cursor-pointer border-b text-sm">
                                                            <div className="font-bold">{c.name}</div>
                                                            <div className="text-xs text-gray-500">{c.address}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Address</label>
                                            <div className="flex gap-2">
                                                <div className="flex-1">
                                                    <GoogleAddressInput 
                                                        inputRef={{current: document.getElementById('addr-input')}} // Fake ref passing 
                                                        value={newStopAddress} 
                                                        onChange={e => setNewStopAddress(e.target.value)} 
                                                        onKeyDown={e => e.key === 'Enter' && handleAddStop()}
                                                        className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-ess-blue"
                                                        placeholder="Search Google Maps"
                                                        disabled={!scriptLoaded}
                                                        isLoaded={scriptLoaded}
                                                    />
                                                    <input id="addr-input" className="hidden" /> {/* Dummy to capture ref logic if needed */}
                                                </div>
                                                <button onClick={handleAddStop} className="px-6 bg-ess-blue text-white font-bold rounded-lg hover:bg-sky-700 shadow-md flex items-center gap-2">
                                                    Next <Icon name="arrow-right" className="h-4 w-4" />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 2. LARGE MAP & ZONES (Image 2 Style) */}
                                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden h-[600px] relative flex flex-col">
                                    <div className="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur p-2 rounded-lg shadow-lg border border-slate-200 max-w-xs">
                                        <h3 className="font-bold text-xs uppercase text-slate-500 mb-2">Zones Created:</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {stopGroups.map(g => (
                                                <div key={g.id} className="flex items-center gap-2 px-2 py-1 rounded text-xs font-bold text-white shadow-sm" style={{backgroundColor: g.color}}>
                                                    {g.name}
                                                    <button onClick={() => clearZone(g.id)} className="hover:text-black"><Icon name="x" className="h-3 w-3" /></button>
                                                </div>
                                            ))}
                                            {stopGroups.length === 0 && <span className="text-xs text-slate-400 italic">Draw on map to create zones.</span>}
                                        </div>
                                    </div>
                                    <div className="flex-1">
                                        <GlobalMapView 
                                            routes={planningMapRoutes} 
                                            baseAddress="8350 Parkline Blvd, Orlando, FL 32809" 
                                            enableDrawing={true}
                                            onStopsSelected={handleMapSelection}
                                        />
                                    </div>
                                </div>

                                {/* 3. COMPACT STOP LIST (Reference) */}
                                <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                                    <h3 className="font-bold text-sm text-slate-500 uppercase mb-3 flex items-center gap-2"><Icon name="list" className="h-4 w-4" /> Reference List</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-8 gap-y-2">
                                        {currentStops.map((stop, idx) => (
                                            <div key={stop.id} className="text-xs flex items-start gap-2 border-b border-slate-50 pb-1">
                                                <span className="font-bold text-slate-400 w-5">{idx + 1}.</span>
                                                <div className="truncate">
                                                    <span className="font-bold text-slate-700">{stop.name}</span>
                                                    <span className="block text-[10px] text-slate-400 truncate">{stop.address}</span>
                                                </div>
                                            </div>
                                        ))}
                                        {currentStops.length === 0 && <span className="text-xs text-slate-400 italic">No stops added yet.</span>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VISTA DE RESULTADOS (Asignación de Drivers) */}
                        {view === 'results' && optimizedRoutes && (
                            <div className="animate-fade-in space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {Object.entries(optimizedRoutes).map(([zoneName, routeData]) => {
                                        const assignedDriverId = driverAssignments[zoneName];
                                        const driver = drivers.find(d => d.id === assignedDriverId);
                                        const vehicle = vehicles.find(v => v.assignedDriver === driver?.name);

                                        return (
                                            <div key={zoneName} className="bg-white rounded-xl border-t-4 shadow-md overflow-hidden" style={{borderColor: routeData.color}}>
                                                <div className="p-4 bg-slate-50 border-b border-slate-200">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <h2 className="font-bold text-lg text-slate-800 uppercase">{zoneName}</h2>
                                                        <span className="text-xs font-bold bg-white border px-2 py-1 rounded">{routeData.paradas.length} Stops</span>
                                                    </div>
                                                    
                                                    {/* DRIVER SELECTION DROPDOWN */}
                                                    <div className="relative">
                                                        <select 
                                                            className={`w-full p-3 rounded-lg border-2 font-bold text-sm outline-none appearance-none cursor-pointer ${assignedDriverId ? 'border-ess-green bg-green-50 text-green-800' : 'border-slate-300 bg-white text-slate-500'}`}
                                                            value={assignedDriverId || ""}
                                                            onChange={(e) => assignDriver(zoneName, e.target.value)}
                                                        >
                                                            <option value="">-- Assign Driver --</option>
                                                            {drivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                                        </select>
                                                        <div className="absolute right-3 top-3.5 pointer-events-none">
                                                            <Icon name="chevron-down" className="h-4 w-4 text-slate-400" />
                                                        </div>
                                                    </div>

                                                    {driver && (
                                                        <div className="mt-3 text-xs text-slate-600 space-y-1 pl-1">
                                                            <div className="flex gap-2"><Icon name="truck" className="h-3 w-3" /> {vehicle ? vehicle.name : 'No Truck'}</div>
                                                            <div className="flex gap-2"><Icon name="phone" className="h-3 w-3" /> {driver.phone || 'No Phone'}</div>
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="max-h-64 overflow-y-auto p-0">
                                                    {routeData.paradas.map((stop, i) => (
                                                        <div key={i} className="flex gap-3 p-3 border-b border-slate-100 text-sm hover:bg-slate-50">
                                                            <span className="font-bold text-slate-400 text-xs mt-0.5">{i+1}</span>
                                                            <div className="leading-tight">
                                                                <div className="font-bold text-slate-700">{stop.nombre}</div>
                                                                <div className="text-xs text-slate-500">{stop.direccion}</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                <div className="p-4 bg-slate-50 border-t border-slate-200 flex gap-2">
                                                    <a href={routeData.link} target="_blank" className="flex-1 bg-white border border-slate-300 hover:border-ess-blue hover:text-ess-blue text-slate-600 font-bold py-2 rounded-lg text-center text-xs flex justify-center items-center gap-2">
                                                        <Icon name="send" className="h-3 w-3" /> App
                                                    </a>
                                                    <button 
                                                        onClick={() => {
                                                            setPrintData({ 
                                                                stops: routeData.paradas, 
                                                                driverName: driver ? driver.name : "Unassigned",
                                                                vehicle: vehicle ? vehicle.name : "",
                                                                phone: driver ? driver.phone : "",
                                                                duration: routeData.duracion_estimada,
                                                                zoneName: zoneName
                                                            });
                                                            setTimeout(() => window.print(), 100);
                                                        }}
                                                        className="flex-1 bg-slate-800 text-white hover:bg-black font-bold py-2 rounded-lg text-center text-xs flex justify-center items-center gap-2"
                                                    >
                                                        <Icon name="printer" className="h-3 w-3" /> Print
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {printData && (
                            <PrintableSheet 
                                routeData={printData.stops}
                                driverName={printData.driverName}
                                vehicle={printData.vehicle}
                                phone={printData.phone}
                                duration={printData.duration}
                                zoneName={printData.zoneName}
                                config={{
                                    companyName: "ECONOMY SIGN SUPPLY",
                                    phone: "407-901-0900",
                                    address: "8350 PARKLINE BLVD, ORLANDO, FL"
                                }}
                            />
                        )}

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
